<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Wendi's Blog]]></title>
  <link href="http://blog.ifyouseewendy.com/atom.xml" rel="self"/>
  <link href="http://blog.ifyouseewendy.com/"/>
  <updated>2014-10-13T23:23:56+08:00</updated>
  <id>http://blog.ifyouseewendy.com/</id>
  <author>
    <name><![CDATA[wendi]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Things I Learn from Owning Rails Class]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/09/29/things-i-learnt-from-owning-rails-class/"/>
    <updated>2014-09-29T18:36:28+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/09/29/things-i-learnt-from-owning-rails-class</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Teacher</strong></td>
      <td><a href="http://macournoyer.com/">Marc-André Cournoy</a></td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://owningrails.com/">Owning Rails</a></td>
    </tr>
  </tbody>
</table>

<p>I’ve participated Marc’s Owning Rails online class recently. AWESOME!</p>

<p>The class has two parts. Marc led us to build a minimal version of Rails on first day, Marc focused on the structure and design pattern behind Rails. Trully I think it’s a live version of <a href="http://blog.ifyouseewendy.com/blog/2014/09/27/rebuilding-rails/">Rebuilding Rails</a>, maybe you can read it as a substitution. Second day is the excellent part, took us diving into the real Rails source. Marc gave us a clear clue on what each part do and how they work, and also some practical introductions on how and where to keep on digging after class. </p>

<p>Beside professional, I should also mention that Marc is a really kind and patient guy.</p>

<p>Thanks a lot, Marc.</p>

<hr />

<p>Following are some specific questions I’ve noted on class.</p>

<p><strong><em>Is <code>yield</code> still available after passing <code>&amp;block</code>?</em></strong></p>

<p>yes.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line"><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="nb">p</span> <span class="n">block</span>
</span><span class="line"><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="k">yield</span>
</span><span class="line"><span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span> <span class="k">end</span>
</span><span class="line"><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span> <span class="p">}</span>
</span><span class="line"><span class="c1">#&lt;Proc:0x000001053e7f28@(pry):6&gt;</span>
</span><span class="line"><span class="n">foo</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class="line"><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line"><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="n">block</span><span class="o">.</span><span class="n">call</span>
</span><span class="line"><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span>   <span class="k">yield</span>
</span><span class="line"><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">*</span> <span class="k">end</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class="line"><span class="o">[</span><span class="mi">6</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">bar</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s1">&#39;bar&#39;</span> <span class="p">}</span>
</span><span class="line"><span class="n">bar</span>
</span><span class="line"><span class="n">bar</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">nil</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Passing block directly will omit the block-to-proc process, it can be more efficient.</p>

<p><strong><em>How to make bindings of block get understood in object, which differs the environment the block defines?</em></strong></p>

<blockquote>
  <p>When you define the block, it simply grabs the bindings that are there at that moment, and then it carries those bindings along when you pass the block into a method. </p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">=</span><span class="k">class</span> <span class="nc">Router</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@routes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;#match from Router instance&#39;</span>
</span><span class="line">    <span class="vi">@routes</span><span class="o">.</span><span class="n">update</span> <span class="n">route</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="o">=</span>  <span class="k">def</span> <span class="nf">routes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">    <span class="k">yield</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span class="line">  <span class="nb">puts</span> <span class="s1">&#39;#match from main object&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">Router</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">routes</span> <span class="k">do</span>
</span><span class="line">  <span class="n">match</span> <span class="s1">&#39;/user&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;users#index&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># =&gt; #match in main object</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Use <code>instance_eval</code> to eval the new bindings.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">route</span><span class="p">)</span>
</span><span class="line">  <span class="nb">puts</span> <span class="s1">&#39;#match in main object&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Router</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">routes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">    <span class="nb">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">Router</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">routes</span> <span class="k">do</span>
</span><span class="line">  <span class="n">match</span> <span class="s1">&#39;/user&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;users#index&#39;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># =&gt; match from Router instance</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>Why using <code>::File</code> in <code>config.ru</code>?</em></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># config.ru</span>
</span><span class="line">
</span><span class="line"><span class="nb">require</span> <span class="o">::</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">&#39;../config/environment&#39;</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>
</span><span class="line"><span class="n">run</span> <span class="no">Rails</span><span class="o">.</span><span class="n">application</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Actually the code above is defined in module Rack, where <code>Rack::File</code> already exists.</p>

<p><strong><em>How to use <code>include</code> to construct a method chain?</em></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">A</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;foo from A&#39;</span>
</span><span class="line">    <span class="k">super</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">B</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;foo from B&#39;</span>
</span><span class="line">    <span class="k">super</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Base</span>
</span><span class="line">  <span class="kp">include</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;foo from Base&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">Base</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span>
</span><span class="line"><span class="c1"># =&gt; foo from Base</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One way to solve is to use <code>prepend</code> instead of <code>include</code>, introduced by Ruby 2.0.</p>

<p>Considering the compatibility, Rails may not start to use it. Here is the Rails way to solve</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">A</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;foo from A&#39;</span>
</span><span class="line">    <span class="k">super</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">B</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;foo from B&#39;</span>
</span><span class="line">    <span class="k">super</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Metal</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;foo from Base&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Base</span>
</span><span class="line">  <span class="kp">include</span> <span class="n">A</span><span class="p">,</span> <span class="n">B</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">Base</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span>
</span><span class="line"><span class="c1"># =&gt; foo from A</span>
</span><span class="line"><span class="c1"># =&gt; foo from B</span>
</span><span class="line"><span class="c1"># =&gt; foo from Base</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>How instance variables shared betweet controller and view?</em></strong></p>

<p>One way is to use <code>instance_varialbles</code> and <code>instance_variable_set/get</code>, to passing instance varaibles defined in action to the view object.</p>

<p>The other way is passing <code>binding</code> directly.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">template</span> <span class="o">=</span> <span class="no">ERB</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="p">)</span>
</span><span class="line"><span class="n">template</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="nb">binding</span><span class="p">)</span>
</span><span class="line"><span class="c1"># eval(template.src, binding)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>Truth about binding</em></strong></p>

<ol>
  <li>
    <p><code>Binding.new</code> doesn’t work, you can only call <code>Kernel.binding</code> or <code>Proc#binding</code>.</p>
  </li>
  <li>
    <p>You can only use <code>binding</code> with <code>eval</code>. <code>eval('', binding)</code> or <code>binding.eval('')</code></p>
  </li>
</ol>

<p><strong><em>When we create custom middleware is it a good practise to add new keys and values to env variable to transfer it between middlewares?</em></strong></p>

<blockquote>
  <p>[02:35] &lt;wawka&gt; macournoyer: When we create custom middleware is it a good practise to add new keys and values to env variable to transfer it between middlewares ?<br />
[02:36] &lt;macournoyer&gt;  Rack specs recommend namespacing everything you put in the env var<br />
[02:36] &lt;macournoyer&gt; eg.: Rails will do env[“action_controller.request_id”] = “…” <br />
[02:36] &lt;macournoyer&gt; “action_controller.” is the namespace<br />
[02:36] &lt;wawka&gt; macournoyer: ok</p>
</blockquote>

<p><strong><em>How to check a gem’s dependency and dive into the source code?</em></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>gem dep rails -v<span class="o">=</span>4.1.6
</span><span class="line">Gem rails-4.1.6
</span><span class="line">  actionmailer <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  actionpack <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  actionview <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  activemodel <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  activerecord <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  activesupport <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  bundler <span class="o">(</span>&lt; 2.0, &gt;<span class="o">=</span> 1.3.0<span class="o">)</span>
</span><span class="line">  railties <span class="o">(=</span> 4.1.6<span class="o">)</span>
</span><span class="line">  sprockets-rails <span class="o">(</span>~&gt; 2.0<span class="o">)</span>
</span><span class="line">
</span><span class="line"><span class="nv">$ </span>bundle open activerecord
</span><span class="line">
</span><span class="line"><span class="c"># open the latest version on system, a little bit dangerous </span>
</span><span class="line"><span class="nv">$ </span>gem edit activerecord
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>How to get the source location of the method calling?</em></strong></p>

<p>In Rails, <em>guess</em> the logic part(activerecord, activesupport..) based on the method function, then use <code>bundle open</code> to dive in.</p>

<p>Ruby supports <code>Method#source_location</code>, <code>Proc#source_location</code> to provides some information, not accurate though. Use it like this</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># chech where defined respond_with</span>
</span><span class="line"><span class="k">raise</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:respond_with</span><span class="p">)</span><span class="o">.</span><span class="n">source_location</span><span class="o">.</span><span class="n">inspect</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<hr />

<h3 id="other-stuffs">Other stuffs</h3>

<ol>
  <li>
    <p>Marc’s <a href="https://gist.github.com/macournoyer/1878273">gitconfig</a></p>
  </li>
  <li>
    <p>Don’t try to understand everything.</p>
  </li>
  <li>
    <p>Read concern, callbacks, core_ext and other ActiveSupport parts as a start.</p>
  </li>
  <li>
    <p>Nice word learnt, <strong>Base</strong>ics</p>
  </li>
  <li>
    <p>Try <code>mount</code> a rack-based app in Rails.</p>
  </li>
</ol>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review] Rebuilding Rails]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/09/27/rebuilding-rails/"/>
    <updated>2014-09-27T14:48:48+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/09/27/rebuilding-rails</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>Rebuilding Rails</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>Noah Gibbs</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://rebuilding-rails.com/">rebuilding-rails.com</a></td>
    </tr>
  </tbody>
</table>

<ul id="markdown-toc">
  <li><a href="#zero-to-it-works">1. Zero to “It Works!”</a></li>
  <li><a href="#your-first-controller">2. Your First Controller</a></li>
  <li><a href="#rails-automatic-loading">3. Rails Automatic Loading</a></li>
  <li><a href="#rendering-views">4. Rendering Views</a></li>
  <li><a href="#basic-models">5. Basic Models</a></li>
  <li><a href="#request-response">6. Request, Response</a></li>
  <li><a href="#the-littlest-orm">7. The Littlest ORM</a></li>
  <li><a href="#rack-middleware">8. Rack Middleware</a></li>
  <li><a href="#real-routing">9. Real Routing</a></li>
</ul>

<p>My re-building source code</p>

<ul>
  <li><a href="https://github.com/ifyouseewendy/rulers">rulers</a></li>
  <li><a href="https://github.com/ifyouseewendy/best_quotes">best_quotes</a></li>
</ul>

<p>Work flow diagram</p>

<p><img src="https://raw.githubusercontent.com/ifyouseewendy/best_quotes/master/rebuilding-rails.png" alt="img texrebuilding-rails" style="width:562px" /></p>

<h2 id="zero-to-it-works">1. Zero to “It Works!”</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">gem</span><span class="o">.</span><span class="n">add_development_dependency</span> <span class="s2">&quot;rspec&quot;</span>
</span><span class="line"><span class="n">gem</span><span class="o">.</span><span class="n">add_runtime_dependency</span> <span class="s2">&quot;rest-client&quot;</span>
</span><span class="line"><span class="n">gem</span><span class="o">.</span><span class="n">add_runtime_dependency</span> <span class="s2">&quot;some_gem&quot;</span><span class="p">,</span> <span class="s2">&quot;1.3.0&quot;</span>
</span><span class="line"><span class="n">gem</span><span class="o">.</span><span class="n">add_runtime_dependency</span> <span class="s2">&quot;other_gem&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;0.8.2&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Each of these adds a runtime dependency (needed to run the gem at all) or a development dependency (needed to develop or test the gem).</p>

<p>Youʼll need to go into the rulers directory and <code>git add .</code> before you rebuild the gem (<code>git add .; gem build rulers.gemspec; gem install rulers-0.0.1.gem</code>). Thatʼs because rulers.gemspec is actually calling git to find out what files to include in your gem.</p>

<p><strong>Rails structure</strong></p>

<ul>
  <li>
    <p><strong>ActiveSupport</strong> is a compatibility library including methods that aren’t necessarily specific to Rails. You’ll see ActiveSupport used by non-Rails libraries because it contains such a lot of useful baseline functionality. ActiveSupport includes methods like how Rails changes words from single to plural, or CamelCase to snake_case. It also includes significantly better time and date support than the Ruby standard library.</p>
  </li>
  <li>
    <p><strong>ActiveModel</strong> hooks into features of your models that aren’t really about the database - for instance, if you want a URL for a given model, ActiveModel helps you there. It’s a thin wrapper around many different ActiveModel implementations to tell Rails how to use them. Most commonly, ActiveModel implementations are ORMs (see ActiveRecord, below), but they can also use non-relational storage like MongoDB, Redis, Memcached or even just local machine memory.</p>
  </li>
  <li>
    <p><strong>ActiveRecord</strong> is an Object-Relational Mapper (ORM). That means that it maps between Ruby objects and tables in a SQL database. When you query from or write to the SQL database in Rails, you do it through ActiveRecord. ActiveRecord also implements ActiveModel. ActiveRecord supports MySQL and SQLite, plus JDBC, Oracle, PostgreSQL and many others.</p>
  </li>
  <li>
    <p><strong>ActionPack</strong> (<em>ActionDispatch, ActionController, Actionview</em>) does routing - the mapping of an incoming URL to a controller and action in Rails. It also sets up your controllers and views, and shepherds a request through its controller action and then through rendering the view. For some of it, ActionPack uses Rack. The template rendering itself is done through an external gem like Erubis for .erb templates, or Haml for .haml templates. ActionPack also handles action- or view-centered functionality like view caching.</p>
  </li>
  <li>
    <p><strong>ActionMailer</strong> is used to send out email, especially email based on templates. It works a lot like you’d hope Rails email would, with controllers, actions and “views” - which for email are text- based templates, not regular web-page templates.</p>
  </li>
</ul>

<h2 id="your-first-controller">2. Your First Controller</h2>

<p>Rails encapsulated the Rack information into a “request” object rather than just including the hash right into the controller. Thatʼs a good idea when you want to abstract it a bit – normalize values for certain variables, for instance, or read and set cookies to store session data.</p>

<h2 id="rails-automatic-loading">3. Rails Automatic Loading</h2>

<p>When debugging or printing error messages I like to use STDERR because itʼs a bit harder to redirect than a normal “puts” and so youʼre more likely to see it even when using a log file, background process or similar.</p>

<p>For simple structures, “inspect” shows them exactly as youʼd type them into Ruby – strings with quotes, numbers bare, symbols with a leading colon and so on.</p>

<p><strong>Reloading Means Convenience</strong></p>

<p><code>gem "rulers", :path =&gt; "../rulers"</code> This trick actually relies on deep Bundler trickery and requires you to always “bundle exec” before running things like rackup. If you forget that, it can look like the gem isnʼt there or (worse) look like an old version.</p>

<p><strong>CamelCase and snake_case</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/util.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Rulers</span>
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">to_underscore</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span class="line">    <span class="n">string</span><span class="o">.</span><span class="n">gsub</span><span class="p">(</span><span class="sr">/::/</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span>
</span><span class="line">    <span class="nb">gsub</span><span class="p">(</span><span class="sr">/([A-Z]+)([A-Z][a-z])/</span><span class="p">,</span><span class="s1">&#39;\1_\2&#39;</span><span class="p">)</span><span class="o">.</span>
</span><span class="line">    <span class="nb">gsub</span><span class="p">(</span><span class="sr">/([a-z\d])([A-Z])/</span><span class="p">,</span><span class="s1">&#39;\1_\2&#39;</span><span class="p">)</span><span class="o">.</span>
</span><span class="line">    <span class="n">tr</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span><span class="o">.</span>
</span><span class="line">    <span class="n">downcase</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># &#39;HTTPController&#39; -&gt; &#39;http_controller&#39;</span>
</span><span class="line"><span class="c1"># &#39;MD5Controller&#39; -&gt; &#39;md5_controller&#39;</span>
</span><span class="line"><span class="c1"># &#39;HomeController&#39; -&gt; &#39;home_controller&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Put it together</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/dependencies.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">Object</span>
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">const_missing</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class="line">    <span class="nb">require</span> <span class="no">Rulers</span><span class="o">.</span><span class="n">to_underscore</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class="line">    <span class="no">Object</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/controller.rb</span>
</span><span class="line"><span class="k">def</span> <span class="nf">controller_name</span>
</span><span class="line">  <span class="n">klass</span> <span class="o">=</span> <span class="nb">self</span><span class="o">.</span><span class="n">class</span>
</span><span class="line">  <span class="n">klass</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">gsub</span> <span class="sr">/Controller$/</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span class="line">  <span class="no">Rulers</span><span class="o">.</span><span class="n">to_underscore</span> <span class="n">klass</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Did it work?</strong></p>

<p>When you load a file called whatever_class.rb, youʼre not actually guaranteed that it contains WhateverClass, or that the constant WhateverClass is actually a class. How would you check?</p>

<p>You might try calling const_get(:WhateverClass)… Except that you just made const_get try to load automatically. If you call it on an unloaded class inside the method call where you try to load, youʼll recurse forever and get a “stack level too deep” and a crash. So const_get isnʼt the full answer.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/dependencies.rb</span>
</span><span class="line"><span class="k">class</span> <span class="nc">Object</span>
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">const_missing</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="kp">nil</span> <span class="k">if</span> <span class="vi">@calling_const_missing</span>
</span><span class="line">
</span><span class="line">    <span class="vi">@calling_const_missing</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line">    <span class="nb">require</span> <span class="no">Rulers</span><span class="o">.</span><span class="n">to_underscore</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class="line">    <span class="n">klass</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@calling_const_missing</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class="line">
</span><span class="line">    <span class="n">klass</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>But thereʼs a reason I say “hideously hacky.” Think about ways this could break. For instance – think about what would happen if you hit this in multiple threads at once. Oops!</p>

<p><strong>Re-re-reloading</strong></p>

<p><a href="https://github.com/alexch/rerun">rerun</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># best_quotes/Gemfile</span>
</span><span class="line"><span class="n">source</span> <span class="s1">&#39;https://rubygems.org&#39;</span>
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;rulers&#39;</span><span class="p">,</span> <span class="ss">:path</span> <span class="o">=&gt;</span> <span class="s2">&quot;../rulers&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>
</span><span class="line">  <span class="n">gem</span> <span class="s1">&#39;rerun&#39;</span>
</span><span class="line">  <span class="n">gem</span> <span class="s1">&#39;listen&#39;</span><span class="p">,</span> <span class="s1">&#39;=1.3.1&#39;</span> <span class="c1"># for older Ruby</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Running by <code>bundle exec rerun -- rackup -p 3001</code>. The “–” is an old Unix trick. It means “thatʼs all the arguments you get, the rest belong to somebody else.” Specifically, it tells rerun to ignore the “-p” later.</p>

<p><a href="https://github.com/rtomayko/shotgun">shotgun</a></p>

<p>reloading rack development server, forking version of rackup.</p>

<p><strong>In Rails</strong></p>

<ol>
  <li>
    <p><a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/dependencies.rb">rails/activesupport/lib/active_support/dependencies.rb</a> Rails uses ActiveSupport for its const_missing support. Most of the code is installing a const_missing that can call through to non-Rails versions of const_missing in other classes, and can be removed or re-added and is appropriately modular. It also works hard to support nested modules like MyLibrary::SubModule::SomeClass.</p>
  </li>
  <li>
    <p><a href="http://urbanautomaton.com/blog/2013/08/27/rails-autoloading-hell/#fn1">Rails autoloading — how it works, and when it doesn’t</a> by Simon Coffey.</p>
  </li>
</ol>

<h2 id="rendering-views">4. Rendering Views</h2>

<p><strong>Erb and Erubis</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># some_directory/erb_test.rb</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;erubis&quot;</span>
</span><span class="line">
</span><span class="line"><span class="n">template</span> <span class="o">=</span> <span class="o">&lt;&lt;</span><span class="no">TEMPLATE</span>
</span><span class="line"><span class="sh">Hello! This is a template.</span>
</span><span class="line"><span class="sh">It has &lt;%= whatever %&gt;.</span>
</span><span class="line"><span class="no">TEMPLATE</span>
</span><span class="line">
</span><span class="line"><span class="n">eruby</span> <span class="o">=</span> <span class="ss">Erubis</span><span class="p">:</span><span class="ss">:Eruby</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">template</span><span class="p">)</span>
</span><span class="line"><span class="nb">puts</span> <span class="n">eruby</span><span class="o">.</span><span class="n">src</span>
</span><span class="line"><span class="nb">puts</span> <span class="s2">&quot;==========&quot;</span>
</span><span class="line"><span class="nb">puts</span> <span class="n">eruby</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="ss">:whatever</span> <span class="o">=&gt;</span> <span class="s2">&quot;ponies!&quot;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Run it with <code>ruby erb_test.rb</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">bash</span><span class="o">-</span><span class="mi">3</span><span class="o">.</span><span class="mi">2</span><span class="err">$</span> <span class="n">ruby</span> <span class="n">erb_test</span><span class="o">.</span><span class="n">rb</span>
</span><span class="line"><span class="n">_buf</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span> <span class="n">_buf</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;Hello!   This is a template. It has &#39;</span><span class="p">;</span>
</span><span class="line"><span class="n">_buf</span> <span class="o">&lt;&lt;</span> <span class="p">(</span> <span class="n">whatever</span> <span class="p">)</span><span class="o">.</span><span class="n">to_s</span><span class="p">;</span> <span class="n">_buf</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;.&#39;</span><span class="p">;</span>
</span><span class="line"><span class="n">_buf</span><span class="o">.</span><span class="n">to_s</span>
</span><span class="line"><span class="o">==========</span>
</span><span class="line"><span class="no">Hello</span><span class="o">!</span> <span class="no">This</span> <span class="n">is</span> <span class="n">a</span> <span class="n">template</span><span class="o">.</span>
</span><span class="line"><span class="no">It</span> <span class="n">has</span> <span class="n">ponies!</span><span class="o">.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The few lines starting with <code>_buf</code> are interesting. Erubis takes apart our string, appends it to <code>_buf</code> piece by piece, and adds the variables in as well after calling <code>.to_s</code> on them. Then it just returns <code>_buf</code>.</p>

<p><strong>Rack test example</strong></p>

<p><a href="https://github.com/brynary/rack-test">rack-test</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">require_relative</span> <span class="s2">&quot;test_helper&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">TestApp</span> <span class="o">&lt;</span> <span class="ss">Rulers</span><span class="p">:</span><span class="ss">:Application</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">get_controller_and_action</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">    <span class="o">[</span><span class="no">TestController</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">TestController</span> <span class="o">&lt;</span> <span class="ss">Rulers</span><span class="p">:</span><span class="ss">:Controlle</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">index</span>
</span><span class="line">    <span class="s2">&quot;Hello!&quot;</span>  <span class="c1"># Not rendering a view</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">RulersAppTest</span> <span class="o">&lt;</span> <span class="ss">Test</span><span class="p">:</span><span class="ss">:Unit</span><span class="o">::</span><span class="no">TestCase</span>
</span><span class="line"> <span class="kp">include</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Test</span><span class="o">::</span><span class="no">Methods</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">app</span>
</span><span class="line">    <span class="no">TestApp</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">test_request</span>
</span><span class="line">    <span class="n">get</span> <span class="s2">&quot;/example/route&quot;</span>
</span><span class="line">    <span class="n">assert</span> <span class="n">last_response</span><span class="o">.</span><span class="n">ok?</span>
</span><span class="line">    <span class="n">body</span> <span class="o">=</span> <span class="n">last_response</span><span class="o">.</span><span class="n">body</span>
</span><span class="line">    <span class="n">assert</span> <span class="n">body</span><span class="o">[</span><span class="s2">&quot;Hello&quot;</span><span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Rake test example</strong></p>

<p>Rake actually ships with a “Rake::TestTask”.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># Rakefile</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;bundler/gem_tasks&quot;</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;rake/testtask&quot;</span>
</span><span class="line">
</span><span class="line"><span class="ss">Rake</span><span class="p">:</span><span class="ss">:TestTask</span><span class="o">.</span><span class="n">new</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class="line">  <span class="n">t</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;test&quot;</span>  <span class="c1"># this is the default</span>
</span><span class="line">  <span class="n">t</span><span class="o">.</span><span class="n">libs</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;test&quot;</span>  <span class="c1"># load the test dir</span>
</span><span class="line">  <span class="n">t</span><span class="o">.</span><span class="n">test_files</span> <span class="o">=</span> <span class="no">Dir</span><span class="o">[</span><span class="s1">&#39;test/*test*.rb&#39;</span><span class="o">]</span>
</span><span class="line">  <span class="n">t</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>A word of caution</em>: Rake will always run your tests by loading them into the same Ruby process, then running each one in turn. This is a lot faster than running them in individual processes, but it means that your tests can mess with each other in annoying ways. If you find yourself saying, “but I didnʼt set that global variable in this test!” think about whether some other test might have done it. For extra fun, the tests donʼt always run in any predictable order.</p>

<p><strong>In Rails</strong></p>

<p>Rails actually allows registering a number of different template engines at once with a number of different extensions so that Erb files are rendered with Erubis, but .haml files are rendered with the HAML templating engine.</p>

<p>You can find the top-level view code in <a href="https://github.com/rails/rails/blob/master/actionview/lib/action_view.rb">actionpack/lib/action_view.rb</a>, and the whole big chunk of Rails view code in actionpack/lib/action_view/. From there, look in <a href="https://github.com/rails/rails/blob/master/actionview/lib/action_view/template/handlers/erb.rb">template/handlers/erb.rb</a> for a pretty compact description of exactly how Rails uses Erubis to render Erb templates. You can see that most of the bulk of Railsʼ version is setup, interface and dealing with string encodings. You save a lot of trouble by knowing that youʼre basically only dealing with ASCII and/or UTF-8 strings.</p>

<h2 id="basic-models">5. Basic Models</h2>

<p>Use <a href="https://github.com/intridea/multi_json">multi_json</a> (a generic swappable back-end for JSON handling) to built a simple system of models based on JSON files.</p>

<p><strong>In Rails</strong></p>

<p>ActiveRecord is an Object-Relational Mapper so that each of your objects represents a database row. ActiveModel is the interface that Rails uses to all of storage including non-relational stores like Cassandra or MongoDB, to fit particular object types into Rails.</p>

<p>For a good overview of ActiveModel, have a look at a blog post from Yehuda Katz on that topic: <a href="http://yehudakatz.com/2010/01/10/activemodel-make-any-ruby-object-feel-like-activerecord/">ActiveModel: Make Any Ruby Object Feel Like ActiveRecord</a></p>

<h2 id="request-response">6. Request, Response</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/controller.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Rulers</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">Controller</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">response</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> <span class="n">headers</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class="line">      <span class="k">raise</span> <span class="s2">&quot;Already responded!&quot;</span> <span class="k">if</span> <span class="vi">@response</span>
</span><span class="line">      <span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="n">text</span><span class="o">].</span><span class="n">flatten</span>
</span><span class="line">      <span class="vi">@response</span> <span class="o">=</span> <span class="ss">Rack</span><span class="p">:</span><span class="ss">:Response</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_response</span>  <span class="c1"># Only for Rulers</span>
</span><span class="line">      <span class="vi">@response</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">render_response</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">      <span class="n">response</span><span class="p">(</span><span class="n">render</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># rulers/lib/rulers.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Ruler</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">Application</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>   <span class="c1"># Redefine</span>
</span><span class="line">      <span class="k">if</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;/favicon.ico&#39;</span>
</span><span class="line">        <span class="k">return</span> <span class="o">[</span><span class="mi">404</span><span class="p">,</span>
</span><span class="line">          <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">},</span> <span class="o">[]]</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">      <span class="n">klass</span><span class="p">,</span> <span class="n">act</span> <span class="o">=</span> <span class="n">get_controller_and_action</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">      <span class="n">controller</span> <span class="o">=</span> <span class="n">klass</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">      <span class="n">text</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">act</span><span class="p">)</span>
</span><span class="line">      <span class="k">if</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_response</span>
</span><span class="line">        <span class="c1"># ensure the code after render_response works</span>
</span><span class="line">        <span class="n">st</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">controller</span><span class="o">.</span><span class="n">get_response</span><span class="o">.</span><span class="n">to_a</span>
</span><span class="line">        <span class="o">[</span><span class="n">st</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="o">[</span><span class="n">rs</span><span class="o">.</span><span class="n">body</span><span class="o">].</span><span class="n">flatten</span><span class="o">]</span>
</span><span class="line">      <span class="k">else</span>
</span><span class="line">        <span class="c1"># without explicitly render_response in action,</span>
</span><span class="line">        <span class="c1"># you can add auto render here</span>
</span><span class="line">        <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">},</span> <span class="o">[</span><span class="n">text</span><span class="o">]]</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In Rails, the return value from the controller is ignored. Instead if you donʼt call render (Railsʼ equivalent of render_response), it will automatically call it for you with the same controller name, and the viewʼs name set to the same name as your action.</p>

<p>Rails doesnʼt return the string when you call “render” (well, usually - some calls to render do!). Instead, it keeps track of the fact that you called render and what you called it on. Then it gives you an error if you call it again, or uses the defaults if you get to the end of a controller action without calling it</p>

<p><strong>Instance Variables</strong></p>

<p>The Rails answer is to set instance variables in the controller, then use them in the view. Try creating a new view object, mostly just to use Erubis to evaluate the view file. Then, make it easy to pass in a hash of instance variables which youʼll set on the view object before doing the evaluation.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/controller.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Rulers</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">Controller</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="n">view_name</span><span class="p">,</span> <span class="n">locals</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class="line">      <span class="n">filename</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">join</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="s1">&#39;views&#39;</span><span class="p">,</span> <span class="n">controller_name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">view_name</span><span class="si">}</span><span class="s2">.html.erb&quot;</span>
</span><span class="line">      <span class="n">ivars</span> <span class="o">=</span> <span class="nb">instance_variables</span><span class="o">.</span><span class="n">reduce</span><span class="p">({})</span> <span class="p">{</span><span class="o">|</span><span class="n">ha</span><span class="p">,</span> <span class="n">iv</span><span class="o">|</span> <span class="n">ha</span><span class="o">[</span><span class="n">iv</span><span class="o">]</span> <span class="o">=</span> <span class="nb">instance_variable_get</span><span class="p">(</span><span class="n">iv</span><span class="p">);</span> <span class="n">ha</span> <span class="p">}</span>
</span><span class="line">      <span class="ss">Rulers</span><span class="p">:</span><span class="ss">:View</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">ivars</span><span class="p">,</span> <span class="n">locals</span><span class="p">)</span><span class="o">.</span><span class="n">result</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>In Rails</strong></p>

<p>Rails (more specifically, ActionPack) uses Rack in a very similar way, even exposing the Rack Request object with the “request” method. Especially <a href="https://github.com/rails/rails/blob/master/actionpack%2Flib%2Faction_controller%2Fmetal.rb">metal.rb </a>and metal/*.rb. “Rails Metal” is a name for the lower-level Rails which goes mostly straight through to the “bare metal” – that is, to Rack.</p>

<p>You can find a lot of the Rails implementation of Rack in these directories – for instance, metal/redirecting.rb is the implementation of the redirect_to() helper which returns status 302 (redirect) and a location to Rack. You could steal the code and add a redirect_to to Rulers, if you wanted.</p>

<p>You can also find things like forgery (CSRF) protection, multiple renderers (i.e. Erb vs Haml), forcing SSL if requested and cookies in this directory. Some are complex, while others call to Rack very simply and you could move right over to Rulers.</p>

<h2 id="the-littlest-orm">7. The Littlest ORM</h2>

<p>migration</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># best_quotes/mini_migration.rb</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;sqlite3&quot;</span>
</span><span class="line"><span class="n">conn</span> <span class="o">=</span> <span class="ss">SQLite3</span><span class="p">:</span><span class="ss">:Database</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;test.db&quot;</span>
</span><span class="line"><span class="n">conn</span><span class="o">.</span><span class="n">execute</span> <span class="o">&lt;&lt;</span><span class="no">SQL</span>
</span><span class="line"><span class="sh">create table my_table (</span>
</span><span class="line"><span class="sh">  id INTEGER PRIMARY KEY,</span>
</span><span class="line"><span class="sh">  posted INTEGER,</span>
</span><span class="line"><span class="sh">  title VARCHAR(30),</span>
</span><span class="line"><span class="sh">  body VARCHAR(32000));</span>
</span><span class="line"><span class="no">SQL</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>sqlite model</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
<span class="line-number">84</span>
<span class="line-number">85</span>
<span class="line-number">86</span>
<span class="line-number">87</span>
<span class="line-number">88</span>
<span class="line-number">89</span>
<span class="line-number">90</span>
<span class="line-number">91</span>
<span class="line-number">92</span>
<span class="line-number">93</span>
<span class="line-number">94</span>
<span class="line-number">95</span>
<span class="line-number">96</span>
<span class="line-number">97</span>
<span class="line-number">98</span>
<span class="line-number">99</span>
<span class="line-number">100</span>
<span class="line-number">101</span>
<span class="line-number">102</span>
<span class="line-number">103</span>
<span class="line-number">104</span>
<span class="line-number">105</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/sqlite_model.rb</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;sqlite3&quot;</span>
</span><span class="line"><span class="nb">require</span> <span class="s2">&quot;rulers/util&quot;</span>
</span><span class="line">
</span><span class="line"><span class="no">DB</span> <span class="o">=</span> <span class="ss">SQLite3</span><span class="p">:</span><span class="ss">:Database</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;test.db&quot;</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">Rulers</span>
</span><span class="line">  <span class="k">module</span> <span class="nn">Model</span>
</span><span class="line">    <span class="k">class</span> <span class="nc">SQLite</span>
</span><span class="line">
</span><span class="line">      <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class="line">        <span class="k">def</span> <span class="nf">table</span>
</span><span class="line">          <span class="no">Rulers</span><span class="o">.</span><span class="n">to_underscore</span> <span class="nb">name</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">schema</span>
</span><span class="line">          <span class="k">return</span> <span class="vi">@schema</span> <span class="k">if</span> <span class="vi">@schema</span>
</span><span class="line">          <span class="vi">@schema</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">          <span class="no">DB</span><span class="o">.</span><span class="n">table_info</span><span class="p">(</span><span class="n">table</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
</span><span class="line">            <span class="vi">@schema</span><span class="o">[</span> <span class="n">row</span><span class="o">[</span><span class="s1">&#39;name&#39;</span><span class="o">]</span> <span class="o">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">[</span><span class="s1">&#39;type&#39;</span><span class="o">]</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">          <span class="vi">@schema</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">to_sql</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
</span><span class="line">          <span class="k">case</span> <span class="n">val</span>
</span><span class="line">          <span class="k">when</span> <span class="no">Numeric</span>
</span><span class="line">            <span class="n">val</span><span class="o">.</span><span class="n">to_s</span>
</span><span class="line">          <span class="k">when</span> <span class="nb">String</span>
</span><span class="line">            <span class="s2">&quot;&#39;</span><span class="si">#{</span><span class="n">val</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span class="line">          <span class="k">else</span>
</span><span class="line">            <span class="k">raise</span> <span class="s2">&quot;Can&#39;t change </span><span class="si">#{</span><span class="n">val</span><span class="o">.</span><span class="n">class</span><span class="si">}</span><span class="s2"> to SQL!&quot;</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
</span><span class="line">          <span class="n">values</span><span class="o">.</span><span class="n">delete</span> <span class="s1">&#39;id&#39;</span>
</span><span class="line">          <span class="n">keys</span> <span class="o">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">keys</span> <span class="o">-</span> <span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span>
</span><span class="line">          <span class="n">vals</span> <span class="o">=</span> <span class="n">keys</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="o">|</span>
</span><span class="line">            <span class="n">values</span><span class="o">[</span><span class="n">key</span><span class="o">]</span> <span class="p">?</span> <span class="n">to_sql</span><span class="p">(</span><span class="n">values</span><span class="o">[</span><span class="n">key</span><span class="o">]</span><span class="p">)</span> <span class="p">:</span> <span class="s1">&#39;null&#39;</span>
</span><span class="line">          <span class="k">end</span>
</span><span class="line">
</span><span class="line">          <span class="no">DB</span><span class="o">.</span><span class="n">execute</span> <span class="o">&lt;&lt;</span><span class="no">SQL</span>
</span><span class="line"><span class="sh">            INSERT INTO #{table} (#{keys.join(&#39;,&#39;)})</span>
</span><span class="line"><span class="sh">            VALUES (#{vals.join(&#39;,&#39;)});</span>
</span><span class="line"><span class="no">SQL</span>
</span><span class="line">
</span><span class="line">          <span class="n">data</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">[</span><span class="n">keys</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">vals</span><span class="p">)</span><span class="o">]</span>
</span><span class="line">          <span class="n">sql</span> <span class="o">=</span> <span class="s2">&quot;SELECT last_insert_rowid();&quot;</span>
</span><span class="line">          <span class="n">data</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span>
</span><span class="line">          <span class="nb">self</span><span class="o">.</span><span class="n">new</span> <span class="n">data</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">count</span>
</span><span class="line">          <span class="no">DB</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="o">&lt;&lt;</span><span class="no">SQL</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">]</span>
</span><span class="line"><span class="sh">            SELECT COUNT(*) FROM #{table}</span>
</span><span class="line"><span class="no">SQL</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="k">def</span> <span class="nf">find</span><span class="p">(</span><span class="nb">id</span><span class="p">)</span>
</span><span class="line">          <span class="n">row</span> <span class="o">=</span> <span class="no">DB</span><span class="o">.</span><span class="n">execute</span> <span class="o">&lt;&lt;</span><span class="no">SQL</span>
</span><span class="line"><span class="sh">            SELECT #{schema.keys.join(&#39;,&#39;)} from #{table} where id=#{id}</span>
</span><span class="line"><span class="no">SQL</span>
</span><span class="line">          <span class="n">data</span> <span class="o">=</span> <span class="no">Hash</span><span class="o">[</span> <span class="n">schema</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">zip</span> <span class="n">row</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">]</span>
</span><span class="line">          <span class="nb">self</span><span class="o">.</span><span class="n">new</span> <span class="n">data</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class="line">        <span class="vi">@hash</span> <span class="o">=</span> <span class="n">data</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">      <span class="k">def</span> <span class="nf">[]</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">        <span class="vi">@hash</span><span class="o">[</span><span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">      <span class="k">def</span> <span class="nf">[]=</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span class="line">        <span class="vi">@hash</span><span class="o">[</span><span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">      <span class="k">def</span> <span class="nf">save!</span>
</span><span class="line">        <span class="k">unless</span> <span class="vi">@hash</span><span class="o">[</span><span class="s1">&#39;id&#39;</span><span class="o">]</span>
</span><span class="line">          <span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">create</span>
</span><span class="line">          <span class="k">return</span> <span class="kp">true</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="n">fields</span> <span class="o">=</span> <span class="vi">@hash</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span>
</span><span class="line">          <span class="s2">&quot;</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">#{</span><span class="nb">self</span><span class="o">.</span><span class="n">class</span><span class="o">.</span><span class="n">to_sql</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">        <span class="k">end</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">        <span class="no">DB</span><span class="o">.</span><span class="n">execute</span> <span class="o">&lt;&lt;</span><span class="no">SQL</span>
</span><span class="line"><span class="sh">          UPDATE #{self.class.table}</span>
</span><span class="line"><span class="sh">          SET #{fields}</span>
</span><span class="line"><span class="sh">          WHERE id=&quot;#{@hash[&#39;id&#39;]}&quot;</span>
</span><span class="line"><span class="no">SQL</span>
</span><span class="line">        <span class="kp">true</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">      <span class="k">def</span> <span class="nf">save</span>
</span><span class="line">        <span class="n">save!</span> <span class="k">rescue</span> <span class="kp">false</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You can add a method to the SQLite model that takes a column name and a type, and then when saving and loading that column, does something type-dependent to it, like the boolean or JSON fields above.</p>

<p>ActiveRecord allows both ways – you can research the <code>before_save</code> and <code>after_initialize</code> callbacks for how to do it on save/ load.</p>

<p><strong>In Rails</strong></p>

<p>ActiveRecord contains mappings of operations like our gem, but also migrations, cross-database compatibility and a huge amount of optimization and general complexity. And thatʼs even though they use the ARel gem for most of the heavy lifting!</p>

<h2 id="rack-middleware">8. Rack Middleware</h2>

<p>With any Ruby web framework, you can modify how it works by adding Rack components around it. I like thinking of them as pancakes, because Rack lets you build your framework and your application like a stack of pancakes.</p>

<p><strong>Built-in middlewares</strong></p>

<ul>
  <li><strong>Rack::Auth::Basic</strong> - HTTP Basic authentication.</li>
  <li><strong>Rack::Auth::Digest</strong> - HTTP Digest authentication.</li>
  <li><strong>Rack::Cascade</strong> - Pass a request to a series of Rack apps, and use the first request that comes back as good. Itʼs a way to mount one Rack app “on top of” another (or many).</li>
  <li><strong>Rack::Chunked</strong> - A Rack interface to HTTP Chunked transfer.</li>
  <li><strong>Rack::CommonLogger</strong> - Request logging.</li>
  <li><strong>Rack::ConditionalGet</strong> - Implement HTTP If-None-Match and If- Modified-Since with ETags and dates.</li>
  <li><strong>Rack::Config</strong> - Call a given block before each request.</li>
  <li><strong>Rack::ContentLength</strong> - Set Content-Length automatically.</li>
  <li><strong>Rack::ContentType</strong> - Try to guess Content-Type and set it. Rack::Deflater - Compress the response with gzip/deflate.</li>
  <li><strong>Rack::Directory</strong> - Add Apache-style directory listings. This is an endpoint not an intermediate layer, so use it with “run.”</li>
  <li><strong>Rack::ETag</strong> - Generate ETags from MD5s of the content.</li>
  <li><strong>Rack::Head</strong> - Remove response body for HEAD requests.</li>
  <li><strong>Rack::Lint</strong> - Check your responses for correctness.</li>
  <li><strong>Rack::Lock</strong> - Only allow one thread in at once.</li>
  <li><strong>Rack::Reloader</strong> - Reload your app when files change.</li>
  <li><strong>Rack::Runtime</strong> - Times the request, sets X-Runtime in response.</li>
  <li><strong>Rack::Sendfile</strong> - Use the X-Sendfile header to ask your web server to send a file much faster than Ruby can.</li>
  <li><strong>Rack::ShowExceptions</strong> - Show a nice exception page if something breaks.</li>
  <li><strong>Rack::ShowStatus</strong> - Show a pretty page if the result is empty.</li>
  <li><strong>Rack::Static</strong> - Serve from certain directories as static files instead
of calling your framework.</li>
  <li><strong>Rack::URLMap</strong> - Route different directories to different apps or different stacks. You can also use this with a “map” block in config.ru.</li>
</ul>

<p>Rack::URLMap is a way to tell Rack what paths go to what Rack apps - and if thereʼs could be two that match, the longer path always takes precedence.</p>

<p>Rack::ContentType is to set the default HTML content type for everything. Since itʼs at the top, outside the blocks, it applies to all the blocks.</p>

<p>The lobster, by the way, is a simple test app built into Rack. Youʼll see it as an example in many places.</p>

<p><strong>Thrid-party middlewares</strong></p>

<ul>
  <li><a href="https://github.com/rack/rack-contrib">rack-contrib</a></li>
  <li><a href="https://github.com/rack/rack/wiki/List-of-Middleware">middlewares listed in rack wiki</a></li>
</ul>

<p><strong>In Rails</strong></p>

<p>The primary Rack application object in Rails is called ActionController::Dispatcher.</p>

<p>ActionController::Base allows you to get mini-Rack-apps for each controller action because it inherits from Metal, the basic Rails Rack class. So you can call MyController.action(:myaction) and get a Rack app for that action in your controller.</p>

<p><strong>Calling order of Rack middlewares</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Foo</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Foo#init&#39;</span>
</span><span class="line">    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class="line">    <span class="vi">@arg</span> <span class="o">=</span> <span class="n">arg</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Foo#initend&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Foo#call&#39;</span>
</span><span class="line">    <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">    <span class="n">content</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@arg</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Foo#callend&#39;</span>
</span><span class="line">    <span class="o">[</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span> <span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Bar</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="n">arg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Bar#init&#39;</span>
</span><span class="line">    <span class="vi">@app</span> <span class="o">=</span> <span class="n">app</span>
</span><span class="line">    <span class="vi">@arg</span> <span class="o">=</span> <span class="n">arg</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Bar#initend&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Bar#call&#39;</span>
</span><span class="line">    <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span> <span class="o">=</span> <span class="vi">@app</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">    <span class="n">content</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@arg</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="nb">puts</span> <span class="s1">&#39;--&gt; Bar#callend&#39;</span>
</span><span class="line">    <span class="o">[</span> <span class="n">status</span><span class="p">,</span> <span class="n">headers</span><span class="p">,</span> <span class="n">content</span> <span class="o">]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">use</span> <span class="no">Foo</span><span class="p">,</span> <span class="s1">&#39;, foo&#39;</span>
</span><span class="line"><span class="n">use</span> <span class="no">Bar</span><span class="p">,</span> <span class="s1">&#39;, bar&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">run</span> <span class="nb">proc</span> <span class="p">{</span>
</span><span class="line">  <span class="nb">puts</span> <span class="s1">&#39;--&gt; main#call&#39;</span>
</span><span class="line">  <span class="o">[</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;text/html&#39;</span><span class="p">},</span> <span class="o">[</span><span class="s1">&#39;Hello, world&#39;</span><span class="o">]]</span>
</span><span class="line"><span class="p">}</span>
</span><span class="line">
</span><span class="line"><span class="c1"># $ rackup</span>
</span><span class="line"><span class="c1"># --&gt; Bar#init</span>
</span><span class="line"><span class="c1"># --&gt; Bar#initend</span>
</span><span class="line"><span class="c1"># --&gt; Foo#init</span>
</span><span class="line"><span class="c1"># --&gt; Foo#initend</span>
</span><span class="line"><span class="c1"># Thin web server (v1.6.1 codename Death Proof)</span>
</span><span class="line"><span class="c1"># Maximum connections set to 1024</span>
</span><span class="line"><span class="c1"># Listening on 0.0.0.0:9292, CTRL+C to stop</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># --&gt; Foo#call</span>
</span><span class="line"><span class="c1"># --&gt; Bar#call</span>
</span><span class="line"><span class="c1"># --&gt; main#call</span>
</span><span class="line"><span class="c1"># --&gt; Bar#callend</span>
</span><span class="line"><span class="c1"># --&gt; Foo#callend</span>
</span><span class="line"><span class="c1"># 127.0.0.1 - wendi [23/Sep/2014 15:56:20] &quot;GET / HTTP/1.1&quot; 200 - 0.0013</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Other samples:</p>

<ul>
  <li><a href="https://gist.github.com/ifyouseewendy/15dd511d2d939e432068#file-config-lobster-ru">lobster</a></li>
  <li><a href="https://gist.github.com/ifyouseewendy/15dd511d2d939e432068#file-config-auth-ru">auth</a></li>
  <li><a href="https://gist.github.com/ifyouseewendy/15dd511d2d939e432068#file-config-benchmark-ru">benchmark</a></li>
</ul>

<h2 id="real-routing">9. Real Routing</h2>

<p>Rails 3 takes this a half-step farther and makes every action on every controller a full-on Rack app that you can extract and use.</p>

<p>Add RouteObject class.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
<span class="line-number">42</span>
<span class="line-number">43</span>
<span class="line-number">44</span>
<span class="line-number">45</span>
<span class="line-number">46</span>
<span class="line-number">47</span>
<span class="line-number">48</span>
<span class="line-number">49</span>
<span class="line-number">50</span>
<span class="line-number">51</span>
<span class="line-number">52</span>
<span class="line-number">53</span>
<span class="line-number">54</span>
<span class="line-number">55</span>
<span class="line-number">56</span>
<span class="line-number">57</span>
<span class="line-number">58</span>
<span class="line-number">59</span>
<span class="line-number">60</span>
<span class="line-number">61</span>
<span class="line-number">62</span>
<span class="line-number">63</span>
<span class="line-number">64</span>
<span class="line-number">65</span>
<span class="line-number">66</span>
<span class="line-number">67</span>
<span class="line-number">68</span>
<span class="line-number">69</span>
<span class="line-number">70</span>
<span class="line-number">71</span>
<span class="line-number">72</span>
<span class="line-number">73</span>
<span class="line-number">74</span>
<span class="line-number">75</span>
<span class="line-number">76</span>
<span class="line-number">77</span>
<span class="line-number">78</span>
<span class="line-number">79</span>
<span class="line-number">80</span>
<span class="line-number">81</span>
<span class="line-number">82</span>
<span class="line-number">83</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">RouteObject</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@rules</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># save routing rules</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">match</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">    <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">    <span class="n">options</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span> <span class="k">if</span> <span class="n">args</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">is_a?</span><span class="p">(</span><span class="no">Hash</span><span class="p">)</span>
</span><span class="line">    <span class="n">options</span><span class="o">[</span><span class="ss">:default</span><span class="o">]</span> <span class="o">||=</span> <span class="p">{}</span>
</span><span class="line">
</span><span class="line">    <span class="n">dest</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class="line">    <span class="n">dest</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class="line">    <span class="k">raise</span> <span class="s1">&#39;Too many args!&#39;</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span>
</span><span class="line">
</span><span class="line">    <span class="n">parts</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">parts</span><span class="o">.</span><span class="n">select!</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="o">!</span><span class="nb">p</span><span class="o">.</span><span class="n">empty?</span> <span class="p">}</span>
</span><span class="line">
</span><span class="line">    <span class="n">vars</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">regexp_parts</span> <span class="o">=</span> <span class="n">parts</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">part</span><span class="o">|</span>
</span><span class="line">      <span class="k">if</span> <span class="n">part</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;:&#39;</span>
</span><span class="line">        <span class="n">vars</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class="line">        <span class="s2">&quot;([a-zA-Z0-9_]+)&quot;</span>
</span><span class="line">      <span class="k">elsif</span> <span class="n">part</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span>
</span><span class="line">        <span class="n">vars</span> <span class="o">&lt;&lt;</span> <span class="n">part</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span>
</span><span class="line">        <span class="s2">&quot;(.*)&quot;</span>
</span><span class="line">      <span class="k">else</span>
</span><span class="line">        <span class="n">part</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="n">regexp</span> <span class="o">=</span> <span class="n">regexp_parts</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@rules</span><span class="o">.</span><span class="n">push</span><span class="p">({</span>
</span><span class="line">      <span class="ss">:regexp</span> <span class="o">=&gt;</span> <span class="no">Regexp</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;^/</span><span class="si">#{</span><span class="n">regexp</span><span class="si">}</span><span class="s2">$&quot;</span><span class="p">),</span>
</span><span class="line">      <span class="ss">:vars</span> <span class="o">=&gt;</span> <span class="n">vars</span><span class="p">,</span>
</span><span class="line">      <span class="ss">:dest</span> <span class="o">=&gt;</span> <span class="n">dest</span><span class="p">,</span>
</span><span class="line">      <span class="ss">:options</span> <span class="o">=&gt;</span> <span class="n">options</span>
</span><span class="line">    <span class="p">})</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># match rules to url and route to specific controller action.</span>
</span><span class="line">  <span class="c1"># </span>
</span><span class="line">  <span class="c1"># 1. the router just applies them in order -- if more than</span>
</span><span class="line">  <span class="c1">#    one rule matches, the first one wins.</span>
</span><span class="line">  <span class="c1"># 2. the second argument can be a Rack application, </span>
</span><span class="line">  <span class="c1">#    which Rails then calls.</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">check_url</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@rules</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class="line">      <span class="n">m</span> <span class="o">=</span> <span class="n">r</span><span class="o">[</span><span class="ss">:regexp</span><span class="o">].</span><span class="n">match</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">      <span class="k">if</span> <span class="n">m</span>
</span><span class="line">        <span class="n">options</span> <span class="o">=</span> <span class="n">r</span><span class="o">[</span><span class="ss">:options</span><span class="o">]</span>
</span><span class="line">        <span class="n">params</span> <span class="o">=</span> <span class="n">options</span><span class="o">[</span><span class="ss">:default</span><span class="o">].</span><span class="n">dup</span>
</span><span class="line">
</span><span class="line">        <span class="n">r</span><span class="o">[</span><span class="ss">:vars</span><span class="o">].</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">v</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
</span><span class="line">          <span class="n">params</span><span class="o">[</span><span class="n">v</span><span class="o">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">captures</span><span class="o">[</span><span class="n">i</span><span class="o">]</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">
</span><span class="line">        <span class="k">if</span> <span class="n">r</span><span class="o">[</span><span class="ss">:dest</span><span class="o">]</span>
</span><span class="line">          <span class="k">return</span> <span class="n">get_dest</span><span class="p">(</span><span class="n">r</span><span class="o">[</span><span class="ss">:dest</span><span class="o">]</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span class="line">        <span class="k">else</span>
</span><span class="line">          <span class="n">controller</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="s1">&#39;controller&#39;</span><span class="o">]</span>
</span><span class="line">          <span class="n">action</span> <span class="o">=</span> <span class="n">params</span><span class="o">[</span><span class="s1">&#39;action&#39;</span><span class="o">]</span>
</span><span class="line">          <span class="k">return</span> <span class="n">get_dest</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">controller</span><span class="si">}</span><span class="s2">#</span><span class="si">#{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
</span><span class="line">        <span class="k">end</span>
</span><span class="line">      <span class="k">end</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="kp">nil</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">get_dest</span><span class="p">(</span><span class="n">dest</span><span class="p">,</span> <span class="n">routing_params</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class="line">    <span class="k">return</span> <span class="n">dest</span> <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">respond_to?</span><span class="p">(</span><span class="ss">:call</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="k">if</span> <span class="n">dest</span> <span class="o">=~</span> <span class="sr">/^([^#]+)#([^#]+)$/</span>
</span><span class="line">      <span class="nb">name</span> <span class="o">=</span> <span class="vg">$1</span><span class="o">.</span><span class="n">capitalize</span>
</span><span class="line">      <span class="n">cont</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">const_get</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">Controller&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="k">return</span> <span class="n">cont</span><span class="o">.</span><span class="n">action</span><span class="p">(</span><span class="vg">$2</span><span class="p">,</span> <span class="n">routing_params</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">raise</span> <span class="s2">&quot;No destination: </span><span class="si">#{</span><span class="n">dest</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Define <code>route</code> to save rules in an instance of RouteObject, and use <code>get_rack_app</code> to route to controller actions. </p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Rulers</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">Application</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@route_obj</span> <span class="o">||=</span> <span class="no">RouteObject</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">      <span class="vi">@route_obj</span><span class="o">.</span><span class="n">instance_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">get_rack_app</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">      <span class="k">raise</span> <span class="s1">&#39;No routes!&#39;</span> <span class="k">unless</span> <span class="vi">@route_obj</span>
</span><span class="line">      <span class="vi">@route_obj</span><span class="o">.</span><span class="n">check_url</span> <span class="n">env</span><span class="o">[</span><span class="s1">&#39;PATH_INFO&#39;</span><span class="o">]</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Update Rulers::Controller to use <code>self.action</code> to initialize rack app, and <code>dispatch</code> to specific action.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># rulers/lib/rulers/controller.rb</span>
</span><span class="line"><span class="k">module</span> <span class="nn">Rulers</span>
</span><span class="line">  <span class="k">class</span> <span class="nc">Controller</span>
</span><span class="line">    <span class="kp">include</span> <span class="ss">Rulers</span><span class="p">:</span><span class="ss">:Model</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">env</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@env</span> <span class="o">=</span> <span class="n">env</span>
</span><span class="line">      <span class="vi">@routing_params</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">env</span>
</span><span class="line">      <span class="vi">@env</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">action</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="nb">p</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class="line">      <span class="nb">proc</span> <span class="p">{</span><span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="nb">self</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="n">dispatch</span><span class="p">(</span><span class="n">act</span><span class="p">,</span> <span class="nb">p</span><span class="p">)</span> <span class="p">}</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">dispatch</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">routing_params</span> <span class="o">=</span> <span class="p">{})</span>
</span><span class="line">      <span class="vi">@routing_params</span> <span class="o">=</span> <span class="n">routing_params</span>
</span><span class="line">
</span><span class="line">      <span class="nb">self</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</span><span class="line">      <span class="n">render_response</span> <span class="n">action</span><span class="o">.</span><span class="n">to_sym</span> <span class="k">unless</span> <span class="n">get_response</span>
</span><span class="line">      <span class="n">st</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="n">rs</span> <span class="o">=</span> <span class="n">get_response</span><span class="o">.</span><span class="n">to_a</span>
</span><span class="line">      <span class="o">[</span><span class="n">st</span><span class="p">,</span> <span class="n">hd</span><span class="p">,</span> <span class="o">[</span><span class="n">rs</span><span class="o">.</span><span class="n">body</span><span class="o">].</span><span class="n">flatten</span><span class="o">]</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="k">def</span> <span class="nf">params</span>
</span><span class="line">      <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">merge</span> <span class="vi">@routing_params</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>In Rails</strong></p>

<p>Rails connects lots of tiny Rack applications into a single overall application. Itʼs a complicated, multi-layered construction.</p>

<p>Each Rails controller keeps track of a mini-Rack stack of middleware which can be specified per-action like before_filters.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review] Git Community Book]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/09/27/git-community-book/"/>
    <updated>2014-09-27T13:51:25+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/09/27/git-community-book</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>Git Community Book</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>people in the Git community</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://alx.github.io/gitbook/">alx.github.io/gitbook</a></td>
    </tr>
  </tbody>
</table>

<ul id="markdown-toc">
  <li><a href="#git-object-model">Git Object Model</a>    <ul>
      <li><a href="#the-sha">The SHA</a></li>
      <li><a href="#the-objects">The Objects</a></li>
      <li><a href="#different-from-svn">Different from SVN</a></li>
    </ul>
  </li>
  <li><a href="#advanced-git">Advanced Git</a>    <ul>
      <li><a href="#create-new-empty-branches">Create New Empty Branches</a></li>
      <li><a href="#modifying-your-history">Modifying Your History</a></li>
      <li><a href="#advanced-merging">Advanced Merging</a></li>
      <li><a href="#git-and-email">Git and Email</a></li>
      <li><a href="#client-side-hookds">Client Side Hookds</a></li>
      <li><a href="#submodules">Submodules</a></li>
    </ul>
  </li>
  <li><a href="#internals-and-plumbing">Internals and Plumbing</a>    <ul>
      <li><a href="#how-git-stores-objects">How Git Stores Objects</a></li>
      <li><a href="#the-git-index">The Git Index</a></li>
      <li><a href="#the-packfile-index">The Packfile Index</a></li>
      <li><a href="#raw-git">Raw Git</a></li>
    </ul>
  </li>
</ul>

<h2 id="git-object-model">Git Object Model</h2>

<h3 id="the-sha">The SHA</h3>

<ol>
  <li>Represents object name.</li>
  <li>40-digit long.</li>
  <li>Use SHA1 hash to generate based on the object content.</li>
  <li>Keeps the identity.</li>
</ol>

<h3 id="the-objects">The Objects</h3>

<p>Every object consists of three things: <strong>type, size, content</strong>.</p>

<p>There are four different types of objects: <strong>blob, tree, commit, tag</strong>.</p>

<p><strong>blob</strong> is a chunk of binary data, used to stroe file data.</p>

<blockquote>
  <p>The blob is entirely defined by its data, totally independent of its location.</p>
</blockquote>

<p><strong>tree</strong> is basically like a directory - it references a bunch of other trees and/or blobs.</p>

<blockquote>
  <p>Since trees and blobs, like all other objects, are named by the SHA1 hash of their contents, two trees have the same SHA1 name if and only if their contents (including, recursively, the contents of all subdirectories) are identical.</p>
</blockquote>

<p><strong>commit</strong>  points to a single tree, marking it as what the project looked like at a certain point in time. It contains meta-information about that point in time, such as a timestamp, the author of the changes since the last commit, a pointer to the previous commit(s), etc.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">➜  git show --pretty<span class="o">=</span>raw HEAD
</span><span class="line">commit 6cc1a668111eb54ef4dbe976fff24f2e3d8b95f9
</span><span class="line">tree 36df675d7ae80e7eef0faac893b266801a4fa94a
</span><span class="line">parent d448c30aa03fba2884ab87c21081ef0f74d24f7e
</span><span class="line">author wendi &lt;wendi@umeng.com&gt; 1409022714 +0800
</span><span class="line">committer wendi &lt;wendi@umeng.com&gt; 1409022733 +0800
</span><span class="line">
</span><span class="line">    Update error <span class="nb">type </span>service url
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>tag</strong> is a way to mark a specific commit as special in some way. It is normally used to tag certain commits as specific releases or something along those lines.</p>

<blockquote>
  <p>A tag object contains an object name (called simply ‘object’), object type, tag name, the name of the person (“tagger”) who created the tag, and a message, which may contain a signature</p>
</blockquote>

<h3 id="different-from-svn">Different from SVN</h3>

<p>GIT stores a snapshot, while other SCM systems stores the differences between one commit and the next.</p>

<h2 id="advanced-git">Advanced Git</h2>

<h3 id="create-new-empty-branches">Create New Empty Branches</h3>

<p>Use <strong>symobolic-ref</strong>. A symbolic ref is a regular file that stores a string that begins with ref: refs/. For example, your .git/HEAD is a regular file whose contents is ref: refs/heads/master.</p>

<blockquote>
  <p>In the past, .git/HEAD was a symbolic link pointing at
       refs/heads/master. When we wanted to switch to another branch, we did
       ln -sf refs/heads/newbranch .git/HEAD, and when we wanted to find out
       which branch we are on, we did readlink .git/HEAD. But symbolic links
       are not entirely portable, so they are now deprecated and symbolic refs
       (as described above) are used by default.</p>
</blockquote>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git symbolic-ref HEAD refs/heads/newbranch
</span><span class="line">  <span class="c"># no branch is created,</span>
</span><span class="line">  <span class="c"># and all files are deleted to index.</span>
</span><span class="line"><span class="nv">$ </span>rm .git/index
</span><span class="line">git clean -fdx
</span><span class="line">&lt;<span class="k">do </span>work&gt;
</span><span class="line">git add your files
</span><span class="line">git commit -m <span class="s1">&#39;Initial commit&#39;</span>
</span><span class="line">  <span class="c"># branch &#39;newbranch&#39; is created.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="modifying-your-history">Modifying Your History</h3>

<p>use <code>git filter-branch</code> to rewrite branches.</p>

<h3 id="advanced-merging">Advanced Merging</h3>

<p>When merging, one parent will be <strong>HEAD</strong>, and the other will be the tip of the other branch, which is stored temporarily in <strong>MERGE_HEAD</strong>.</p>

<p>During the merge, the index holds three versions of each file. Each of these three “file stages” represents a different version of the file:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git show :1:file.txt <span class="c"># the file in a common ancestor of both branches.</span>
</span><span class="line"><span class="nv">$ </span>git show :2:file.txt <span class="c"># the version from HEAD.</span>
</span><span class="line"><span class="nv">$ </span>git show :3:file.txt <span class="c"># the version from MERGE_HEAD.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Some special diff options allow diffing the working directory against any of these stages:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git diff -1 file.txt <span class="c"># diff against stage 1</span>
</span><span class="line"><span class="nv">$ </span>git diff --base file.txt <span class="c"># same as the above</span>
</span><span class="line"><span class="nv">$ </span>git diff -2 file.txt <span class="c"># diff against stage 2</span>
</span><span class="line"><span class="nv">$ </span>git diff --ours file.txt <span class="c"># same as the above</span>
</span><span class="line"><span class="nv">$ </span>git diff -3 file.txt <span class="c"># diff against stage 3</span>
</span><span class="line"><span class="nv">$ </span>git diff --theirs file.txt <span class="c"># same as the above.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="git-and-email">Git and Email</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>man git-format-patch <span class="c"># Prepare patches for email submission</span>
</span><span class="line"><span class="nv">$ </span>man git-am <span class="c"># Apply a series of patches from a mailbox</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>git format-patch origin</code> will produce a numbered series of files in the current directory, one of each patch in the current branch but not in origin/HEAD.</p>

<p><code>git am patches.mbox</code></p>

<h3 id="client-side-hookds">Client Side Hookds</h3>

<p>by example, <code>GIT_DIR/hooks/pre-commit</code></p>

<h3 id="submodules">Submodules</h3>

<p>Create the submodules:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>mkdir ~/git
</span><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ~/git
</span><span class="line"><span class="nv">$ </span><span class="k">for </span>i in a b c d
</span><span class="line"><span class="k">do</span>
</span><span class="line"><span class="k">    </span>mkdir <span class="nv">$i</span>
</span><span class="line">    <span class="nb">cd</span> <span class="nv">$i</span>
</span><span class="line">    git init
</span><span class="line">    <span class="nb">echo</span> <span class="s2">&quot;module $i&quot;</span> &gt; <span class="nv">$i</span>.txt
</span><span class="line">    git add <span class="nv">$i</span>.txt
</span><span class="line">    git commit -m <span class="s2">&quot;Initial commit, submodule $i&quot;</span>
</span><span class="line">    <span class="nb">cd</span> ..
</span><span class="line"><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Create the superproject and add all the submodules:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>mkdir super
</span><span class="line"><span class="nv">$ </span><span class="nb">cd </span>super
</span><span class="line"><span class="nv">$ </span>git init
</span><span class="line"><span class="nv">$ </span><span class="k">for </span>i in a b c d
</span><span class="line"><span class="k">do</span>
</span><span class="line"><span class="k">    </span>git submodule add ~/git/<span class="nv">$i</span>
</span><span class="line"><span class="k">done</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>See what files git-submodule created:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>ls -a
</span><span class="line">.  ..  .git  .gitmodules  a  b  c  d
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>git-submodule add</code> command does a couple of things:</p>

<ul>
  <li>It clones the submodule under the current directory and by default checks out the master branch.</li>
  <li>It adds the submodule’s clone path to the gitmodules file and adds this file to the index, ready to be committed.</li>
  <li>It adds the submodule’s current commit ID to the index, ready to be committed.</li>
</ul>

<p>Commit the superproject:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git commit -m <span class="s2">&quot;Add submodules a, b, c and d.&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Clone the superproject:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ..
</span><span class="line"><span class="nv">$ </span>git clone super cloned
</span><span class="line"><span class="nv">$ </span><span class="nb">cd </span>cloned
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Check submodule status:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git submodule status
</span><span class="line">-d266b9873ad50488163457f025db7cdd9683d88b a
</span><span class="line">-e81d457da15309b4fef4249aba9b50187999670d b
</span><span class="line">-c1536a972b9affea0f16e0680ba87332dc059146 c
</span><span class="line">-d96249ff5d57de5de093e6baff9e0aafa5276a74 d
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Register the submodule into <code>.git/config</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git submodule init
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Clone the submodules and check out the commits specified in the superproject:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git submodule update
</span><span class="line"><span class="nv">$ </span><span class="nb">cd </span>a
</span><span class="line"><span class="nv">$ </span>ls -a
</span><span class="line">.  ..  .git  a.txt
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>One major difference between <code>git-submodule update</code> and <code>git-submodule add</code> is that git-submodule update checks out a specific commit, rather than the tip of a branch. It’s like checking out a tag: <strong>the head is detached</strong>, so you’re not working on a branch.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git branch
</span><span class="line">* <span class="o">(</span>no branch<span class="o">)</span>
</span><span class="line">master
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Check out or create a new branch:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git checkout master
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git checkout -b fix-up
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Do work and commit:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">echo</span> <span class="s2">&quot;adding a line again&quot;</span> &gt;&gt; a.txt
</span><span class="line"><span class="nv">$ </span>git commit -a -m <span class="s2">&quot;Updated the submodule from within the superproject.&quot;</span>
</span><span class="line"><span class="nv">$ </span>git push
</span><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ..
</span><span class="line"><span class="nv">$ </span>git diff
</span><span class="line">diff --git a/a b/a
</span><span class="line">index d266b98..261dfac 160000
</span><span class="line">--- a/a
</span><span class="line">+++ b/a
</span><span class="line">@@ -1 +1 @@
</span><span class="line">-Subproject commit d266b9873ad50488163457f025db7cdd9683d88b
</span><span class="line">+Subproject commit 261dfac35cb99d380eb966e102c1197139f7fa24
</span><span class="line"><span class="nv">$ </span>git add a
</span><span class="line"><span class="nv">$ </span>git commit -m <span class="s2">&quot;Updated submodule a.&quot;</span>
</span><span class="line"><span class="nv">$ </span>git push
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Cautions on Submodules</strong>:</p>

<p><em>Always publish the submodule change before publishing the change to the superproject that references it. If you forget to publish the submodule change, others won’t be able to clone the repository:</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ~/git/super/a
</span><span class="line"><span class="nv">$ </span><span class="nb">echo </span>i added another line to this file &gt;&gt; a.txt
</span><span class="line"><span class="nv">$ </span>git commit -a -m <span class="s2">&quot;doing it wrong this time&quot;</span>
</span><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ..
</span><span class="line"><span class="nv">$ </span>git add a
</span><span class="line"><span class="nv">$ </span>git commit -m <span class="s2">&quot;Updated submodule a again.&quot;</span>
</span><span class="line"><span class="nv">$ </span>git push
</span><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ~/git/cloned
</span><span class="line"><span class="nv">$ </span>git pull
</span><span class="line"><span class="nv">$ </span>git submodule update
</span><span class="line">error: pathspec <span class="s1">&#39;261dfac35cb99d380eb966e102c1197139f7fa24&#39;</span> did not match any file<span class="o">(</span>s<span class="o">)</span> known to git.
</span><span class="line">Did you forget to <span class="s1">&#39;git add&#39;</span>?
</span><span class="line">Unable to checkout <span class="s1">&#39;261dfac35cb99d380eb966e102c1197139f7fa24&#39;</span> in submodule path <span class="s1">&#39;a&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>It’s not safe to run git submodule update if you’ve made and committed changes within a submodule without checking out a branch first. They will be silently overwritten</em>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>cat a.txt
</span><span class="line">module a
</span><span class="line"><span class="nv">$ </span><span class="nb">echo </span>line added from private2 &gt;&gt; a.txt
</span><span class="line"><span class="nv">$ </span>git commit -a -m <span class="s2">&quot;line added inside private2&quot;</span>
</span><span class="line"><span class="nv">$ </span><span class="nb">cd</span> ..
</span><span class="line"><span class="nv">$ </span>git submodule update
</span><span class="line">Submodule path <span class="s1">&#39;a&#39;</span>: checked out <span class="s1">&#39;d266b9873ad50488163457f025db7cdd9683d88b&#39;</span>
</span><span class="line"><span class="nv">$ </span><span class="nb">cd </span>a
</span><span class="line"><span class="nv">$ </span>cat a.txt
</span><span class="line">module a
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="internals-and-plumbing">Internals and Plumbing</h2>

<h3 id="how-git-stores-objects">How Git Stores Objects</h3>

<p><strong>Loose objects</strong> are the simpler format. It is simply the compressed data stored in a single file on disk.</p>

<p>If the sha of your object is <code>ab04d884140f7b0cf8bbf86d6883869f16a46f65</code>, then the file will be stored in the following path:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line">GIT_DIR/objects/ab/04d884140f7b0cf8bbf86d6883869f16a46f65
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The Ruby implementation of object storage:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">put_raw_object</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">type</span><span class="p">)</span>
</span><span class="line">  <span class="n">size</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">length</span><span class="o">.</span><span class="n">to_s</span>
</span><span class="line">
</span><span class="line">  <span class="n">header</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">size</span><span class="si">}</span><span class="s2">#body&quot;</span>
</span><span class="line">  <span class="n">store</span> <span class="o">=</span> <span class="n">header</span> <span class="o">+</span> <span class="n">content</span>
</span><span class="line">
</span><span class="line">  <span class="n">sha1</span> <span class="o">=</span> <span class="ss">Digest</span><span class="p">:</span><span class="ss">:SHA1</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class="line">  <span class="n">path</span> <span class="o">=</span> <span class="vi">@git_dir</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">sha1</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">2</span><span class="o">]</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">sha1</span><span class="o">[</span><span class="mi">2</span><span class="o">.</span><span class="n">.</span><span class="mi">40</span><span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="k">if</span> <span class="o">!</span><span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">    <span class="n">content</span> <span class="o">=</span> <span class="ss">Zlib</span><span class="p">:</span><span class="ss">:Deflate</span><span class="o">.</span><span class="n">deflate</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
</span><span class="line">
</span><span class="line">    <span class="no">FileUtils</span><span class="o">.</span><span class="n">mkdir_p</span><span class="p">(</span><span class="vi">@directory</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">sha1</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">.</span><span class="mi">2</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">    <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
</span><span class="line">      <span class="n">f</span><span class="o">.</span><span class="n">write</span> <span class="n">content</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">return</span> <span class="n">sha1</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Packed Objects</strong>. In order to save that space, Git utilizes the packfile. This is a format where Git will only save the part that has changed in the second file, with a pointer to the file it is similar to.</p>

<h3 id="the-git-index">The Git Index</h3>

<p>The index is a binary file (generally kept in .git/index) containing a sorted list of path names.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git ls-files --stage
</span><span class="line">100644 63c918c667fa005ff12ad89437f2fdc80926e21c 0
</span><span class="line">100644 5529b198e8d14decbe4ad99db3f7fb632de0439d 0
</span><span class="line">100644 6ff87c4664981e4397625791c8ea3bbb5f2279a3 0
</span><span class="line">100644 a37b2152bd26be2c2289e1f57a292534a51a93c7 0
</span><span class="line">100644 fbefe9a45b00a54b58d94d06eca48b03d40a50e0 0
</span><span class="line">...
</span><span class="line">100644 2511aef8d89ab52be5ec6a5e46236b4b6bcd07ea 0
</span><span class="line">100644 2ade97b2574a9f77e7ae4002a4e07a6a38e46d07 0
</span><span class="line">100644 d5de8292e05e7c36c4b68857c1cf9855e3d2f70a 0
</span><span class="line">.gitignore
</span><span class="line">.mailmap
</span><span class="line">COPYING
</span><span class="line">Documentation/.gitignore
</span><span class="line">Documentation/Makefile
</span><span class="line">xdiff/xtypes.h
</span><span class="line">xdiff/xutils.c
</span><span class="line">xdiff/xutils.h
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ol>
  <li>
    <p>The index contains all the information necessary to generate a single (uniquely determined) tree object.</p>
  </li>
  <li>
    <p>The index enables fast comparisons between the tree object it defines and the working tree.</p>
  </li>
  <li>
    <p>It can efficiently represent information about merge conflicts between different tree objects.</p>
  </li>
</ol>

<h3 id="the-packfile-index">The Packfile Index</h3>

<p>Stored in <code>.git/objects/pack</code>.</p>

<p>Importantly, packfile indexes are not neccesary to extract objects from a packfile, they are simply used to quickly retrieve individual objects from a pack.</p>

<h3 id="raw-git">Raw Git</h3>

<p><strong>Creating Blobs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git <span class="nb">hash</span>-object -w myfile.txt
</span><span class="line">6ff87c4664981e4397625791c8ea3bbb5f2279a3
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Creating Trees</strong></p>

<p>use <code>git mktree</code>.</p>

<p><strong>Creating Commits</strong></p>

<p>use <code>git commit-tree</code>.</p>

<p><strong>Updating a Branch Ref</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span><span class="nb">echo</span> <span class="s1">&#39;a5f85ba5875917319471dfd98dfc636c1dc65650&#39;</span> &gt; .git/refs/heads/master
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>a safer way of doing that is to use the <code>git update-ref</code> command:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="sh"><span class="line"><span class="nv">$ </span>git update-ref refs/heads/master a5f85ba5875917319471dfd98dfc636c1dc65650
</span></code></pre></td></tr></table></div></figure></notextile></div>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review]  历史深处的忧虑]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/09/23/lin-da-li-shi-shen-chu-de-you-lu/"/>
    <updated>2014-09-23T22:25:49+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/09/23/lin-da-li-shi-shen-chu-de-you-lu</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>历史深处的忧虑</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>林达</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://book.douban.com/subject/25708714/">book.douban.com/subject/25708714</a></td>
    </tr>
  </tbody>
</table>

<p>中国人的“虐待”概念，带有很强的主观性和主动性。但是在美国，这只是一个法律概念，它是不考虑冬季，只察看行为和后果的。</p>

<h2 id="section">关于雇佣关系</h2>

<p>1964年的民权法。六十年代的美国民权运动的结果不仅是立法取消了种族隔离，它还使得自由派思潮广为流行。保护每一个人的平等权利的观念浮到了表层上，尤其是社会上的弱势群体，比如少数民族、妇女、残疾人等等，他们的权利受到了前所未有的关注。</p>

<p>1972年美国又制定了著名的平权法案，更规定了所有的政府机构和超过十五名雇员的私人企业，都必须在招工、技术培训、升迁等机会上，给弱势群体一定的比例。</p>

<p>1991年，美国再一次制定新的民权法案。把雇主和雇员在发生民权官司时，提供证据的负担重新放到雇主一边。</p>

<h2 id="section-1">关于权利法案</h2>

<p>我们在评论一件事情”好“还是”不好“的时候，他们经常只是简单地说：”这是合法的“以及“这是非法的”。</p>

<p>宪法确立了一个民主制度，宪法的修正案，尤其这个修正案的前十条，通常被称为权利法案的，保证了美国每一个”个人“最基本的权利不受侵犯。美国人认为，<strong>假如一个人最基本的权利能够得到保障，他就是自由的。</strong></p>

<p>1773年签署《独立宣言》，但是直到1783年，他们才打胜了这场以“生命、自由和追求幸福”的名义而举行的战争，英国终于签字承认了美国的独立。</p>

<p>《权利法案》旨在限制联邦政府权利的无限扩张，防止联邦政府干涉和剥夺美国人民的自由。从此宪法所支撑的美国变成了一个设计精巧的结构，政府和人民时时处于相互制约的状态之中。这个运转结构也是美国稳定的原因之一：政府时时处于强有力的监督之下，它就不容易在错误的道路上走得太远，甚至发生大滑坡；同时，人民有了充分的自由，他们有了表达意愿的渠道以及宣泄情绪的出口，也就不容易积怨之深从而产生爆发性的破坏力。</p>

<p>到1789年，美国宪法的前一部分才被通过。也就是说，美国打赢独立战争的六年之后，美国人法定的建国日十三年之后，美国政府才开始工作，才开始通过民主选举，选出他们的第一届总统华盛顿。</p>

<p>很多国家的宪法都有言论自由这一条，那么美国的《权利法案》有什么特殊的地方呢？它的特点就是规定了政府不得立法剥夺这种自由。</p>

<h2 id="section-2">关于第一修正案</h2>

<p>宪法第一修正案的关键就是：言论自由与真理完全无关。</p>

<p>马丁·路德·金认为“手段代表了在形成之中的理想和在进行之中的目的，人们无法通过邪恶的手段来达到美好的目的，因为手段是种子，目的是树”。</p>

<p>如何解决既维护言论自由的承诺，又惧怕言论引起的非法行为以及煽动暴力，甚至担心危及国家安全？</p>

<p>“清楚与现实的危险”测定原则。如果政府无法证明某一言论是造成了清楚与现实的危险，它就不能对该言论的发表者进行惩罚。</p>

<p>1969年重新规定了该原则：只有当一个言论所宣传的暴力，有可能直接煽起“迫在眉睫“的非法行动时，政府才有权干预。</p>

<p>我认为应该从教育中学习，不应该抑制任何声音。从最反面的人那里我也学到过东西。我可以不赞成某一观点，但是这并不意味着这一观点就不应该发表，或者说，我就不应该去听。</p>

<p>应该给三K党言论自由吗？斯蒂芬·潘佛回答到“如果你因为害怕一个不自由的时代，因此就不给他们言论自由的话，那么，这个不自由的时代已经开始了。是你自己给它开了头。”</p>

<p><strong>言论自由的关键是什么呢？</strong></p>

<p>关键就在于它的“内容中性“原则，就是要把“真理”二字坚决地摒弃在言论自由的大门之外。只要让“真理”二字一不小心从门缝里溜进来，言论自由就完了。为什么这样说呢？呼吁和宣扬言论自由的人们是很容易上“真理”的当的。他们或是明确认为，或是在潜意识中，总是觉得言论自由是走向“真理”的一条“阳光大道”，觉得言论自由只是让真理“越辩越明”的一种方式。在这种概念的指导下，一旦走到自己感觉已经“真理到手”的这一步，言论自由被抛弃就成了十分顺理成章的事儿。只要不坚持“内容中性”，只要以为言论自由的目的是为了追求真理，那么，就无法避免这样的情况发生：终有一日，在理论和现实上，都无法阻挡一个或数个权威在手的人物，或是一群所谓的“大多数”，出来把自己宣布为“真理”，而扼杀别人的言论自由。</p>

<p>克林顿对于俄克拉荷马爆炸案的一句评价：“这是针对美国，我们的生活方式以及我们所有信仰的攻击。”</p>

<p>政府的权利大，人民的权利必定受影响；政府的权利小，法律和秩序又不好保障。</p>

<p>分权，是横向把政府的权利切成两个大的层次，也就是把联邦政府和地方政府的权利分隔开。除了权利的横向分隔，宪法还把国家政府的权利从竖向切成三条，“三权分立”，立法（国会）、行政（总统）、司法（最高法院）的绝对独立。</p>

<p>“伟大的妥协”：国会的众议院以州人口比例确定议员的数量，而参议院则不论州的大小，每州两名议员，以确认小州的利益也有保障。</p>

<p>总统四年选一次，众议员两年选一次，参议员六年选一次。</p>

<p>最高法院的组成是九名大法官。这九名大法官由总统提名、经国会批准任命的，并且最高法院的大法官是终身制的。</p>

<p>新闻监督，免预检制度，由麦当娜催生出五秒滞后的预检限制。</p>

<p>新闻自由的主要意图就是防止对出版社的预先限制。即使是对于滥用新闻出版自由的人，也只能在事后，即出版之后适当惩罚，而不能预先阻止出版。</p>

<p>蒙哥马利市专管警察部门的一名政府官员，名叫沙利文，以诽谤罪告《纽约时报》和四名黑人牧师。由此，最高法院宣布了一条非常重要的原则：当公职人员遇到不实的批评而受到伤害的时候，他不能以诽谤罪要求赔偿金，除非他能够提出证据，证明这是出于“真是的恶意”。法庭同时也指出：在自由辩论中，发生失误是不可避免的，必须保护新闻界有“喘气的空间”，使他们有可能生存下去。</p>

<p>之后这条原则从“公职人员”扩大到了“公众人物”，而后再扩大到“卷入公众事务”的普通人。</p>

<h2 id="section-3">关于第二修正案</h2>

<p>保障了人民拥有枪的自由及保卫自由的能力。</p>

<p>在这个成分复杂的世界里，永远会有一部分人滥用自由。整个社会也就不得不为这种滥用自由的情况承担后果。</p>

<p>“二战”之前德国人民也是合法拥有武器的。但是在希特勒上台之后，首先搞枪支登记，然后设法逐步搞没收枪支。接着，犹太人面对武装的党卫队员，就只有束手待毙的份了。</p>

<h2 id="section-4">关于第三、四修正案</h2>

<p>私人财产不受侵犯是宪法第四修正案所保护的自由。</p>

<p>根据宪法第四修正案，最高法院早就有了“排斥原则”，这个原则认定，任何非法搜查的证据，都不能用于审理过程，任何在这个基础上的定罪都必须撤销。</p>

<p>在美国，所有人都知道，一个案子以胜诉终结，就是意味着另一个案子的开始。这非常有效地防止了美国政府的公职人员对平民的迫害，因为他们必须有所顾忌，一不当心的话，弄不好就是“搬起石头砸自己的脚”。</p>

<p>在这里发生一个民权案例的时候，各种民权机构以及许多平民，他们都会抛开对当事人个人的好恶，抛开对他的信念、言论、行为的好恶，去支持这个当事人保护自己的宪法权利。这个时候，他们看上去像是在共同守护一个堤坝，似乎一旦决堤就会一毁俱毁。</p>

<h2 id="section-5">关于第五、六、七修正案</h2>

<p>陪审团、审判相关。</p>

<p>“无罪假定”在美国的司法制度中是极为重要的一条。正是这一条，决定了检方和辩方从道义上的平等地位。正因为在审判之前，假定被告是无罪的，律师也就可以毫无心理负担，理直气壮的进行辩护。</p>

<p>如果检察官有任何抬高自己在道义上地位的迹象，比如说，宣称自己是伸张正义，而暗示辩护律师是为犯罪开脱等等，都是违反了“公平游戏”的原则，是严重犯规的行为。</p>

<p>警察的违规破案是否可行？《权利法案》的核心就是防止美国政府剥夺人民的自由和权力，如果以“成败论英雄”，那岂不是鼓励警察违反宪法。</p>

<p>陪审员被允许知道的东西，只限于法官判定可以让他们听到和看到的东西。</p>

<p>法官一般判定哪些“犯规”？与案情无关；还有一些诱导性的问题也是不允许的（不能先确定一个事实，问证人是不是这样）</p>

<p>提问的一方是在与证人对话，“抗议”的一方是在与法官对话，检辩双方一般是互相不对话的。一旦出现他们之间的对话，通常带有“争执”意味，法官会在这样的“苗子”刚刚冒出来的时候就马上叫停，有时会立即判处罚款。</p>

<p>在向证人提问时，也绝对不允许“争执”。与证人的全部对话只能以提问的形式出现。即使提问的一方发现证人明显是在那里说谎，他也不能直接对证人说，你这是说谎，因为这不仅已经不是“提问”，而且是一种“争执”。（所有律师都要有把肯定句变为疑问句的本事）</p>

<p>刑事法律有一个极其重要的原则，被告只要提出怀疑即可，不必作出证明，这叫做“没有证明的负担”；而相反，检方则必须提供证明以“超越合理的怀疑”，这叫做“具有证明的负担”，或者说“证明的负担在检方”。</p>

<p>不论陪审团最后作出什么样的裁决，是“罪名成立”也罢，是“罪名不成立”也罢，都必须是陪审团全体陪审员一致的意见。只要是意见不能取得一致，就意味着“无法做出裁决”，就必须宣判这一次的审判“宣告失败”。</p>

<p>在录音被公布之后，佛曼只引用了《权利法案》第五条中的一句话，就是人民“不得被强迫在任何刑事案件中自证其罪”。这一句也被扩大为：不能强迫一个人说出对自己不利的证词。</p>

<p>牺牲任何一个“个人”的自由权利以及家庭幸福，以此作为换取社会利益的代价，这种做法的合理性是不被美国宪法精神所承认的。它不承认任何一种社会要求可以高于一个公民对于自由幸福和合法权利的要求。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[How to use Mock and Stub in Minitest and Rspec?]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/09/23/how-to-use-mock-and-stub-in-minitest-and-rspec/"/>
    <updated>2014-09-23T20:14:24+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/09/23/how-to-use-mock-and-stub-in-minitest-and-rspec</id>
    <content type="html"><![CDATA[<p>Referenced in <a href="http://blog.arvidandersson.se/2012/03/28/minimalicous-testing-in-ruby-1-9">Minimalicious testing in Ruby 1.9 with MiniTest</a></p>

<ul>
  <li>A <strong>stub object</strong> is a pretend object that implement some of the interface of the object it pretends to be and returns predefined responses. </li>
  <li>A <strong>mock object</strong> is similair to a stub but has another use case: <em>it helps decide if the test case it is used in passes by verifying if it’s methods has been called or not.</em></li>
</ul>

<h2 id="minitestmock">Minitest::Mock</h2>

<p><code>require 'minitest/mock'</code></p>

<p><em>stub</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Mock</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;Minitest::Mock:0x82ff7b5c&gt;</span>
</span><span class="line"><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:hi</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;Minitest::Mock:0x82ff7b5c&gt;</span>
</span><span class="line"><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">hi</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>mock</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="mi">5</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">bar</span> <span class="o">=</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Mock</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;Minitest::Mock:0x821763e4&gt;</span>
</span><span class="line"><span class="o">[</span><span class="mi">6</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">bar</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="ss">:hi</span><span class="p">,</span> <span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;arg1&#39;</span><span class="p">,</span> <span class="s1">&#39;arg2&#39;</span><span class="o">]</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;Minitest::Mock:0x821763e4&gt;</span>
</span><span class="line"><span class="o">[</span><span class="mi">7</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">bar</span><span class="o">.</span><span class="n">verify</span>
</span><span class="line"><span class="ss">MockExpectationError</span><span class="p">:</span> <span class="n">expected</span> <span class="n">hi</span><span class="p">(</span><span class="s2">&quot;arg1&quot;</span><span class="p">,</span> <span class="s2">&quot;arg2&quot;</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="n">got</span> <span class="o">[]</span>
</span><span class="line"><span class="o">[</span><span class="mi">8</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">bar</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s1">&#39;arg1&#39;</span><span class="p">,</span> <span class="s1">&#39;arg2&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span>
</span><span class="line"><span class="o">[</span><span class="mi">9</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">bar</span><span class="o">.</span><span class="n">verify</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="rspecmocks">RSpec::Mocks</h2>

<p><code>require 'rspec/mocks/standalone'</code></p>

<p><em>stub</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="mi">2</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">double</span><span class="p">()</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;RSpec::Mocks::Mock:0x82c66b78 @name=nil&gt;</span>
</span><span class="line"><span class="o">[</span><span class="mi">3</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:hi</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class="line"><span class="o">[</span><span class="mi">4</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">hi</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="s2">&quot;hello&quot;</span>
</span><span class="line"><span class="o">[</span><span class="mi">7</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">stub</span><span class="p">(</span><span class="ss">:hi</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">and_return</span><span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class="line"><span class="o">[</span><span class="mi">9</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">hi</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="s2">&quot;hello world&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>mock</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="mi">18</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span> <span class="o">=</span> <span class="n">double</span><span class="p">()</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;RSpec::Mocks::Mock:0x82c66b78 @name=nil&gt;</span>
</span><span class="line"><span class="o">[</span><span class="mi">19</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">foo</span><span class="o">.</span><span class="n">should_receive</span><span class="p">(</span><span class="ss">:hi</span><span class="p">)</span><span class="o">.</span><span class="n">with</span><span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">)</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="c1">#&lt;RSpec::Mocks::MessageExpectation:0x818c11f4&gt;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="reference">Reference</h3>

<ul>
  <li><a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/minitest/rdoc/MiniTest/Mock.html">Minitest::Mock</a></li>
  <li><a href="https://www.relishapp.com/rspec/rspec-mocks/v/2-3/docs/method-stubs">Rspec Mocks</a></li>
</ul>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[ASCIIcast of Fundamentals of Design by CodeSchool]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/06/22/asciicast-of-fundamentals-of-design-by-codeschool/"/>
    <updated>2014-06-22T23:35:39+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/06/22/asciicast-of-fundamentals-of-design-by-codeschool</id>
    <content type="html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#typeface-classifications">Typeface Classifications</a>    <ul>
      <li><a href="#typefaces">Typefaces</a></li>
      <li><a href="#principles">Principles</a></li>
    </ul>
  </li>
  <li><a href="#font-size-leading--weights">Font Size, Leading &amp; Weights</a></li>
  <li><a href="#line-width--widows">Line-Width &amp; Widows</a>    <ul>
      <li><a href="#line-width-is-measured-in-cpl">Line Width Is Measured in CPL</a></li>
      <li><a href="#save-the-orphans--widows">Save the Orphans &amp; Widows.</a></li>
    </ul>
  </li>
  <li><a href="#color-theory">Color Theory</a>    <ul>
      <li><a href="#hsl">HSL</a></li>
    </ul>
  </li>
  <li><a href="#color-scheme">Color Scheme</a>    <ul>
      <li><a href="#colors">Colors</a></li>
      <li><a href="#schemes">Schemes</a></li>
    </ul>
  </li>
  <li><a href="#color--type">Color &amp; Type</a></li>
  <li><a href="#basic-layout">Basic Layout</a></li>
  <li><a href="#the-grid">The Grid</a>    <ul>
      <li><a href="#fixed-or-fluid">Fixed or Fluid</a></li>
      <li><a href="#example">Example</a></li>
    </ul>
  </li>
  <li><a href="#whitespce--balance">Whitespce &amp; Balance</a></li>
</ul>

<h2 id="typeface-classifications">Typeface Classifications</h2>

<p>Content is king.</p>

<p>What’s your audience?</p>

<p>Find the typeface suits the content well.</p>

<h3 id="typefaces">Typefaces</h3>

<p><strong>Serif</strong></p>

<ul>
  <li>
    <p>Humanist Serif, suits for journalism or historical applications.</p>

    <p><img src="https://www.dropbox.com/s/8dpt1vw1senig4o/vlcsnap-2014-06-13-14h32m05s237.png?dl=1" alt="Humanist Serif" /></p>
  </li>
  <li>
    <p>Transitional Serif, suits for traditional academia or legal applications.</p>

    <p><img src="https://www.dropbox.com/s/2206u036n1clj0m/vlcsnap-2014-06-13-14h32m25s106.png?dl=1" alt="Transitional Serif" /></p>
  </li>
  <li>
    <p>Modern Serif, suits for arts or culture applications.</p>

    <p><img src="https://www.dropbox.com/s/nw37ut471ydku6r/vlcsnap-2014-06-13-14h32m36s248.png?dl=1" alt="Modern Serif" /></p>
  </li>
  <li>
    <p>Egyptian (Slab Serif), suits for marketing or promotional applications.</p>

    <p><img src="https://www.dropbox.com/s/uid95y9zkwud13g/vlcsnap-2014-06-13-14h32m57s247.png?dl=1" alt="Egyptian (Slab Serif)" /></p>
  </li>
</ul>

<p><strong>Sans-Serif</strong></p>

<p><em>Sans</em> is the French word for without.</p>

<ul>
  <li>
    <p>Humanist Sans Serif, suits for government or educational applications.  </p>

    <p><img src="https://www.dropbox.com/s/ih12v7cqfolk4ev/vlcsnap-2014-06-13-14h39m01s9.png?dl=1" alt="Humanist Sans Serif" /></p>
  </li>
  <li>
    <p>Transitional Sans Serif, suits for technology or transportation applications.</p>

    <p><img src="https://www.dropbox.com/s/xmb9ynyxq4rz0p2/vlcsnap-2014-06-13-15h16m50s201.png?dl=1" alt="Transitional Sans Serif" /></p>
  </li>
  <li>
    <p>Geometric Sans Serif, suits for science or architecture applications.</p>

    <p><img src="https://www.dropbox.com/s/c2d37eourvgzpv7/vlcsnap-2014-06-13-14h42m35s95.png?dl=1" alt="Geometric Sans Serif" /></p>
  </li>
</ul>

<p><strong>script</strong></p>

<p>Difficult to read, don’t use in body copy.</p>

<p><em>Comic Sans</em> is a script font, not a Sans Serif font. Maybe don’t use it everywhere.</p>

<h3 id="principles">Principles</h3>

<p>Don’t choose two fonts from the same style.</p>

<p><img src="https://www.dropbox.com/s/dxuoaanf7dp453y/vlcsnap-2014-06-13-14h44m57s130.png?dl=1" alt="p1" /></p>

<p>Don’t choose two fonts from the same class.</p>

<p><img src="https://www.dropbox.com/s/lkg7f2o4vtpqk3i/vlcsnap-2014-06-13-14h46m49s85.png?dl=1" alt="p2" /></p>

<p>When mixing classes, find a similar trait using fonts that share one thing in common but are otherwise different.</p>

<p><img src="https://www.dropbox.com/s/elu59eddvnu2pvr/vlcsnap-2014-06-13-14h48m11s213.png?dl=1" alt="p3" />
<img src="https://www.dropbox.com/s/9yonlu6rod30ybx/vlcsnap-2014-06-13-14h48m23s225.png?dl=1" alt="p4" /></p>

<p>Contrast over Harmony. Keep it the same or change it a lot, look for emphatic differences rather than mushy transitions.</p>

<p><img src="https://www.dropbox.com/s/ji0zx7v0kif5buc/vlcsnap-2014-06-13-14h48m52s15.png?dl=1" alt="p5" /></p>

<h2 id="font-size-leading--weights">Font Size, Leading &amp; Weights</h2>

<p><img src="https://www.dropbox.com/s/26lvgz1uyheudam/vlcsnap-2014-06-13-16h19m36s197.png?dl=1" alt="Establish Visual Hierarchy" /></p>

<p>Establish visual relationships between elements on the page is going to allow your users to more quickly process the information.</p>

<p>Use different font size. Huge size is annoying, and 16px is good by suggestion.</p>

<p><img src="https://www.dropbox.com/s/9em7t7q70jhb709/vlcsnap-2014-06-13-16h21m38s168.png?dl=1" alt="Font Size" /></p>

<p>Leading is around 120% to 150% of the body copy size.</p>

<p><img src="https://www.dropbox.com/s/1nnn9pnvqj3rma1/vlcsnap-2014-06-13-16h22m48s94.png?dl=1" alt="Leading" /></p>

<h2 id="line-width--widows">Line-Width &amp; Widows</h2>

<h3 id="line-width-is-measured-in-cpl">Line Width Is Measured in CPL</h3>

<blockquote>
  <p>Robert Bringhurst in “The elements of Typographic style” recommends 45 to 75 characters per line, 66 characters per line is widely considered the ideal. A width of 600px will hold around 75 characters of 18px text.</p>
</blockquote>

<p>Use <code>max-width</code> to control CPL.</p>

<p><img src="https://www.dropbox.com/s/3lmavcczrk9s41r/vlcsnap-2014-06-13-16h40m13s48.png?dl=1" alt="CPL" /></p>

<h3 id="save-the-orphans--widows">Save the Orphans &amp; Widows.</h3>

<p><img src="https://www.dropbox.com/s/nrromwg0ozc5b16/vlcsnap-2014-06-13-16h56m47s155.png?dl=1" alt="widow" /></p>

<p><img src="https://www.dropbox.com/s/18xj5apbq3hrlwf/vlcsnap-2014-06-13-16h57m24s123.png?dl=1" alt="orphan" /></p>

<p>No perfect solution.  </p>

<p>Try tweaking with the font size, weight, line width, and leading to fix the problem.</p>

<h2 id="color-theory">Color Theory</h2>

<ul>
  <li>
    <p>Subtractive Color, using CMYK (Cyan, Megenta, Yellow) color space.</p>

    <p><img src="https://www.dropbox.com/s/6mm2nl7dechq2z5/vlcsnap-2014-06-15-08h25m21s91.png?dl=1" alt="CMYK" /></p>
  </li>
  <li>
    <p>Additive Color, using RGB spectrum.</p>

    <p><img src="https://www.dropbox.com/s/easxunlr4c64opi/vlcsnap-2014-06-15-08h25m57s202.png?dl=1" alt="RGB" /></p>
  </li>
</ul>

<h3 id="hsl">HSL</h3>

<p>RGB is hard, while human process HSL. Hue, Saturation, Lightness.</p>

<p><strong>Hue</strong></p>

<p><img src="https://www.dropbox.com/s/9872tl0uvqx3vaw/vlcsnap-2014-06-15-08h27m27s79.png?dl=1" alt="hue" /></p>

<p><strong>Saturation</strong></p>

<p><img src="https://www.dropbox.com/s/f2aml0jjak4fhe2/vlcsnap-2014-06-15-08h28m27s178.png?dl=1" alt="staturation" /></p>

<p><strong>Lightness</strong></p>

<p><img src="https://www.dropbox.com/s/4f88kprtkoaua44/vlcsnap-2014-06-15-08h28m33s232.png?dl=1" alt="lightness" /></p>

<p>Example</p>

<p><img src="https://www.dropbox.com/s/kkbabl1ou5jut80/vlcsnap-2014-06-15-08h28m43s70.png?dl=1" alt="hsl example" /></p>

<p><strong>How to use?</strong></p>

<p><img src="https://www.dropbox.com/s/wurqrpjx0lxv7ft/vlcsnap-2014-06-15-08h29m20s189.png?dl=1" alt="use1" /></p>

<p><img src="https://www.dropbox.com/s/vdhldtjypl1c45c/vlcsnap-2014-06-15-08h29m22s214.png?dl=1" alt="use2" /></p>

<p><img src="https://www.dropbox.com/s/skfqyxi2tekvrda/vlcsnap-2014-06-15-08h29m37s111.png?dl=1" alt="use3" /></p>

<p><strong>What about HSB, B for brightness?</strong></p>

<p><img src="https://www.dropbox.com/s/btfl63w63dgvxkk/vlcsnap-2014-06-15-08h29m45s191.png?dl=1" alt="hsb" /></p>

<h2 id="color-scheme">Color Scheme</h2>

<p>Start by selecting a Base Color.</p>

<p>Keep Culture in Mind.</p>

<p>Build Scheme around Base Color.</p>

<h3 id="colors">Colors</h3>

<p><img src="https://www.dropbox.com/s/c0xlct808u0egfs/%E6%9C%AA%E5%91%BD%E5%90%8D_meitu_0.jpg?dl=1" alt="colors" /></p>

<h3 id="schemes">Schemes</h3>

<p><strong>Monochromatic</strong></p>

<p><img src="https://www.dropbox.com/s/0zegfh6r5pew0ny/vlcsnap-2014-06-15-13h30m23s77.png?dl=1" alt="monochromatic" /></p>

<p><strong>Analogous</strong></p>

<p>Analogous color schemes require you have colors with hues that both ascend and descend equally on either side of the base color. They also should be less than 40 degrees from the base.</p>

<p><img src="https://www.dropbox.com/s/vtapllnhbe21v5u/vlcsnap-2014-06-15-13h32m19s227.png?dl=1" alt="analogous" /></p>

<p><strong>Complementary</strong></p>

<p><img src="https://www.dropbox.com/s/g4nscjzi025rlxe/vlcsnap-2014-06-15-13h32m17s204.png?dl=1" alt="complementary" />
<img src="https://www.dropbox.com/s/dif5r4pj3u4f1rg/vlcsnap-2014-06-15-13h31m11s38.png?dl=1" alt="complementary2" /></p>

<p>Don’t have to be perfect. Use the methods to tweak as needed to fit your project.</p>

<h2 id="color--type">Color &amp; Type</h2>

<p>Typography must have a high degree of contrast between it and its background.</p>

<p>Black and white are the best.</p>

<p><img src="https://www.dropbox.com/s/aqgc6u6z8q6s76r/vlcsnap-2014-06-15-21h17m52s0.png?dl=1" alt="black and white" /></p>

<p>Colors that are the same hue but have a very high saturation and lightness contrast are a close second.</p>

<p><img src="https://www.dropbox.com/s/5h1b8ly733u2tfo/vlcsnap-2014-06-15-21h17m54s23.png?dl=1" alt="same hue" /></p>

<p>Some colors are intrinsically difficult for humans to distinguish, such as red, green, blue, and orange.</p>

<p><img src="https://www.dropbox.com/s/xt5sz3qp1q48mit/vlcsnap-2014-06-15-21h19m05s218.png?dl=1" alt="hard distinguish" /></p>

<p>Some colors are light colors, warm colors, like yellow, and some colors are dark colors, cool colors, like blue. So creating contrast in which the yellow is darker than the blue creates a very awkward experience.</p>

<p><img src="https://www.dropbox.com/s/nm0c0nr68wvf4nl/vlcsnap-2014-06-15-21h22m13s51.png?dl=1" alt="light and dark colors" /></p>

<p><img src="https://www.dropbox.com/s/pebe0b2kcvf6ak4/vlcsnap-2014-06-15-21h21m01s107.png?dl=1" alt="yellow and blue" /></p>

<p>Making yellow light, and blue dark is much more legible.</p>

<p><img src="https://www.dropbox.com/s/kmpd6cgbr8we42v/vlcsnap-2014-06-15-21h22m00s181.png?dl=1" alt="legible colors" /></p>

<p>Warm and cool colors can be used to create depth, as warm colors appear closer to the screen or to the user. So use cool colors as the background and warm colors as the foreground.</p>

<p><img src="https://www.dropbox.com/s/a8rf1a4mt3stsb2/vlcsnap-2014-06-15-21h23m52s24.png?dl=1" alt="warm colors are closer to the user" /></p>

<p>You should combine colors to reinforce <strong>Visual Hierarchy</strong>. As an example, the CodeSchool website get progressively darker as you scroll, which anchors the page and create a more stable viewing experience.</p>

<p><img src="https://www.dropbox.com/s/nu4btrmzrw5xi0n/vlcsnap-2014-06-15-21h35m30s84.png?dl=1" alt="codeschool" /></p>

<p>Dont’ be tacky. And treat the image behind the text to make it stand out. </p>

<p><img src="https://www.dropbox.com/s/ujn4xfnha8kcq9e/vlcsnap-2014-06-15-21h29m29s200.png?dl=1" alt="Treat image behind text" /></p>

<h2 id="basic-layout">Basic Layout</h2>

<p><img src="https://www.dropbox.com/s/7kk0h969n7deob1/vlcsnap-2014-06-17-13h40m49s203.png?dl=1" alt="layout1" /></p>

<p><img src="https://www.dropbox.com/s/hpzsgrw3dumdspd/vlcsnap-2014-06-17-13h40m57s24.png?dl=1" alt="layout2" /></p>

<p><img src="https://www.dropbox.com/s/5vfogp9jvplgajb/vlcsnap-2014-06-17-13h41m06s122.png?dl=1" alt="layout3" /></p>

<p>Reinforces the <strong>Visual Hierarchy</strong>.</p>

<p><img src="https://www.dropbox.com/s/uuf91hcg23xlblf/vlcsnap-2014-06-17-13h41m23s22.png?dl=1" alt="layout4" /></p>

<p><img src="https://www.dropbox.com/s/7gkg2anbmg3tfhz/vlcsnap-2014-06-17-13h43m31s29.png?dl=1" alt="layout5" /></p>

<p><img src="https://www.dropbox.com/s/uum2iooo7ko6bn3/vlcsnap-2014-06-17-13h47m26s72.png?dl=1" alt="layout6" /></p>

<h2 id="the-grid">The Grid</h2>

<p>It is made up of a system of horizontal and vetical lines.</p>

<ul>
  <li>
    <p>The vertical lines create columns with gutters in between them that are used to proportionally distribute elements across the page.</p>

    <p><img src="https://www.dropbox.com/s/tvmsme4tsvmu5lq/vlcsnap-2014-06-21-02h29m42s176.png?dl=1" alt="vertical lines" /></p>

    <p>Avoid clutter by respecting the gutters. Don’t put design elements or type in between the columns.</p>

    <p><img src="https://www.dropbox.com/s/dgn6il3m17asxdb/vlcsnap-2014-06-21-02h41m13s209.png?dl=1" alt="avoid clutter" /></p>
  </li>
  <li>
    <p>The horizontal lines are used to create a baseline for text that shoudl be equal to the line height.</p>

    <p><img src="https://www.dropbox.com/s/nmqltmky7rx16e2/vlcsnap-2014-06-21-02h30m23s114.png?dl=1" alt="horizontal lines" /></p>
  </li>
</ul>

<p>Use them in Photoshop or another graphics software as a reference when designing.</p>

<h3 id="fixed-or-fluid">Fixed or Fluid</h3>

<ul>
  <li>
    <p>With a fixed grid, the browser can get bigger or smaller, and the grid will remain constant.</p>
  </li>
  <li>
    <p>With a fluid grid, it grows or shrinks with the browser window. And columns are either added or dropped to better serve that size.</p>
  </li>
</ul>

<h3 id="example">Example</h3>

<p><img src="https://www.dropbox.com/s/ndabm6ddf0sd6ts/vlcsnap-2014-06-21-02h38m41s189.png?dl=1" alt="the grid1" /></p>

<p><img src="https://www.dropbox.com/s/00mrqaelqww8qdi/vlcsnap-2014-06-21-02h38m44s7.png?dl=1" alt="the grid2" /></p>

<h2 id="whitespce--balance">Whitespce &amp; Balance</h2>

<p>Balance all the things.</p>

<p><strong>Symmetry</strong></p>

<p><strong>Asymmetry</strong></p>

<p>All of the principles together contribute to balance.</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Inside ActiveSupport Notifications]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/06/03/inside-activesupport-notifications/"/>
    <updated>2014-06-03T00:45:35+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/06/03/inside-activesupport-notifications</id>
    <content type="html"><![CDATA[<ul id="markdown-toc">
  <li><a href="#preparation">Preparation</a></li>
  <li><a href="#activesupportnotifications">ActiveSupport::Notifications</a>    <ul>
      <li><a href="#file-name">File name</a></li>
      <li><a href="#dependency">Dependency</a></li>
      <li><a href="#brief">Brief</a></li>
      <li><a href="#specification">Specification</a>        <ul>
          <li><a href="#class-variables">Class Variables</a></li>
          <li><a href="#class-methods">Class Methods</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#activesupportnotificationsfanout">ActiveSupport::Notifications::Fanout</a>    <ul>
      <li><a href="#file-name-1">File name</a></li>
      <li><a href="#dependency-1">Dependency</a></li>
      <li><a href="#brief-1">Brief</a></li>
      <li><a href="#specification-1">Specification</a>        <ul>
          <li><a href="#instance-variables">Instance Variables</a></li>
          <li><a href="#instance-methods">Instance Methods</a></li>
          <li><a href="#modules">Modules</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#activesupportnotificationsinstrumenter">ActiveSupport::Notifications::Instrumenter</a>    <ul>
      <li><a href="#file-name-2">File name</a></li>
      <li><a href="#dependency-2">Dependency</a></li>
      <li><a href="#brief-2">Brief</a></li>
      <li><a href="#specification-2">Specification</a>        <ul>
          <li><a href="#instance-variables-1">Instance Variables</a></li>
          <li><a href="#instance-methods-1">Instance Methods</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#activesupportnotificationsevent">ActiveSupport::Notifications::Event</a>    <ul>
      <li><a href="#file-name-3">File name</a></li>
      <li><a href="#dependency-3">Dependency</a></li>
      <li><a href="#specification-3">Specification</a></li>
    </ul>
  </li>
  <li><a href="#main-working-flow">Main Working Flow</a>    <ul>
      <li><a href="#activesupportnotificationssubscribe">ActiveSupport::Notifications.subscribe</a></li>
      <li><a href="#activesupportnotificationsinstrument">ActiveSupport::Notifications.instrument</a></li>
    </ul>
  </li>
  <li><a href="#misc">MISC</a></li>
  <li><a href="#reference">Reference</a></li>
</ul>

<h2 id="preparation">Preparation</h2>

<ul>
  <li>Read API doc first, <a href="ActiveSupport::Notifications">ActiveSupport::Notifications</a>.</li>
  <li>About hooks inside Rails for instrumentation, check the edge doc on <a href="http://edgeguides.rubyonrails.org/active_support_instrumentation.html">Active Support Instrumentation</a>.</li>
</ul>

<p>Then let’s read through the <strong>ActiveSupport::Notifications</strong> source code.</p>

<h2 id="activesupportnotifications">ActiveSupport::Notifications</h2>

<h3 id="file-name">File name</h3>

<p><a href="https://github.com/rails/rails/blob/master/activesupport%2Flib%2Factive_support%2Fnotifications.rb">activesupport/lib/active_support/notifications.rb</a></p>

<h3 id="dependency">Dependency</h3>

<ul>
  <li><code>active_support/notifications/instrumenter</code></li>
  <li><code>active_support/notifications/fanout</code></li>
  <li><code>active_support/per_thread_registry</code></li>
</ul>

<h3 id="brief">Brief</h3>

<ol>
  <li>A class attribute accessor <code>notifier</code>, which is initialized by <code>Fanout.new</code>.</li>
  <li>Several class methods as the interfaces exposed, which encapsulate <code>notifer</code> to do the real work.</li>
  <li>A class named <strong>InstrumentationRegistry</strong>.</li>
</ol>

<h3 id="specification">Specification</h3>

<h4 id="class-variables">Class Variables</h4>

<p><code>self.notifier = Fanout.new</code></p>

<h4 id="class-methods">Class Methods</h4>

<ul>
  <li>
    <p><code>subscribe</code>, <code>unsubscribe</code> and <code>publish</code> all delegate to <code>notifier</code>, like</p>

    <p><code>ruby
  def subscribe(*args, &amp;block)
    notifier.subscribe(*args, &amp;block)
  end
 </code></p>
  </li>
  <li>
    <p><code>subscribed(callback, *args, &amp;block)</code>, <code>subscribe</code> while <code>block</code> is running, and <code>unsubscribe</code> while running is over.</p>

    <p><code>ruby
  def subscribed(callback, *args, &amp;block)
    subscriber = subscribe(*args, &amp;callback)
    yield
  ensure
    unsubscribe(subscriber)
  end
 </code></p>
  </li>
  <li>
    <p><code>instrument(name, payload = {})</code></p>

    <p><code>ruby
  def instrument(name, payload = {})
    if notifier.listening?(name)
      instrumenter.instrument(name, payload) { yield payload if block_given? }
    else
      yield payload if block_given?
    end
  end
 </code></p>
  </li>
</ul>

<p><code>notifier.listening?(name)</code> is checking if there are subscribers listening on the event name.</p>

<p><strong><em>And what’s an instrumenter?</em></strong></p>

<p>Check out the <strong>ActiveSupport::Notifications::Instrumenter</strong> below or skip this part temporally.</p>

<p>Let’s talk about <strong>InstrumentationRegistry</strong> first, it is a sub-class defined in <strong>ActiveSupport::Notifications</strong>. It extends <strong>ActiveSupport::PerThreadRegistry</strong> to keep thread safe, and defines <code>#instrumenter_for</code> used for recording <strong>Instrumenter</strong> instance for specific <code>notifier</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># This class is a registry which holds all of the +Instrumenter+ objects</span>
</span><span class="line"><span class="c1"># in a particular thread local. To access the +Instrumenter+ object for a</span>
</span><span class="line"><span class="c1"># particular +notifier+, you can call the following method:</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1">#   InstrumentationRegistry.instrumenter_for(notifier)</span>
</span><span class="line"><span class="c1">#</span>
</span><span class="line"><span class="c1"># The instrumenters for multiple notifiers are held in a single instance of</span>
</span><span class="line"><span class="c1"># this class.</span>
</span><span class="line"><span class="k">class</span> <span class="nc">InstrumentationRegistry</span> <span class="c1"># :nodoc:</span>
</span><span class="line">  <span class="kp">extend</span> <span class="ss">ActiveSupport</span><span class="p">:</span><span class="ss">:PerThreadRegistry</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@registry</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">instrumenter_for</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@registry</span><span class="o">[</span><span class="n">notifier</span><span class="o">]</span> <span class="o">||=</span> <span class="no">Instrumenter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Then look back in <strong>ActiveSupport::Notifications</strong> for its usage:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">instrumenter</span>
</span><span class="line">  <span class="no">InstrumentationRegistry</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">instrumenter_for</span><span class="p">(</span><span class="n">notifier</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Extending <strong>ActiveSupport::PerThreadRegistry</strong> gives <strong>InstrumentationRegistry</strong> the <code>instance</code> class methods, returns a thread local <strong>InstrumentationRegistry</strong> instance. Check the <strong>ActiveSupport::PerThreadRegistry</strong> <a href="http://api.rubyonrails.org/classes/ActiveSupport/PerThreadRegistry.html">api</a> for details.</p>

<h2 id="activesupportnotificationsfanout">ActiveSupport::Notifications::Fanout</h2>

<h3 id="file-name-1">File name</h3>

<p><a href="https://github.com/rails/rails/blob/master/activesupport%2Flib%2Factive_support%2Fnotifications%2Ffanout.rb">activesupport/lib/active_support/notifications/fanout.rb</a></p>

<h3 id="dependency-1">Dependency</h3>

<ul>
  <li><code>mutex_m</code>, a Ruby Std-lib module. <a href="http://www.ruby-doc.org/stdlib-2.1.2//libdoc/mutex_m/rdoc/Mutex_m.html">api</a></li>
  <li><code>thread_safe</code>, a collection of thread-safe versions of common core Ruby classes. <a href="https://github.com/headius/thread_safe">api</a></li>
</ul>

<h3 id="brief-1">Brief</h3>

<p>This is a default queue implementation that ships with Notifications. It just pushes events to all registered log subscribers.</p>

<p>This class is thread safe. All methods are reentrant.</p>

<h3 id="specification-1">Specification</h3>

<h4 id="instance-variables">Instance Variables</h4>

<p><code>@subscribers</code>, an array, records the subscribers.</p>

<p><code>@listeners_for</code>, a reverse map(hash). It maps the event name to the subscribers. Initialized by <code>ThreadSafe::Cache.new</code>, <a href="https://github.com/headius/thread_safe">thread_safe</a> gem says:</p>

<blockquote>
  <p><code>ThreadSafe::Cache</code> also exists, as a hash-like object, and should have
much better performance characteristics esp. under high concurrency than
<code>ThreadSafe::Hash</code>. However, <code>ThreadSafe::Cache</code> is not strictly semantically
equivalent to a ruby <code>Hash</code> – for instance, it does not necessarily retain
ordering by insertion time as <code>Hash</code> does. For most uses it should do fine
though, and we recommend you consider <code>ThreadSafe::Cache</code> instead of
<code>ThreadSafe::Hash</code> for your concurrency-safe hash needs. It understands some
options when created (depending on your ruby platform) that control some of the
internals.</p>
</blockquote>

<h4 id="instance-methods">Instance Methods</h4>

<ul>
  <li>
    <p><code>subscribe(pattern = nil, block = Proc.new)</code></p>

    <p><code>ActiveSupport::Notifications.subscribe</code> use this method on <code>notifier</code> to subscribe event name based on <code>pattern</code> and a <code>block</code> to do the instrumentation callback.</p>

    <p>It initialize a <em>subscriber</em> with <code>Subscribers.new pattern, block</code>, use <code>synchronize</code>(for thread safe) to record <em>subscriber</em> into <code>@subscribers</code>, and clear the <code>@listeners_for</code>, then returns the <em>subscriber</em>.</p>

    <p><code>ruby
  def subscribe(pattern = nil, block = Proc.new)
    subscriber = Subscribers.new pattern, block
    synchronize do
      @subscribers &lt;&lt; subscriber
      @listeners_for.clear
    end
    subscriber
  end
 </code></p>
  </li>
  <li>
    <p><code>unsubscribe(subscriber)</code></p>

    <p><code>ruby
  synchronize do
    @subscribers.reject! { |s| s.matches?(subscriber) }
      @listeners_for.clear
    end
  end
 </code></p>

    <p>Note the <code>matches?</code> method on subscriber. Every subscriber object defines this method, <strong>Subscribers::Evented</strong> and <strong>Subscribers::Timed</strong> defines it like this:</p>

    <p><code>ruby
  def matches?(subscriber_or_name)
    self === subscriber_or_name ||
      @pattern &amp;&amp; @pattern === subscriber_or_name
  end
 </code></p>

    <p>Unsubscribe a subscriber object or unsubscribe based on the <code>@pattern</code> matching.</p>

    <p><strong>Subscribers::AllMessages</strong> alias <code>matches?</code> to <code>===</code>, just do the type matching.</p>
  </li>
  <li>
    <p><code>start</code>, <code>finish</code>, <code>publish(name, id, payload)</code></p>

    <p>just delegates to subscribers based on the event name.</p>

    <p><code>ruby
  def start(name, id, payload)
    listeners_for(name).each { |s| s.start(name, id, payload) }
  end
 </code></p>
  </li>
  <li>
    <p><code>listeners_for(name)</code></p>

    <p>a helper method, equals fetch or set on <code>@listeners_for</code>, returns the subscribers based on the event name.</p>

    <p><code>ruby
  def listeners_for(name)
    # this is correctly done double-checked locking (ThreadSafe::Cache's lookups have volatile semantics)
    @listeners_for[name] || synchronize do
      # use synchronisation when accessing @subscribers
      @listeners_for[name] ||= @subscribers.select { |s| s.subscribed_to?(name) }
    end
  end
 </code></p>
  </li>
  <li>
    <p><code>listening?(name)</code></p>

    <p>a helper method, checks if <code>listeners_for(name).any?</code>.</p>
  </li>
  <li>
    <p><code>wait</code></p>

    <p>as this is a sync queue, this method is left blank.</p>
  </li>
</ul>

<h4 id="modules">Modules</h4>

<ul>
  <li>
    <p><strong>Subscribers</strong></p>

    <p><strong>Subscribers</strong> defines a class method <code>new</code> and three sub-classes: <strong>Evented</strong>, <strong>Timed</strong>, and <strong>AllMessages</strong>. <strong>Timed</strong> inheritates <strong>Evented</strong>, and <strong>AllMessages</strong> encapsulates an <strong>Evented</strong> object.</p>

    <p>About <code>self.new(pattern, listener)</code>, remember where does <code>Subscribers.new</code> get called?</p>

    <p>It’s in <code>Fanout#subscribe(pattern = nil, block = Proc.new)</code>. If the <code>block</code> can duck-typing <code>:start</code> and <code>:finish</code>, it’ll initialize a subscriber by <strong>Evented</strong> with <code>pattern</code> and <code>block</code> recorded, otherwise by <strong>Timed</strong>. And if <code>pattern</code> is nil, which means calling <code>ActiveSupport::Notifications.subscribe</code> without event name, <code>Subscribers.new</code> returns an <strong>AllMessages</strong> object which initialized with a subscriber defined above. Otherwise(if <code>pattern</code> presents) returns a subscriber directly.</p>

    <p>Normally we use <code>ActiveSupport::Notifications.subscribe</code> in two ways:</p>

    <ul>
      <li>subscribe all events, which means no <code>pattern</code> passed, and a <strong>Subscribers::AllMessages</strong> instance saved.</li>
      <li>the <code>block</code> we pass to <code>ActiveSupport::Notifications.subscribe</code> won’t respond to <code>start</code> and <code>finish</code>, which means a <strong>Subscribers::Timed</strong> instance saved.</li>
    </ul>

    <p>These two ways have no conflicts: if passing a nil pattern and a block, it just returns an <strong>Subscribers::AllMessages</strong> instance which has a <strong>Subscribers::Timed</strong> instance wrapped.</p>

    <p>So let’s check it out what does a <strong>Subscribers::Timed</strong> instance respond?</p>

    <p>&#8220;`ruby
  def start(name, id, payload)
    timestack = Thread.current[:_timestack] ||= []
    timestack.push Time.now
  end</p>

    <p>def finish(name, id, payload)
    timestack = Thread.current[:_timestack]
    started = timestack.pop
    @delegate.call(name, started, Time.now, id, payload)
  end</p>

    <p>def publish(name, *args)
    @delegate.call name, *args
  end</p>

    <p>def subscribed_to?(name)
    @pattern === name.to_s
  end</p>

    <p>def matches?(subscriber_or_name)
    self === subscriber_or_name ||
      @pattern &amp;&amp; @pattern === subscriber_or_name
  end
  &#8220;`</p>
  </li>
</ul>

<h2 id="activesupportnotificationsinstrumenter">ActiveSupport::Notifications::Instrumenter</h2>

<h3 id="file-name-2">File name</h3>

<p><a href="https://github.com/rails/rails/blob/master/activesupport%2Flib%2Factive_support%2Fnotifications%2Finstrumenter.rb">activesupport/lib/active_support/notifications/instrumenter.rb</a></p>

<h3 id="dependency-2">Dependency</h3>

<p><code>securerandom</code>, <a href="http://ruby-doc.org/stdlib-2.1.0/libdoc/securerandom/rdoc/SecureRandom.html">api</a></p>

<h3 id="brief-2">Brief</h3>

<h3 id="specification-2">Specification</h3>

<h4 id="instance-variables-1">Instance Variables</h4>

<p><code>@id</code>, with an <code>attr_reader</code>, generated by <code>SecureRandom.hex(10)</code>.</p>

<p><code>@notifier</code>, records the <strong>Fanout</strong> instance.</p>

<h4 id="instance-methods-1">Instance Methods</h4>

<ul>
  <li>
    <p><code>start(name, payload)</code>, <code>finish(name, payload)</code></p>

    <p>&#8220;`ruby
  def start(name, payload)
    @notifier.start name, @id, payload
  end</p>

    <p>def finish(name, payload)
    @notifier.finish name, @id, payload
  end
  &#8220;`</p>
  </li>
  <li>
    <p><code>instrument(name, payload={})</code></p>

    <p><code>ruby
  def instrument(name, payload={})
    start name, payload
    begin
      yield payload
    rescue Exception =&gt; e
      payload[:exception] = [e.class.name, e.message]
      raise e
    ensure
      finish name, payload
    end
  end
 </code></p>

    <p>Where does this method get called? in <code>ActiveSupport::Notifications.instrument</code>:</p>

    <p><code>ruby
  instrumenter.instrument(name, payload) { yield payload if block_given? }
 </code></p>

    <p>The processing begins with <code>start</code>, ends with <code>finish</code>, instrumenter delegates it to <code>@notifier</code>, and <code>notifier</code> turns to <code>@subscribers</code> which are listening for the event name. And what does <code>@subscribers</code> do with <code>start</code> and <code>finish</code>? Normally we use subscriber objects defined by <code>Subscribers::Timed</code>, which use <code>start</code> to save a beginning timestamp, and <code>finish</code> to save an ending timestamp, and calling the block user passed.</p>

    <p>Attention on the control flow, the events get sent even if an error occurs in the passed-in block.</p>
  </li>
</ul>

<h2 id="activesupportnotificationsevent">ActiveSupport::Notifications::Event</h2>

<h3 id="file-name-3">File name</h3>

<p><a href="https://github.com/rails/rails/blob/master/activesupport%2Flib%2Factive_support%2Fnotifications%2Finstrumenter.rb">activesupport/lib/active_support/notifications/instrumenter.rb</a></p>

<h3 id="dependency-3">Dependency</h3>

<h3 id="specification-3">Specification</h3>

<p>Note that this class has a <code>@children</code> instance variable recording associations between events, and these two methods:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">&lt;&lt;</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span class="line">  <span class="vi">@children</span> <span class="o">&lt;&lt;</span> <span class="n">event</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">parent_of?</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
</span><span class="line">  <span class="vi">@children</span><span class="o">.</span><span class="n">include?</span> <span class="n">event</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="main-working-flow">Main Working Flow</h2>

<h3 id="activesupportnotificationssubscribe">ActiveSupport::Notifications.subscribe</h3>

<ol>
  <li><code>ActiveSupport::Notifications.subscribe(name) {|*args| }</code>.</li>
  <li>in <strong>Notficiations.subscribe</strong>, <code>notifier.subscribe(*args, &amp;block)</code>.</li>
  <li>in <strong>Fanout#subscribe</strong>, <code>subscriber = Subscribers.new pattern, block</code>, then records subscriber into <code>@subscribers</code>.</li>
</ol>

<h3 id="activesupportnotificationsinstrument">ActiveSupport::Notifications.instrument</h3>

<ol>
  <li><code>ActiveSupport::Notifications.instrument(name, payload) { }</code>.</li>
  <li>in <strong>Notficiations.instrument</strong>, <code>instrumenter.instrument(name, payload) { yield payload if block_given? }</code>.</li>
  <li>in <strong>Instrumenter#instrument</strong>, <code>@notifier.start</code>, <code>yield payload</code> and then <code>@notifier.finish</code>.</li>
  <li>in <strong>Fanout::Subscribers::Timed#start</strong>, records beginning time.</li>
  <li>in <strong>Fanout::Subscribers::Timed#finish</strong>, records ending time, and passing <code>name, start_time, end_time, id, payload</code> to the subscribers callbacks.</li>
</ol>

<h2 id="misc">MISC</h2>

<p><strong><em>How does ActiveSupport::Notifications keep thread safe?</em></strong></p>

<p><code>extend</code> <strong>ActiveSupport::PerThreadRegistry</strong> in <strong>InstrumentationRegistry</strong>.</p>

<h2 id="reference">Reference</h2>

<p>Unit test:</p>

<ul>
  <li><a href="https://github.com/rails/rails/blob/master/activesupport%2Ftest%2Fnotifications_test.rb">activesupport/test/notifications_test.rb</a></li>
  <li><a href="https://github.com/rails/rails/blob/master/activesupport%2Ftest%2Fnotifications%2Fevented_notification_test.rb">activesupport/test/notifications/evented_notification_test.rb</a></li>
  <li><a href="https://github.com/rails/rails/blob/master/activesupport%2Ftest%2Fnotifications%2Finstrumenter_test.rb">activesupport/test/notifications/instrumenter_test.rb</a></li>
</ul>

<p><a href="http://www.paperplanes.de/2012/3/14/on-notifications-logsubscribers-and-bringing-sanity-to-rails-logging.html">On Notifications, Log Subscribers, and Bringing Sanity to Rails’ Logging</a><br />
<a href="http://railscasts.com/episodes/249-notifications-in-rails-3">#249 Notifications in Rails 3</a><br />
<a href="https://speakerdeck.com/nextmat/digging-deep-with-activesupportnotifications">Digging Deep with ActiveSupport::Notifications</a></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review] Metaprogramming Ruby]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/06/03/metaprogrammingi-ruby/"/>
    <updated>2014-06-03T00:44:28+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/06/03/metaprogrammingi-ruby</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>Metaprogramming Ruby 2: Program Like the Ruby Pros</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>Paolo Perrotta</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="https://pragprog.com/book/ppmetr2/metaprogramming-ruby-2">pragprog.com/book/ppmetr2/metaprogramming-ruby-2</a></td>
    </tr>
  </tbody>
</table>

<ul id="markdown-toc">
  <li><a href="#the-object-model">The Object Model</a>    <ul>
      <li><a href="#instance-variable">Instance variable</a></li>
      <li><a href="#instance-method">Instance method</a></li>
      <li><a href="#truth-about-classes">Truth about classes</a></li>
      <li><a href="#constant">Constant</a></li>
      <li><a href="#method-lookup">Method lookup</a></li>
      <li><a href="#refinement">Refinement</a></li>
    </ul>
  </li>
  <li><a href="#methods">Methods</a>    <ul>
      <li><a href="#dynamic-dispatch">Dynamic Dispatch</a></li>
      <li><a href="#dynamic-method">Dynamic Method</a></li>
      <li><a href="#ghost-method">Ghost Method</a></li>
    </ul>
  </li>
  <li><a href="#callables">Callables</a>    <ul>
      <li><a href="#the-callables">the Callables</a></li>
      <li><a href="#blocks">Blocks</a></li>
      <li><a href="#proc-objects">Proc Objects</a>        <ul>
          <li><a href="#methods-1">Methods</a></li>
          <li><a href="#unbound-methods">Unbound Methods</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#class-definitions">Class Definitions</a>    <ul>
      <li><a href="#the-current-class">The Current Class</a></li>
      <li><a href="#class-instance-variables">Class Instance Variables</a></li>
      <li><a href="#singleton-methods">Singleton Methods</a></li>
      <li><a href="#singleton-class">Singleton Class</a></li>
      <li><a href="#method-wrapper">Method Wrapper</a>        <ul>
          <li><a href="#around-alias">Around Alias</a></li>
          <li><a href="#refinement-wrapper">Refinement Wrapper</a></li>
          <li><a href="#prepended-wrapper">Prepended Wrapper</a></li>
          <li><a href="#an-interesting-quiz-solving-by-around-alias">An interesting quiz solving by Around Alias</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li><a href="#eval-and-binding">Eval and Binding</a></li>
</ul>

<h1 id="the-object-model">The Object Model</h1>

<p><img src="https://dl.dropboxusercontent.com/s/a6qc1yd1cd57pkp/the_object_model.png?dl=1&amp;token_hash=AAEBXb4OJ73P3xWWbPmIMOferP8_YHxQlS9d8l0hjEq2wQ&amp;expiry=1400078501" alt="the_object_model" /></p>

<p>An object contains its instance variables and a reference to a class.</p>

<h2 id="instance-variable">Instance variable</h2>

<p>Instance variables just spring into existence when you assign them a value, so you can have objects of the same class that carry different instance variables.</p>

<h2 id="instance-method">Instance method</h2>

<p>You can get a list of an object’s methods by calling <code>Object#methods</code>.</p>

<p>When you talk about the class, you call it an instance method, and when you talk about the object, you simply call it a method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">String</span><span class="o">.</span><span class="n">instance_methods</span> <span class="o">==</span> <span class="s2">&quot;abc&quot;</span><span class="o">.</span><span class="n">methods</span> <span class="c1"># =&gt; true</span>
</span><span class="line"><span class="nb">String</span><span class="o">.</span><span class="n">methods</span> <span class="o">==</span> <span class="s2">&quot;abc&quot;</span><span class="o">.</span><span class="n">methods</span> <span class="c1"># =&gt; false</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>An object’s instance variables live in the object itself, and an object’s methods live in the object’s class. That’s why objects of the same class share methods but don’t share instance variables.</p>

<h2 id="truth-about-classes">Truth about classes</h2>

<p>The truth about classes: classes themselves are nothing but objects.</p>

<p>The methods of an object are also the instance methods of its class. In turn, this means that the methods of a class are the instance methods of <code>Class</code>:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">Class</span><span class="o">.</span><span class="n">instance_methods</span><span class="p">(</span><span class="kp">false</span><span class="p">)</span> <span class="c1"># =&gt; [:allocate, :new, :superclass]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What’s the difference between <code>class</code> and <code>superclass</code>?</em></strong></p>

<ul>
  <li><code>class</code> is about the type which an object belongs to.</li>
  <li><code>superclass</code> is about inheritance, between classes.</li>
</ul>

<p>The <code>superclass</code> of Class is Module—which is to say, every class is also a module. To be precise, a class is a module with three additional instance methods (new, allocate, and superclass) that allow you to create objects or arrange classes into hierarchies.</p>

<p><strong><em>Which to pick between Class and Module?</em></strong></p>

<p>Usually, you pick a module when you mean it to be included somewhere, and you pick a class when you mean it to be instantiated or inherited.</p>

<p><strong><em>What’s an Object, and what’s a Class?</em></strong></p>

<ul>
  <li>
    <p>What’s an object? It’s a bunch of instance variables, plus a link to a class. The object’s methods don’t live in the object—they live in the object’s class, where they’re called the instance methods of the class.</p>
  </li>
  <li>
    <p>What’s a class? It’s an object (an instance of Class), plus a list of instance methods and a link to a superclass. Class is a subclass of Module, so a class is also a module.</p>
  </li>
</ul>

<p><strong><em>What’s the difference between <code>load</code> and <code>require</code>?</em></strong></p>

<p>You use load to execute code, and you use require to import libraries.</p>

<ol>
  <li>use <code>require</code>, no need to appends ‘.rb’.</li>
  <li><code>require</code> loads only once.</li>
</ol>

<p><strong><em>As <code>load</code> executes codes, how does <code>load</code> avoid conlicts?</em></strong></p>

<p><code>load('motd.rb', true)</code></p>

<p>If you load a file this way, Ruby creates an anonymous module, uses that module as a Namespace to contain all the constants from motd.rb, and then destroys the module.</p>

<h2 id="constant">Constant</h2>

<p>classes are nothing but objects, class names are nothing but constants.</p>

<p><strong><em>How is a constant really different from a variable?</em></strong></p>

<p>The one important difference has to do with their scope.</p>

<p>Constants are arranged in a tree similar to a file system, where the names of modules and classes play the part of directories and regular constants play the part of files.</p>

<h2 id="method-lookup">Method lookup</h2>

<p><strong><em>What does Ruby do, when you call a method?</em></strong></p>

<ol>
  <li>It finds the method. This is a process called method lookup.</li>
  <li>It executes the method. To do that, Ruby needs something called <code>self</code>.</li>
</ol>

<p><strong><em>How does Ruby lookup methods?</em></strong></p>

<p><em>“one step to the right, then up”</em> rule: go one step to the right into the receiver’s class, and then go up the ancestors chain until you find the method.</p>

<p><strong><em>What does ancestor chain look like, when <code>prepend</code> or <code>include</code> multiple modules?</em></strong></p>

<p>The <code>prepend</code> method. It works like <code>include</code>, but it inserts the module below the including class.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">C</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">M1</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">M2</span>
</span><span class="line">
</span><span class="line">  <span class="n">prepend</span> <span class="no">M3</span>
</span><span class="line">  <span class="n">prepend</span> <span class="no">M4</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">D</span> <span class="o">&lt;</span> <span class="n">C</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">D</span><span class="o">.</span><span class="n">ancestors</span> <span class="c1"># =&gt; [&#39;M4&#39;, &#39;M3&#39;, &#39;C&#39;, &#39;M2&#39;, &#39;M1&#39;]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What does Ruby do, when <code>prepend</code> or <code>include</code> a module multiple times?</em></strong></p>

<p>If that module is already in the chain, Ruby silently ignores the second inclusion. As a result, a module can only appear once in the same chain of ancestors.</p>

<p><strong>Basic ancestor chain</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">MyClass</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="no">MyClass</span><span class="o">.</span><span class="n">ancestors</span> <span class="c1"># =&gt; [MyClass, Object, Kernel, BasicObject]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What <code>private</code> really means?</em></strong></p>

<p><code>private</code> methods come from two rules working together:</p>

<ol>
  <li>you need an explicit receiver to call a method on an object that is not yourself.</li>
  <li><code>private</code> methods can be called only with an <strong>implicit <code>self</code></strong>.</li>
</ol>

<p>Put these two rules together, and you’ll see that you can only call a <code>private</code> method on yourself. You can call this the “private rule.“</p>

<p><strong><em>What’s the env when you start the <code>irb</code>?</em></strong></p>

<p>As soon as you start a Ruby program, you’re sitting within an object named <code>main</code> that the Ruby interpreter created for you.</p>

<h2 id="refinement">Refinement</h2>

<p>Refinements are similar to Monkeypatches, but they’re not global. A Refinement is only active in two places:</p>

<ul>
  <li>The <code>refine</code> block itself.</li>
  <li>The code starting from the place where you call <code>using</code> until the end of the module definition (if you’re in a module definition) or the end of the file (if you’re at the top level).</li>
</ul>

<p><strong><em>Which has the precedence, Refinement or Method lookup?</em></strong></p>

<p>Refinements are like pieces of code patched right over a class, and they override normal method lookup. On the other hand, a Refinement works in a limited area of the program: the lines of code between the call to <code>using</code> and the end of the file, or the end of the module definition.</p>

<p>Code in an active Refinement takes precedence over code in the refined class, and also over code in modules that are included or prepended by the class. Refining a class is like slapping a patch right onto the original code of the class.</p>

<p>A trivia example about Refinement:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">my_method</span>
</span><span class="line">    <span class="s2">&quot;original my_method()&quot;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">another_method</span>
</span><span class="line">    <span class="n">my_method</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">module</span> <span class="nn">MyClassRefinement</span>
</span><span class="line">  <span class="n">refine</span> <span class="no">MyClass</span> <span class="k">do</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">my_method</span>
</span><span class="line">      <span class="s2">&quot;refined my_method()&quot;</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">using</span> <span class="no">MyClassRefinement</span>
</span><span class="line"><span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">my_method</span>     <span class="c1"># =&gt; &quot;refine my_method()&quot;</span>
</span><span class="line"><span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">another_method</span> <span class="c1"># =&gt; &quot;original my_method()&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Even if you call <code>another_method</code> after the <code>using</code>, the call to <code>my_method</code> itself happens before the <code>using</code>—so it calls the original, unrefined version of the method.</p>

<p>A help reference, <a href="http://timelessrepo.com/refinements-in-ruby">Refinements in Ruby</a> by The timeless repository.</p>

<h1 id="methods">Methods</h1>

<h2 id="dynamic-dispatch">Dynamic Dispatch</h2>

<p>Why would you use <code>send</code> instead of the plain old dot notation? Because with <code>send</code>, the name of the method that you want to call becomes just a regular argument. You can wait literally until the very last moment to decide which method to call, while the code is running. This technique is called Dynamic Dispatch.</p>

<p><strong>An example of Dynamic Dispatch</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>gems/pry-0.9.12.2/lib/pry/pry_instance.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">refresh</span><span class="p">(</span><span class="n">options</span><span class="o">=</span><span class="p">{})</span>
</span><span class="line">  <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">  <span class="n">attributes</span> <span class="o">=</span> <span class="o">[</span>
</span><span class="line">          <span class="ss">:input</span><span class="p">,</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">:commands</span><span class="p">,</span> <span class="ss">:print</span><span class="p">,</span> <span class="ss">:quiet</span><span class="p">,</span>
</span><span class="line">          <span class="ss">:exception_handler</span><span class="p">,</span> <span class="ss">:hooks</span><span class="p">,</span> <span class="ss">:custom_completions</span><span class="p">,</span>
</span><span class="line">          <span class="ss">:prompt</span><span class="p">,</span> <span class="ss">:memory_size</span><span class="p">,</span> <span class="ss">:extra_sticky_locals</span>
</span><span class="line">
</span><span class="line">        <span class="o">]</span>
</span><span class="line">
</span><span class="line">  <span class="n">attributes</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">attribute</span><span class="o">|</span>
</span><span class="line">    <span class="n">defaults</span><span class="o">[</span><span class="n">attribute</span><span class="o">]</span> <span class="o">=</span> <span class="no">Pry</span><span class="o">.</span><span class="n">send</span> <span class="n">attribute</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># ...</span>
</span><span class="line">
</span><span class="line">  <span class="n">defaults</span><span class="o">.</span><span class="n">merge!</span><span class="p">(</span><span class="n">options</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
</span><span class="line">    <span class="nb">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="nb">respond_to?</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2">=&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="kp">true</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What’s the concern about <code>send</code>?</em></strong></p>

<p>You can call any method with <code>send</code>, including private methods.</p>

<p>You can use <code>public_send</code> instead. It’s like send, but it makes a point of respecting the receiver’s privacy.</p>

<h2 id="dynamic-method">Dynamic Method</h2>

<p>There is one important reason to use <code>Module#define_method</code>(<strong>private</strong>) over the more familiar def keyword: <code>define_method</code> allows you to decide the name of the defined method at runtime.</p>

<h2 id="ghost-method">Ghost Method</h2>

<p><code>BasicObject#method_missing</code> (<strong>private</strong>)</p>

<p>Ghost Methods are usually icing on the cake, but some objects actually rely almost exclusively on them. They collect method calls through <code>method_missing</code> and forward them to the wrapped object.</p>

<p><strong><em>How can <code>respond_to?</code> missing methods?</em></strong></p>

<p>refernced from <a href="http://blog.marc-andre.ca/2010/11/15/methodmissing-politely/">Method_missing, Politely</a> by Marc Andre.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">StereoPlayer</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="nb">method</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/play_(\w+)/</span>
</span><span class="line">      <span class="nb">puts</span> <span class="s2">&quot;Here&#39;s </span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">super</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">p</span> <span class="o">=</span> <span class="no">StereoPlayer</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="c1"># ok:</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">play_some_Beethoven</span> <span class="c1"># =&gt; &quot;Here&#39;s some_Beethoven&quot;</span>
</span><span class="line"><span class="c1"># not very polite:</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:play_some_Beethoven</span> <span class="c1"># =&gt; false</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">StereoPlayer</span>
</span><span class="line">  <span class="c1"># def method_missing ...</span>
</span><span class="line">  <span class="c1">#   ...</span>
</span><span class="line">  <span class="c1"># end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">respond_to?</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span><span class="line">    <span class="nb">method</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/play_(\w+)/</span> <span class="o">||</span> <span class="k">super</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:play_some_Beethoven</span> <span class="c1"># =&gt; true</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You can specialize <code>respond_to?</code>, but it doesnot make a missing method behaves exactly like a method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">method</span> <span class="ss">:play_some_Beethoven</span>
</span><span class="line"><span class="c1"># =&gt; NameError: undefined method `play_some_Beethoven&#39;</span>
</span><span class="line"><span class="c1">#               for class `StereoPlayer&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Ruby 1.9.2 introduces <code>respond_to_missing?</code> that provides for a clean solution to the problem. Instead of specializing <code>respond_to?</code> one specializes <code>respond_to_missing?</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">StereoPlayer</span>
</span><span class="line">  <span class="c1"># def method_missing ...</span>
</span><span class="line">  <span class="c1">#   ...</span>
</span><span class="line">  <span class="c1"># end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">respond_to_missing?</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span> <span class="o">*</span><span class="p">)</span>
</span><span class="line">    <span class="nb">method</span> <span class="o">=~</span> <span class="sr">/play_(\w+)/</span> <span class="o">||</span> <span class="k">super</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">p</span> <span class="o">=</span> <span class="no">StereoPlayer</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">play_some_Beethoven</span> <span class="c1"># =&gt; &quot;Here&#39;s some_Beethoven&quot;</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">respond_to?</span> <span class="ss">:play_some_Beethoven</span> <span class="c1"># =&gt; true</span>
</span><span class="line"><span class="n">m</span> <span class="o">=</span> <span class="nb">p</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="ss">:play_some_Beethoven</span><span class="p">)</span> <span class="c1"># =&gt; #&lt;Method: StereoPlayer#play_some_Beethoven&gt;</span>
</span><span class="line"><span class="c1"># m acts like any other method:</span>
</span><span class="line"><span class="n">m</span><span class="o">.</span><span class="n">call</span> <span class="c1"># =&gt; &quot;Here&#39;s some_Beethoven&quot;</span>
</span><span class="line"><span class="n">m</span> <span class="o">==</span> <span class="nb">p</span><span class="o">.</span><span class="n">method</span><span class="p">(</span><span class="ss">:play_some_Beethoven</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</span><span class="line"><span class="n">m</span><span class="o">.</span><span class="n">name</span> <span class="c1"># =&gt; :play_some_Beethoven</span>
</span><span class="line"><span class="no">StereoPlayer</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:ludwig</span><span class="p">,</span> <span class="n">m</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">ludwig</span> <span class="c1"># =&gt; &quot;Here&#39;s some_Beethoven&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What about the constant missing?</em></strong></p>

<p><code>Module#const_missing</code>(<strong>public</strong>)</p>

<p><strong><em>What’s the concern about <code>method_missing</code>?</em></strong></p>

<p>This is a common problem with Ghost Methods: since unknown calls become calls to <code>method_missing</code>, your object might accept a call that’s just plain wrong. Finding a bug like this one in a large program can be pretty painful.
To avoid this kind of trouble, take care not to introduce too many Ghost Methods.</p>

<p>Ghost Methods can be dangerous. You can avoid most of their problems by following a few basic recommendations (always call <code>super</code>, always redefine <code>respond_to_missing?</code>)</p>

<p>And you may call some methods <code>Object</code> or some others classes in ancestor chain defined.</p>

<p><strong><em>How to solve it? Blank Slate!</em></strong></p>

<p>Remove methods from an object to turn them into Ghost Methods.</p>

<ul>
  <li>Inheriting from <code>BasicObject</code> is the quicker way to define a Blank Slate in Ruby.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">im</span> <span class="o">=</span> <span class="no">BasicObject</span><span class="o">.</span><span class="n">instance_methods</span>
</span><span class="line"><span class="n">im</span> <span class="c1"># =&gt; [:==, :equal?, :!, :!=, :instance_eval, :instance_exec, :__send__, :__id__]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>
    <p>Inheriting from <code>Object</code> by default, and remove method inherited.</p>

    <p>Don’t hide <code>instance_eval</code> or any method beginning with <code>__</code>. One example of a reserved method is <code>BasicObject#__send__</code>, that behaves the same as send, but gives you a scary warning when you try to remove it.</p>
  </li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Compter</span>
</span><span class="line">  <span class="nb">instance_methods</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">m</span><span class="o">|</span>
</span><span class="line">    <span class="n">undef_method</span> <span class="n">m</span> <span class="k">unless</span> <span class="n">m</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/^__|method_missing|respond_to/</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Or you can write a BlankSlate class to inherit.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">BlankSlate</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">hide</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="k">unless</span> <span class="nb">instance_methods</span><span class="o">.</span><span class="n">include?</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span>
</span><span class="line">    <span class="k">return</span> <span class="k">if</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span> <span class="o">=~</span> <span class="sr">/^__|method_missing|respond_to/</span>
</span><span class="line">    <span class="vi">@hidden_methods</span> <span class="o">||=</span> <span class="p">{}</span>
</span><span class="line">    <span class="vi">@hidden_methods</span><span class="o">[</span><span class="nb">name</span><span class="o">.</span><span class="n">to_sym</span><span class="o">]</span> <span class="o">=</span> <span class="nb">instance_method</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="n">undef_method</span> <span class="nb">name</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="nb">instance_methods</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">m</span><span class="o">|</span> <span class="n">hide</span> <span class="n">m</span> <span class="p">}</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What’s the difference between <code>undef_method</code> and <code>remove_method</code>?</em></strong></p>

<ul>
  <li>The drastic <code>undef_method</code> removes any method, including the inherited ones.</li>
  <li>The kinder <code>remove_method</code> removes the method from the receiver, but it leaves inherited methods alone.</li>
</ul>

<p><strong><em>What’s the boiling down facts between Ghost Method and really methods?</em></strong></p>

<p>Ghost Method are just a way to intercept method calls. Because of this fact, they behave different than actual methods.</p>

<p><strong><em>What’s the choice between <code>define_method</code> and <code>method_missing</code>?</em></strong></p>

<p>There are times when Ghost Methods are your only viable option. This usually happens</p>

<ul>
  <li>When you have a large number of method calls.</li>
  <li>When you don’t know what method calls you might need at runtime.</li>
</ul>

<p><em>Use Dynamic Methods if you can, and Ghost Methods if you have to.</em></p>

<h1 id="callables">Callables</h1>

<h2 id="the-callables">the Callables</h2>

<blockquote>
  <p>Package code, and call it later</p>
</blockquote>

<ul>
  <li><strong>block</strong>, evaluated in the scope which they’re defined.</li>
  <li><strong>proc</strong>, which is basically a block turned object, and evaluated in the scope which they’re defined.</li>
  <li><strong>lambda</strong>, which is a slight variation on a proc.</li>
  <li><strong>method</strong>, bound to an object, which are evaluated in that object’s scope. They can also be unbound from their scope and rebound to another object or class.</li>
</ul>

<p><strong>block</strong> is not an object, while <strong>proc</strong> and <strong>lambda</strong> are Proc objects, and <strong>method</strong> is <a href="http://stackoverflow.com/questions/2602340/methods-in-ruby-objects-or-not">in question</a>.</p>

<h2 id="blocks">Blocks</h2>

<p>The main point about blocks is that they are all inclusive and come ready to run. They contain both the <strong>code</strong> and <strong>a set of bindings</strong>.</p>

<p><strong>When you define the block, it simply grabs the bindings that are there at that moment</strong>, and then it carries those bindings along when you pass the block into a method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">my_method</span>
</span><span class="line">  <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;Goodbye&quot;</span>
</span><span class="line">  <span class="k">yield</span><span class="p">(</span><span class="s2">&quot;cruel&quot;</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;Hello&quot;</span>
</span><span class="line"><span class="n">my_method</span> <span class="p">{</span><span class="o">|</span><span class="n">y</span><span class="o">|</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">x</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="n">y</span><span class="si">}</span><span class="s2"> world&quot;</span> <span class="p">}</span> <span class="c1"># =&gt; &quot;Hello, cruel world&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What if I define additional bindings inside a block?</em></strong></p>

<p>They disappear after the block ends.</p>

<p><strong><em>What’s the meaning of “a block is a closure”?</em></strong></p>

<p>a block is a closure, this means a block captures the local bindings and carries them along with it.</p>

<p><strong>scope</strong></p>

<p>You can see bindings all over the scope.</p>

<p><code>class</code>, <code>module</code>, and <code>def</code>, respectively. Each of these keywords acts like a <strong>Scope Gate</strong>.</p>

<p><strong>A subtle difference between <code>class</code>, <code>module</code> and <code>def</code></strong></p>

<p>The code in a <code>class</code> or <code>module</code> definition is executed immediately. Conversely, the code in a method definition is executed later, when you eventually call the method.</p>

<p><strong><em>Whenever the program changes scope, some bindings are replaced by a new set of bindings. RIGHT?</em></strong></p>

<p>For <code>local_varialbes</code>, that’s right, but <code>instance_variables</code>, <code>class_variables</code> and <code>global_variables</code> can go through the Scope Gate.</p>

<p><strong><em>What’s the difference between Global Variables and Top-Level Instance Variables?</em></strong></p>

<p>when it comes to global variables, use them sparingly, if ever.</p>

<p>You can access a top-level instance variable whenever <code>main</code> takes the role of self. When any other object is <code>self</code>, the top-level instance variable is out of scope.</p>

<p><strong><em>How to cross the Scope Gate, and Why?</em></strong></p>

<p>You can use these techniques:</p>

<ul>
  <li>Use Flat Scope (<code>Class.new</code>, <code>Module.new</code>, and <code>define_method</code>)</li>
  <li>Use Shared Scope</li>
  <li>Use Context Probe (<code>BasicObject#instance_eval</code>)</li>
</ul>

<p>to mix code and bindings at will.</p>

<p><strong><em>What is Flat Scope?</em></strong></p>

<p>“flattening the scope,” meaning that the two scopes share variables as if the scopes were squeezed together. For short, you can call this spell a Flat Scope.</p>

<p>Use <code>Class.new</code>, <code>Module.new</code> and <code>define_method</code>.</p>

<p><strong><em>What is Shared Scope?</em></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># use `def` to do seperate</span>
</span><span class="line"><span class="k">def</span> <span class="nf">define_methods</span>
</span><span class="line">  <span class="n">shared</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">
</span><span class="line">  <span class="no">Kernel</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:counter</span> <span class="k">do</span>
</span><span class="line">    <span class="n">shared</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="no">Kernel</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:inc</span> <span class="k">do</span> <span class="o">|</span><span class="n">x</span><span class="o">|</span>
</span><span class="line">    <span class="n">shared</span> <span class="o">+=</span> <span class="n">x</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">define_methods</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="n">counter</span> <span class="c1"># =&gt; 0</span>
</span><span class="line"><span class="n">inc</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</span><span class="line"><span class="n">counter</span> <span class="c1"># =&gt; 4</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If you define multiple methods in the same Flat Scope, maybe protected by a Scope Gate, all those methods can share bindings. That’s called a <strong>Shared Scope</strong></p>

<p><strong><em>What is Context Probe?</em></strong></p>

<p><code>instance_eval</code> has a slightly more flexible twin brother named <code>instance_exec</code>, that allows you to pass arguments to the block.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">C</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@x</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">D</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">twisted_method</span>
</span><span class="line">    <span class="vi">@y</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class="line">    <span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="s2">&quot;@x: </span><span class="si">#{</span><span class="vi">@x</span><span class="si">}</span><span class="s2">, @y: </span><span class="si">#{</span><span class="vi">@y</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">D</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">twisted_method</span> <span class="c1"># =&gt; &quot;@x: 1, @y: &quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>However, instance variables depend on <code>self</code>, so when <code>instance_eval</code> switches <code>self</code> to the receiver, all the instance variables in the caller fall out of scope.</p>

<p><strong>Clean Room</strong></p>

<p>Blank Slates are good candidates for Clean Room.</p>

<p>The ideal Clean Room doesn’t have many methods or instance variables, because the names of those methods and instance variables could clash with the names in the environment that the block comes from. For this reason, instances of <code>BasicObject</code> usually make for good Clean Rooms, because they’re Blank Slates.</p>

<p>You might think of using a <code>BasicObject</code> instead of an Object for your Clean Room. However, remember that <code>BasicObject</code> is also a Blank Slate, and as such it lacks some common methods such as puts.</p>

<p><strong><em>What’s the different use for Shared Scope and Clean Room?</em></strong></p>

<p><em>Shared Scope</em> is used in definition, to make variables(bindings) shared between methods, while <em>Clean Room</em> is used to run code, to help reduce the modifications on shared variables(like instance variables).</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># lambda which is called immediatley is the Shared Scope</span>
</span><span class="line"><span class="nb">lambda</span> <span class="p">{</span>
</span><span class="line">  <span class="n">setups</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">  <span class="n">events</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">
</span><span class="line">  <span class="no">Kernel</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:event</span> <span class="k">do</span> <span class="o">|</span><span class="n">description</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="o">|</span>
</span><span class="line">    <span class="n">events</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="ss">:description</span> <span class="o">=&gt;</span> <span class="n">description</span><span class="p">,</span> <span class="ss">:condition</span> <span class="o">=&gt;</span> <span class="n">block</span><span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="no">Kernel</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:setup</span> <span class="k">do</span> <span class="o">|&amp;</span><span class="n">block</span><span class="o">|</span>
</span><span class="line">    <span class="n">setups</span> <span class="o">&lt;&lt;</span> <span class="n">block</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="no">Kernel</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:each_event</span> <span class="k">do</span> <span class="o">|&amp;</span><span class="n">block</span><span class="o">|</span>
</span><span class="line">    <span class="n">events</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
</span><span class="line">      <span class="n">block</span><span class="o">.</span><span class="n">call</span> <span class="n">event</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="no">Kernel</span><span class="o">.</span><span class="n">send</span> <span class="ss">:define_method</span><span class="p">,</span> <span class="ss">:each_setup</span> <span class="k">do</span> <span class="o">|&amp;</span><span class="n">block</span><span class="o">|</span>
</span><span class="line">    <span class="n">setups</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">setup</span><span class="o">|</span>
</span><span class="line">      <span class="n">block</span><span class="o">.</span><span class="n">call</span> <span class="n">setup</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="p">}</span><span class="o">.</span><span class="n">call</span>
</span><span class="line">
</span><span class="line"><span class="nb">load</span> <span class="s1">&#39;events.rb&#39;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># env is created for each event to be a Clean Room</span>
</span><span class="line"><span class="n">each_event</span> <span class="k">do</span> <span class="o">|</span><span class="n">event</span><span class="o">|</span>
</span><span class="line">  <span class="n">env</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="n">each_setup</span> <span class="k">do</span> <span class="o">|</span><span class="n">setup</span><span class="o">|</span>
</span><span class="line">    <span class="n">env</span><span class="o">.</span><span class="n">instance_eval</span> <span class="o">&amp;</span><span class="n">setup</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="nb">puts</span> <span class="s2">&quot;ALERT: </span><span class="si">#{</span><span class="n">event</span><span class="o">[</span><span class="ss">:description</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">instance_eval</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">event</span><span class="o">[</span><span class="ss">:condition</span><span class="o">]</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>When is <code>yield</code> not enough to use?</em></strong></p>

<ul>
  <li>You want to pass the block to another method (or even another block).</li>
  <li>You want to convert the block to a <code>Proc</code>.</li>
</ul>

<h2 id="proc-objects">Proc Objects</h2>

<p>as blocks are not objects, Ruby provides the standard library class <code>Proc</code>. A <code>Proc</code> is a block that has been turned into an object. You can create a <code>Proc</code> by passing the block to <code>Proc.new</code>. Later, you can evaluate the block-turned-object with <code>Proc#call</code>.</p>

<p><strong>Deferred Evaluation</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">inc</span> <span class="o">=</span> <span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="line"><span class="c1"># more code...</span>
</span><span class="line"><span class="n">inc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># =&gt; 3</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>4 ways to create Procs explicitly</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="no">Proc</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="line"><span class="nb">proc</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="line"><span class="nb">lambda</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span><span class="line"><span class="o">-&gt;</span> <span class="n">x</span> <span class="p">{</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span> <span class="c1"># stabby lambda</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Ways to create Procs implicitly</strong></p>

<p>use <code>&amp;</code> to convert block into a proc:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">make_proc</span><span class="p">(</span><span class="o">&amp;</span><span class="nb">p</span><span class="p">)</span>
</span><span class="line">  <span class="nb">p</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">make_proc</span> <span class="p">{</span><span class="o">|</span><span class="n">x</span><span class="o">|</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>4 ways to call Procs</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>
</span><span class="line"><span class="nb">p</span><span class="o">[</span><span class="mi">41</span><span class="o">]</span>
</span><span class="line"><span class="nb">p</span> <span class="o">===</span> <span class="mi">41</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="p">(</span><span class="mi">41</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Use <code>&amp;</code> to convert a block to Proc</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="o">&amp;</span><span class="n">the_proc</span><span class="p">)</span>
</span><span class="line">  <span class="n">the_proc</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">p</span> <span class="o">=</span> <span class="n">my_method</span> <span class="p">{</span><span class="o">|</span><span class="nb">name</span><span class="o">|</span> <span class="s2">&quot;Hello, </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2">!&quot;</span> <span class="p">}</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">class</span>     <span class="c1"># =&gt; Proc</span>
</span><span class="line"><span class="nb">p</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s2">&quot;Bill&quot;</span><span class="p">)</span>  <span class="c1"># =&gt; &quot;Hello, Bill!&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Use <code>&amp;</code> to convert a Proc to block</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">my_method</span><span class="p">(</span><span class="n">greeting</span><span class="p">)</span>
</span><span class="line">    <span class="s2">&quot;</span><span class="si">#{</span><span class="n">greeting</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="k">yield</span><span class="si">}</span><span class="s2">!&quot;</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">my_proc</span> <span class="o">=</span> <span class="nb">proc</span> <span class="p">{</span> <span class="s2">&quot;Bill&quot;</span> <span class="p">}</span>
</span><span class="line"><span class="n">my_method</span><span class="p">(</span><span class="s2">&quot;Hello&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">my_proc</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What’s a lambda?</em></strong></p>

<p>Procs created with <code>lambda</code> are called <em>lambdas</em>, while the others are simply called <em>procs</em>. (You can use the <code>Proc#lambda?</code> method to check whether the <code>Proc</code> is a lambda).</p>

<p><strong>Procs vs. Lambdas</strong></p>

<ul>
  <li>
    <p><code>return</code></p>

    <p><code>lambda</code> returns just returns from the lambda, while a proc returns from the scope where the proc itself was defined.</p>
  </li>
  <li>
    <p><strong>arity</strong></p>

    <p>Call a <code>lambda</code> with the wrong arity, and it fails with an <code>ArgumentError</code>, while if there are too many arguments, a proc drops the excess arguments. If there are too few arguments, it assigns <code>nil</code> to the missing arguments.</p>
  </li>
</ul>

<p>Generally speaking, <code>lambdas</code> are more intuitive than procs because they’re more similar to methods. They’re pretty strict about arity, and they simply exit when you call <code>return</code>.</p>

<p><strong>About the tolerance on arguments</strong></p>

<p>method == lambda &lt; proc == block</p>

<h3 id="methods-1">Methods</h3>

<p>By calling <code>Kernel#method</code>, you get the method itself as a Method object, which you can later execute with <code>Method#call</code>. In Ruby 2.1, you also have <code>Kernel#singleton_method</code>, that converts the name of a Singleton Method to a Method object.</p>

<p><strong>Conversions between methods and procs</strong></p>

<ul>
  <li>Use <code>Method#to_proc</code> to convert a method into proc.</li>
  <li>Use <code>define_method</code> to convert a proc into method.</li>
</ul>

<p><strong>An important difference between methods and procs</strong></p>

<p>a <code>lambda</code> is evaluated in the scope it’s defined in (it’s a closure, remember?), while a <code>Method</code> is evaluated in the scope of its object.</p>

<h3 id="unbound-methods">Unbound Methods</h3>

<p><code>UnboundMethods</code> are like <code>Methods</code> that have been detached from their original class or module.</p>

<p><strong>You can’t call an <code>UnboundMethod</code></strong>, but you can use it to generate a normal method that you can call.</p>

<p><strong>generate</strong></p>

<ul>
  <li>use <code>Method#unbind</code></li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="n">unbound</span> <span class="o">=</span> <span class="nb">method</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span><span class="o">.</span><span class="n">unbind</span>
</span><span class="line"><span class="n">unbound</span><span class="o">.</span><span class="n">class</span>   <span class="c1"># =&gt; UnboundMethod</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>use <code>Module#instance_method</code></li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">MyModule</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">my_method</span>
</span><span class="line">  <span class="mi">42</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">unbound</span> <span class="o">=</span> <span class="no">MyModule</span><span class="o">.</span><span class="n">instance_method</span><span class="p">(</span><span class="ss">:my_method</span><span class="p">)</span>
</span><span class="line"><span class="n">unbound</span><span class="o">.</span><span class="n">class</span>   <span class="c1"># =&gt; UnboundMethod</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>Note:</em> <code>instance_methods</code> is totally different, it’s like <code>methods</code>, just return an array of symbols.</p>

<p><strong>usage</strong></p>

<ul>
  <li>bind the UnboundMethod to an object with <code>UnboundMethod#bind</code>. UnboundMethods that come from a class can only be bound to objects of the same class (or a subclass), while UnboundMethods that come from a module have no such limitation from Ruby 2.0 onwards.</li>
  <li>use an UnboundMethod to define a brand new method by passing it to <code>Module#define_method</code>.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="nb">String</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class="line">  <span class="n">define_method</span> <span class="ss">:another_method</span><span class="p">,</span> <span class="n">unbound</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="s2">&quot;abc&quot;</span><span class="o">.</span><span class="n">another_method</span> <span class="c1"># =&gt; 42</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>example</strong></p>

<p>In ActiveSupport, the ‘autoloading’ system includes a <code>Loadable</code> module, which redefines the standard <code>Kernel#load</code>. If a class includes <code>Loadable</code>, then <code>Loadable#load</code> gets lower then <code>Kernel#load</code> on its chain of ancestors.</p>

<p>And what if you want to stop using <code>Loadable#load</code> and go back to the plain vanilla <code>Kernel#load</code>?</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span># gems/activesupport-4.0.2/lib/active_support/dependencies.rb</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">Loadable</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">exclude_from</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class="line">    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="p">{</span> <span class="n">define_method</span> <span class="ss">:load</span><span class="p">,</span> <span class="no">Kernel</span><span class="o">.</span><span class="n">instance_method</span><span class="p">(</span><span class="ss">:load</span><span class="p">)</span> <span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="class-definitions">Class Definitions</h1>

<p>In Java and C#, defining a class is like making a deal between you and the compiler.</p>

<p>In Ruby, class definitions are different. When you use the class keyword, you aren’t just dictating how objects will behave in the future. On the contrary, you’re actually running code.</p>

<h2 id="the-current-class">The Current Class</h2>

<p>Wherever you are in a Ruby program, you always have a current object: <code>self</code>. Likewise, you always have a current class (or module). As The Ruby interpreter always keeps a reference to the current class (or module), when you define a method, that method becomes an instance method of the current class.</p>

<p>Although you can get a reference to the current object through <code>self</code>, there’s no equivalent keyword to get a reference to the current class.</p>

<p><strong><em>How to keep track of the current class?</em></strong></p>

<ul>
  <li>At the top level of your program, the current class is <code>Object</code>, the class of <code>main</code>. (That’s why, if you define a method at the top level, that method becomes an instance method of <code>Object</code>).</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="no">Object</span><span class="o">.</span><span class="n">instance_methods</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span>      <span class="c1"># =&gt; []</span>
</span><span class="line"><span class="no">Object</span><span class="o">.</span><span class="n">private_instance_methods</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="c1"># =&gt; [:foo]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">[</span><span class="mi">6</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="o">=&gt;</span> <span class="kp">nil</span>
</span><span class="line"><span class="o">[</span><span class="mi">7</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="n">main</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">cd</span> <span class="no">Object</span>
</span><span class="line"><span class="o">[</span><span class="mi">8</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="no">Object</span><span class="p">):</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">show</span><span class="o">-</span><span class="nb">method</span> <span class="n">foo</span>
</span><span class="line">
</span><span class="line"><span class="ss">From</span><span class="p">:</span> <span class="p">(</span><span class="n">pry</span><span class="p">)</span> <span class="err">@</span> <span class="n">line</span> <span class="mi">4</span><span class="p">:</span>
</span><span class="line"><span class="ss">Owner</span><span class="p">:</span> <span class="no">Object</span>
</span><span class="line"><span class="ss">Visibility</span><span class="p">:</span> <span class="kp">private</span>
</span><span class="line"><span class="no">Number</span> <span class="n">of</span> <span class="ss">lines</span><span class="p">:</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="o">[</span><span class="mi">9</span><span class="o">]</span> <span class="n">pry</span><span class="p">(</span><span class="no">Object</span><span class="p">):</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">cd</span> <span class="o">.</span><span class="n">.</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># foo.rb</span>
</span><span class="line"><span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="nb">p</span> <span class="no">Object</span><span class="o">.</span><span class="n">private_instance_methods</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="ss">:foo</span><span class="p">)</span> <span class="c1"># =&gt; [:foo]</span>
</span><span class="line">
</span><span class="line"><span class="c1"># console</span>
</span><span class="line"><span class="err">$</span> <span class="n">ruby</span> <span class="n">foo</span><span class="o">.</span><span class="n">rb</span> <span class="c1"># =&gt; [:foo]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>
    <p>In a method, the current class is the class of the current object.</p>
  </li>
  <li>
    <p>When you open a class with the <code>class</code> keyword (or a module with the <code>module</code> keyword), that class becomes the current class.</p>
  </li>
</ul>

<p><strong><em>How can you open the class if you don’t know its name?</em></strong></p>

<p>Use <code>Module#class_eval</code>.</p>

<p><strong><em>What’s the advantage of <code>Module#class_eval</code> other than <code>class</code>?</em></strong></p>

<ul>
  <li><code>Module#class_eval</code> is actually more flexible than class. You can use <code>class_eval</code> on any variable that references the class, while <code>class</code> requires a constant.</li>
  <li><code>class</code> opens a new scope, losing sight of the current bindings, while <code>class_eval</code> has a <em>Flat Scope</em>.</li>
</ul>

<p><strong><em>When to use <code>class_eval</code>, and when <code>instance_eval</code>?</em></strong></p>

<p>Use <code>instance_eval</code> to open an object that is not a class, and <code>class_eval</code> to open a class definition and define methods with <code>def</code>.</p>

<p><strong><em>What’s the difference between <code>class_eval</code> and <code>instance_eval</code>?</em></strong></p>

<p>Both changes <code>self</code>, and <code>class_eval</code> changes the current class to the caller’s class, while <code>instance_eval</code> changes the current class to the caller’s singleton class.</p>

<p><strong>An interesting knowledge about <code>Class.new</code></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">c</span> <span class="o">=</span> <span class="no">Class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">Array</span><span class="p">)</span> <span class="k">do</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">my_method</span>
</span><span class="line">    <span class="s1">&#39;Hello!&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">MyClass</span> <span class="o">=</span> <span class="n">c</span>
</span><span class="line"><span class="n">c</span><span class="o">.</span><span class="n">name</span>  <span class="c1"># =&gt; &#39;MyClass&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>When you assign an anonymous class to a constant, Ruby understands that you’re trying to give a name to the class, and it does something special: it turns around to the class and says, “Here’s your new name.” Now the constant references the Class, and the Class also references the constant. If it weren’t for this trick, a class wouldn’t be able to know its own name</p>

<h2 id="class-instance-variables">Class Instance Variables</h2>

<p>They’re just regular instance variables that happen to belong to an object of class <code>Class</code>. Because of that, a Class Instance Variable can be accessed only by the class itself— not by an instance or by a subclass.</p>

<p>No weird behaviors like Class Variables, which subclass and class share the same variable.</p>

<h2 id="singleton-methods">Singleton Methods</h2>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">obj</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>A method which is specific to a single object, is called Singleton Methods.</p>

<p>You can also use <code>Object#define_singleton_method</code>: (Remeber <code>Module#define_method</code>?)</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">obj</span><span class="o">.</span><span class="n">define_singleton_method</span> <span class="ss">:bar</span> <span class="p">{</span> <span class="nb">puts</span> <span class="s1">&#39;bar&#39;</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What is the Class Macro?</em></strong></p>

<p>A method such as <code>attr_accessor</code> is called a Class Macro. Class Macros look like keywords, but they’re just regular class methods that are meant to be used in a class definition.</p>

<h2 id="singleton-class">Singleton Class</h2>

<p>A singleton class is where an object’s Singleton Methods live</p>

<p><strong><em>How to get?</em></strong></p>

<ul>
  <li>Use the <code>&lt;&lt;</code> syntax.</li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nc">obj</span><span class="o">.</span><span class="nf">my_singleton_method</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">obj</span><span class="p">;</span> <span class="nb">instance_methods</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/my_/</span><span class="p">);</span> <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Foo</span>
</span><span class="line">  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">bar</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;Foo.bar&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">foo</span> <span class="o">=</span> <span class="no">Foo</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="n">foo</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">bar</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo.bar&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li>Use <code>Object#singleton_class</code></li>
</ul>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">obj</span><span class="o">.</span><span class="n">singleton_class</span><span class="o">.</span><span class="n">instance_methods</span><span class="o">.</span><span class="n">grep</span><span class="p">(</span><span class="sr">/my_/</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Singleton classes and inheritance</strong></p>

<p><img src="https://dl.dropboxusercontent.com/s/leu6dh1ro55u149/singleton_classes_and_inheritance.png?dl=1&amp;token_hash=AAFdcu5UXq5RMpm7nkaQf_B5Und9FjuPF85b35aIWXjC1g&amp;expiry=1400340965" alt="singleton_classes_and_inheritance" /></p>

<p><strong>7 rules of the Ruby object model</strong></p>

<blockquote>
  <p>The Ruby object model is a beautiful place,” Bill notes, with a dreamy expres- sion on his face. “There are classes, singleton classes, and modules. There are instance methods, class methods, and singleton methods.</p>
</blockquote>

<ol>
  <li>There is only one kind of object—be it a regular object or a module.</li>
  <li>There is only one kind of module—be it a regular module, a class, or a singleton class.</li>
  <li>There is only one kind of method, and it lives in a module—most often in a class.</li>
  <li>Every object, classes included, has its own “real class,” be it a regular class or a singleton class.</li>
  <li>Every class, with the exception of <code>BasicObject</code>, has exactly one ancestor— either a superclass, or a module. This means you have a single chain of ancestors from any class up to <code>BasicObject</code>.</li>
  <li>The superclass of the singleton class of an object is the object’s class. The superclass of the singleton class of a class is the singleton class of the class’s superclass.</li>
  <li>When you call a method, Ruby goes “right” in the receiver’s real class and then “up” the ancestors chain. That’s all there is to know about the way Ruby finds methods.</li>
</ol>

<p><strong><em>Can object’s Singleton Class touch the its Instance Variable?</em></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="c1"># exampel 1</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">name</span><span class="p">;</span> <span class="vi">@name</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">name</span><span class="o">=</span><span class="p">(</span><span class="n">n</span><span class="p">);</span> <span class="vi">@name</span><span class="o">=</span><span class="n">n</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">obj</span> <span class="o">=</span> <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;foo&#39;</span>
</span><span class="line"><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="c1"># =&gt; &#39;foo&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">obj</span><span class="o">.</span><span class="n">instance_eval</span> <span class="p">{</span> <span class="k">def</span> <span class="nf">to_s</span><span class="p">;</span> <span class="s2">&quot;My name is </span><span class="si">#@name</span><span class="s2">&quot;</span><span class="p">;</span> <span class="k">end</span> <span class="p">}</span>
</span><span class="line"><span class="n">obj</span><span class="o">.</span><span class="n">to_s</span> <span class="c1"># =&gt; &quot;My name is foo&quot;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># example2</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">  <span class="vi">@age</span> <span class="o">=</span> <span class="mi">42</span>
</span><span class="line">  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">age</span><span class="p">;</span> <span class="vi">@age</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="no">MyClass</span><span class="o">.</span><span class="n">age</span> <span class="c1"># =&gt; 42</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Yes, it can. So I can assume the obj’s Instance Variable lives in its Singleton Class.</p>

<p><strong><em>Can a module’s singleton methods be included?</em></strong></p>

<p>No!</p>

<p>When a class includes a module, it gets the module’s instance methods—not the class methods. Class methods stay out of reach, in the module’s singleton class.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">M</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">bar</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;bar&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">C</span>
</span><span class="line">  <span class="kp">include</span> <span class="n">M</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># =&gt; &#39;foo&#39;</span>
</span><span class="line"><span class="n">C</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">bar</span> <span class="c1"># =&gt; NoMethodError</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">C</span>
</span><span class="line">  <span class="kp">extend</span> <span class="n">M</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">C</span><span class="o">.</span><span class="n">bar</span> <span class="c1"># =&gt; NoMethodError</span>
</span><span class="line"><span class="n">C</span><span class="o">.</span><span class="n">foo</span> <span class="c1"># =&gt; &#39;foo&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What’s the difference between <code>Module#include</code> and <code>Object#extend</code>?</em></strong></p>

<ul>
  <li><code>Module#include</code> includes a module in the receiver’s class.</li>
  <li><code>Object#extend</code> includes a module in the receiver’s singleton class.</li>
</ul>

<h2 id="method-wrapper">Method Wrapper</h2>

<ul>
  <li>Around Alias</li>
  <li>Refinement Wrapper</li>
  <li>Prepended Wrapper(<code>Module#prepend</code>)</li>
</ul>

<p>Selection: Prepended Wrapper &gt; Refinement Wrapper &gt; Around Alias</p>

<h3 id="around-alias">Around Alias</h3>

<p><strong><code>alias</code> vs. <code>alias_method</code></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">  <span class="k">alias</span> <span class="ss">:new_foo</span> <span class="ss">:foo</span>
</span><span class="line">  <span class="n">alias_method</span> <span class="ss">:another_new_foo</span><span class="p">,</span> <span class="ss">:foo</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<ul>
  <li><code>alias</code> is a keyword.</li>
  <li><code>alias_method</code> is an instance method of Module. <code>Module#alias_method</code></li>
</ul>

<p><strong><em>Can you alias a method before it defined?</em></strong></p>

<p>No!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">  <span class="n">alias_method</span> <span class="ss">:new_foo</span><span class="p">,</span> <span class="ss">:foo</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># =&gt; NameError: undefined method `foo&#39; for class `MyClass&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>Can aliases break the class’s encapsulation?</em></strong></p>

<p>Yes!</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">MyClass</span>
</span><span class="line">  <span class="n">alias_method</span> <span class="ss">:new_foo</span><span class="p">,</span> <span class="ss">:foo</span>
</span><span class="line">
</span><span class="line">  <span class="kp">private</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">foo</span><span class="p">;</span> <span class="nb">puts</span> <span class="s1">&#39;foo&#39;</span><span class="p">;</span> <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span>     <span class="c1"># =&gt; NoMethodError: private method `foo&#39; called</span>
</span><span class="line">  <span class="no">MyClass</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">new_foo</span> <span class="c1"># =&gt; &#39;foo&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>How to write an Around Alias?</em></strong></p>

<ol>
  <li>You alias a method.</li>
  <li>You redefine it.</li>
  <li>You call the old method from the new method.</li>
</ol>

<p><strong>Downsides</strong></p>

<ul>
  <li>They pollute your classes with one additional method name. You can fix this small problem somehow by making the old version of the method <code>private</code> after you alias it.</li>
  <li>The loading issue. You should never load an Around Alias twice, unless you want to end up with an exception when you call the method.</li>
</ul>

<p>The main issue with Around Aliases, however, is that they are a form of Monkeypatching. Like all Monkeypatches, they can break existing code that wasn’t expecting the method to change.</p>

<h3 id="refinement-wrapper">Refinement Wrapper</h3>

<p><strong>Advantage over Around Alias</strong></p>

<p>If you call <code>super</code> from a refined method, you will call the original, unrefined method.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">StringRefinement</span>
</span><span class="line">  <span class="n">refine</span> <span class="nb">String</span> <span class="k">do</span>
</span><span class="line">    <span class="k">def</span> <span class="nf">length</span>
</span><span class="line">      <span class="k">super</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">?</span> <span class="s1">&#39;long&#39;</span> <span class="p">:</span> <span class="s1">&#39;short&#39;</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">using</span> <span class="no">StringRefinement</span>
</span><span class="line"><span class="s2">&quot;War and Peace&quot;</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; &quot;long&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="prepended-wrapper">Prepended Wrapper</h3>

<p>A method in a prepended module can override a method in the includer, and call the non- overridden version with <code>super</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">module</span> <span class="nn">ExplicitString</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">length</span>
</span><span class="line">    <span class="k">super</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">?</span> <span class="s1">&#39;long&#39;</span> <span class="p">:</span> <span class="s1">&#39;short&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">String</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class="line">  <span class="n">prepend</span> <span class="no">ExplicitString</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="s2">&quot;War and Peace&quot;</span><span class="o">.</span><span class="n">length</span> <span class="c1"># =&gt; &quot;long&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>Advantage over Refinement Wrapper and Around Alias?</em></strong></p>

<p>It’s generally considered cleaner and more explicit than both a Refinement Wrapper and an Around Alias.</p>

<h3 id="an-interesting-quiz-solving-by-around-alias">An interesting quiz solving by Around Alias</h3>

<p>Make it work:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="mi">1</span> <span class="o">+</span> <span class="mi">1</span> <span class="c1"># =&gt; 3</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>You can solve this quiz with an Open Class. Just reopen <code>Fixnum</code>, and redefine <code>+</code> so that <code>(x+y)</code> becomes <code>(x+y+1)</code>. This is not as easy as it seems, however. The new version of + relies on the old version of +, so you need to wrap your old version with the new version.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Fixnum</span>
</span><span class="line">  <span class="n">alias_method</span> <span class="ss">:old_plus</span><span class="p">,</span> <span class="ss">:+</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">+</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</span><span class="line">    <span class="nb">self</span><span class="o">.</span><span class="n">old_plus</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">old_plus</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h1 id="eval-and-binding">Eval and Binding</h1>

<p><code>Kernel#eval</code> Evaluates the Ruby expression(s) in string. If binding is given, which must be a <code>Binding</code> object, the evaluation is performed in its context.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">get_binding</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
</span><span class="line">  <span class="nb">binding</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">str</span> <span class="o">=</span> <span class="s1">&#39;hello&#39;</span>
</span><span class="line"><span class="nb">eval</span> <span class="s2">&quot;str + &#39; Fred&#39;&quot;</span>                     <span class="c1"># =&gt; &quot;hello Fred&quot;</span>
</span><span class="line"><span class="nb">eval</span> <span class="s2">&quot;str + &#39; Fred&#39;&quot;</span><span class="p">,</span> <span class="n">get_binding</span><span class="p">(</span><span class="s1">&#39;bye&#39;</span><span class="p">)</span> <span class="c1"># =&gt; &quot;bye Fred&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><code>Kernel#binding</code> Returns a <code>Binding</code> object, describing the variable and method bindings at the point of call. This object can be used when calling eval to execute the evaluated command in this environment.</p>

<p>Ruby also provides a predefined constant named <code>TOPLEVEL_BINDING</code>, which is just a Binding of the top-level scope.</p>

<p>You can also use <code>Proc#binding</code> to return a <code>Binding</code> object.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">get_proc</span><span class="p">(</span><span class="n">str</span><span class="p">)</span>
</span><span class="line">  <span class="o">-&gt;</span> <span class="p">{}</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">eval</span> <span class="s2">&quot;str + &#39;Fred&#39;&quot;</span><span class="p">,</span> <span class="n">get_proc</span><span class="p">(</span><span class="s1">&#39;bye&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">binding</span> <span class="c1"># =&gt; &quot;bye Fred&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">l</span> <span class="o">=</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="nb">name</span> <span class="o">=</span> <span class="s1">&#39;wendi&#39;</span> <span class="p">}</span>
</span><span class="line"><span class="nb">eval</span> <span class="s2">&quot;puts name&quot;</span><span class="p">,</span> <span class="n">l</span><span class="o">.</span><span class="n">binding</span>
</span><span class="line"><span class="c1"># =&gt; NameError: undefined local variable or method `name&#39; for main:Object`</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">bar</span>
</span><span class="line">  <span class="nb">name</span> <span class="o">=</span> <span class="s1">&#39;wendi&#39;</span>
</span><span class="line">  <span class="o">-&gt;</span> <span class="p">{}</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="nb">eval</span> <span class="s2">&quot;puts name&quot;</span><span class="p">,</span> <span class="n">bar</span><span class="o">.</span><span class="n">binding</span>
</span><span class="line"><span class="c1"># =&gt; wendi</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong><em>What’s to concern when using <code>eval</code>?</em></strong></p>

<ul>
  <li>
    <p>As it only accepts strings of codes but not blocks, it’s not editor friendly(syntax highlighting) and hard to trace syntax errors.</p>
  </li>
  <li>
    <p>Code Injection.</p>
  </li>
</ul>

<p><strong><em>What’s the soluction Ruby provided for <code>eval</code> insecurity?</em></strong></p>

<ul>
  <li>
    <p>Tainted Objects, <code>Object#tainted?</code>, <code>Object#untaint</code></p>
  </li>
  <li>
    <p>Safe Levels, <code>$SAFE</code></p>

    <ul>
      <li>0, “hippie commune”, where you can hug trees and format hard disks.</li>
      <li>Any safe level greater than 0 also causes Ruby to flat-out refuse to evaluate tainted string.</li>
      <li>2, disallows most file-related operations.</li>
      <li>3, “military dictatorship,” where every object you create is tainted by default.</li>
    </ul>
  </li>
</ul>

<p><strong><em>How to write a Sandbox for <code>eval</code>?</em></strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">ERB</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">result</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">new_toplevel</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="vi">@safe_level</span>
</span><span class="line">      <span class="nb">proc</span> <span class="p">{</span>
</span><span class="line">        <span class="vg">$SAFE</span> <span class="o">=</span> <span class="vi">@safe_level</span>
</span><span class="line">        <span class="nb">eval</span><span class="p">(</span><span class="vi">@src</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="vi">@filename</span> <span class="o">||</span> <span class="s1">&#39;(erb)&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line">      <span class="p">}</span><span class="o">.</span><span class="n">call</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="nb">eval</span><span class="p">(</span><span class="vi">@src</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="vi">@filename</span> <span class="o">||</span> <span class="s1">&#39;(erb)&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>Updated 2014-09-28</em></p>

<p>As I was looking API and fiddling around, I found 3 new methods only supported by Ruby 2.1.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">def</span> <span class="nf">foo</span>
</span><span class="line">  <span class="n">a</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line">
</span><span class="line">  <span class="nb">binding</span><span class="o">.</span><span class="n">local_variable_defined?</span><span class="p">(</span><span class="ss">:a</span><span class="p">)</span> <span class="c1"># =&gt; true</span>
</span><span class="line">  <span class="c1"># binding.eval(&quot;defined?(#{symbol}) == &#39;local-variable&#39;&quot;)</span>
</span><span class="line">
</span><span class="line">  <span class="nb">binding</span><span class="o">.</span><span class="n">local_variable_get</span><span class="p">(</span><span class="ss">:a</span><span class="p">)</span> <span class="c1">#=&gt; 1</span>
</span><span class="line">  <span class="c1"># binding.eval(&quot;#{symbol}&quot;)</span>
</span><span class="line">
</span><span class="line">  <span class="nb">binding</span><span class="o">.</span><span class="n">local_variable_set</span><span class="p">(</span><span class="ss">:a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="c1">#=&gt; 2</span>
</span><span class="line">  <span class="c1"># binding.eval(&quot;#{symbol} = #{obj}&quot;)</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review]  长发飞扬的日子]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/06/03/jiang-xin-chang-fa-fei-yang-de-ri-zi/"/>
    <updated>2014-06-03T00:34:18+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/06/03/jiang-xin-chang-fa-fei-yang-de-ri-zi</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>长发飞扬的日子</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>姜昕</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://book.douban.com/subject/6189764/">book.douban.com/subject/6189764</a></td>
    </tr>
  </tbody>
</table>

<p>阴雨连绵会让我觉得他是，好天气反而会让我坐立不安。</p>

<p>我久久地注视着那个方向，终于明白其实我们都只是在寻找我们各自的过去，而那种寻找是徒劳的。</p>

<p>爱是一种在一瞬间就忽然降临的东西，是让你猝不及防却又挥之不去的东西。如果你犹豫再三，如果你反复掂量，那它就掺进了杂质，变成了表面上与爱情类似却又远不能急的另一种情感。</p>

<p>虽然我和夏旸后来分开了，彼此也都曾给对方造成过伤害，可是，我从不怀疑他曾经对我说过的誓言——因为后来我终于知道了：誓言不见得是会实现的——年轻的誓言其实是你一生中曾经绽放的最绚烂的花朵。等到有一天，你再也听不到它而且自己也不会再说的时候，其实，那正是成长的悲哀。</p>

<p>所以，对摇滚乐这一名词，我是这样理解的：它就像当初崔健诠释他自己的名字的那句话——就是一种“摧毁”和一种“建立”。它不应该局限于任何一种和声走势，也不应该局限于任何一种表演形式或表面现象，它是“点燃”，用从一些心灵发出的声音将另外一些心灵“点燃”。</p>

<p>崔健说得特别号：“我没有老，因为我还有质疑这个世界的能力！”</p>

<p>他找到了新的方向——那一切的改变，是因为 <a href="http://en.wikipedia.org/wiki/Peter_Murphy_(musician\)">Peter Murphy</a> 在 Bauhaus 时期的两张唱片——<a href="http://www.xiami.com/album/50278?spm=0.0.0.0.vuZDIm">In The Flat Field</a>、<a href="http://www.xiami.com/album/50279?spm=0.0.0.0.vuZDIm">Mask</a>，尤其是他离开乐队之后发行的那张个人专辑 <a href="http://www.xiami.com/album/55495?spm=0.0.0.0.7DIi01">Deep</a>。</p>

<p>很多年后回头再看，我才真正意识到当年那么年轻的他能做到这一点有多么难得，他并没有因为一时的成功就忘乎所以、不可一世。而能够在名利双收的时候选择离开、在功成名就以后仍然一直将自己的注意力放在音乐上，这样的人一直是我敬佩的。</p>

<p>生活并不像我们最初想象的那样，可是，好天气还会有，所以，最傻的事情就是在一个阴霾的天气中绝望。</p>

<p>– “这些天我一直在想，当初选择做音乐到底是为了什么？难道就是为了出唱片，被好多人捧着、盯着？可那样幸福吗？”<br />
– “可你舍得放弃吗？那样你就会觉得幸福了吗？”
– “要是有一天我做的音乐一钱不值，再没有人说它们好，你会怎么想？会失望吗？”<br />
– “不会的！我相信你！”
– “所以说，这是条‘贼船’，上去就很难下来了！连你都这么想——不会的！的确，我是舍不得放弃，我已经‘中毒‘太深了……可是我怎么觉得，我的幸福也都被它毁了……我不知道我在对谁负责、谁又能对我负责！”</p>

<p>今年年初，一个偶然的早晨，我们坐在“永和豆浆”一起吃早点，又谈起那段往事，我说：“还记得吗？你那个无比美好的理想。可是为什么在我告诉你我已经爱上另一个男人的时候，你又掐着我的脖子把我堵在墙角里了？还说女人真狠！得承认你还是自私的吧？”</p>

<p>那天晚上，我拆开那个信封，里边是一张白色的硬纸壳儿，上边是一个“梦”字，不过那不仅仅是一个字，那其实是一幅画。上边“林”字的“横撇竖捺”画的是牛仔裤的侧面、牙膏牙刷、烟、打火机和笔；下面“夕”字的两撇是我和他的背影；一横是一张一百块钱的正面，四个“老人”换成了他乐队的四个人，发型怪异戴着墨镜，其中三个还分别拿着吉他、贝斯和鼓槌，那一点则是一个“？”。</p>

<p>信封里没有照片，也没有画，那同样是两张牛皮纸，只不过比信封的质地稍薄，背面是放大的石膏头像，右上角印着四行小字：</p>

<ul>
  <li>多而乱的皱纹是岁月层层叠叠的刻度  </li>
  <li>大小深浅的斑点是过去的记忆  </li>
  <li>这就是平稳平淡的艺术生活  </li>
  <li>创造出丰富的艺术生命  </li>
</ul>

<p>最后面是四个大字：  </p>

<ul>
  <li>留驻记忆</li>
</ul>

<p>如果有一天，一个人能够面容坦然地说：I’m alone, but not lonely。我以为那样的他（她）才是真的成熟了——所以，我最欣赏的气质，是坦然。</p>

<p>当我们的路通向另一个黑暗森林，追寻来时的脚步是多么困难！当路被设定好了，回归似乎不可能。生命就是我们的契约，但是除了最高法庭之外，无人能撤销它；在这样的夜里，死亡看来非常遥远，可是我们知道这是自欺欺人。我们没有时间看见最暗淡的星自我们眼角消失。当它们熄灭，我们会等待更明亮的傍晚。或者，瞻仰它们的光彩，让我们多么焦虑。我从不知有任何快乐可以不带来焦虑。但我们很愿意付出这样的代价……
– Emily Dickenson</p>

<p>那天晚上，他们玩过一个游戏，用一本不知被谁一摞的成语字典彼此算命。每个轮到的人随意选择一个页数，并且选择那一页从上到下的某个成语。大家试过，都觉得准的不行！他们是按照年龄顺序进行的，最后轮到峻峻，他是乐队里年龄最小的一个。他那一条是——风流云散。</p>

<p>仅仅两年多的时间，让一个人从“长发飞扬”到“怪毛林立”，再到“一毛不拔”，这选择和放弃到底意味着什么呢？</p>

<p>门厅中最惨烈的就是那个杯子，它粉身碎骨在一滩水渍中，就像那是它的血。</p>

<p>我们都失败过，所以应该更加懂得怎么去保护我们的镜子。他还说，我们不要像从前那样，在一份感情里交付盲目的热情，我们唯一需要交付的，是自己心里的坦然。这个世界的诱惑很多，可我们必须明白——每一次心旌摇动，即使对方不知道，那面镜子也照得见，而且它会出现裂痕。所以，如果我们只想一位地任随心意，就不要在一起；如果打算在一起，就不要欺骗那面镜子。</p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[includes vs. joins in Rails]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/06/03/rails-includes-vs-joins/"/>
    <updated>2014-06-03T00:32:18+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/06/03/rails-includes-vs-joins</id>
    <content type="html"><![CDATA[<p><code>includes</code></p>

<p>Eager load the included associations into memory. Fire two queries:</p>

<p>SELECT “products”.* FROM “products” ORDER BY name
    SELECT “categories”.* FROM “categories” WHERE “categories”.”id” IN (2, 1, 5, 4, 3)</p>

<p><code>joins</code></p>

<p>Sometimes,<code>includes</code> will load many redundant fields in association table, <code>joins</code> help to control what columns after <code>SELECT</code>.</p>

<h4 id="reference">Reference</h4>

<ul>
  <li><a href="http://stackoverflow.com/questions/1208636/rails-include-vs-joins/10129946">ruby - Rails :include vs. :joins - Stack Overflow</a></li>
  <li><a href="http://railscasts.com/episodes/181-include-vs-joins?language=zh&amp;view=asciicast">#181 Include vs Joins - RailsCasts</a></li>
  <li><a href="https://gist.github.com/ifyouseewendy/6d0feb90d76fb894814a">N+1 Benchmark Gist - IBM Developer Works</a></li>
</ul>

<hr />

<p><strong>Does query with <code>includes</code> and <code>joins</code> return the same count?</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>activerecord-includes-joins-query-count</span><a href="https://gist.github.com/ifyouseewendy/429544e5b8f49a347e95">link</a></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="k">class</span> <span class="nc">Post</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">has_many</span> <span class="ss">:comments</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Comment</span> <span class="o">&lt;</span> <span class="ss">ActiveRecord</span><span class="p">:</span><span class="ss">:Base</span>
</span><span class="line">  <span class="n">belongs_to</span> <span class="ss">:post</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">BugTest</span> <span class="o">&lt;</span> <span class="ss">Minitest</span><span class="p">:</span><span class="ss">:Test</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">test_association_stuff</span>
</span><span class="line">    <span class="n">post1</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">    <span class="n">post2</span> <span class="o">=</span> <span class="no">Post</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">
</span><span class="line">    <span class="n">post1</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">    <span class="n">post1</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">    <span class="n">post2</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">    <span class="n">post2</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">    <span class="n">post2</span><span class="o">.</span><span class="n">comments</span> <span class="o">&lt;&lt;</span> <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span>
</span><span class="line">
</span><span class="line">    <span class="n">assert_equal</span> <span class="mi">2</span><span class="p">,</span> <span class="no">Post</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">post1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">post2</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class="line">    <span class="c1"># =&gt; SELECT &quot;posts&quot;.* FROM &quot;posts&quot; WHERE &quot;posts&quot;.&quot;id&quot; IN (1, 2)</span>
</span><span class="line">    <span class="c1"># =&gt; SELECT &quot;comments&quot;.* FROM &quot;comments&quot; WHERE &quot;comments&quot;.&quot;post_id&quot; IN (1, 2)</span>
</span><span class="line">
</span><span class="line">    <span class="n">assert_equal</span> <span class="mi">5</span><span class="p">,</span> <span class="no">Post</span><span class="o">.</span><span class="n">joins</span><span class="p">(</span><span class="ss">:comments</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">id</span><span class="p">:</span> <span class="o">[</span><span class="n">post1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">post2</span><span class="o">.</span><span class="n">id</span><span class="o">]</span><span class="p">)</span><span class="o">.</span><span class="n">count</span>
</span><span class="line">    <span class="c1"># =&gt; SELECT COUNT(*) FROM &quot;posts&quot; INNER JOIN &quot;comments&quot; ON &quot;comments&quot;.&quot;post_id&quot; = &quot;posts&quot;.&quot;id&quot; WHERE &quot;posts&quot;.&quot;id&quot; IN (1, 2)</span>
</span><span class="line">
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Does <code>includes</code> work with Mongoid?</strong> </p>

<p>Check list:</p>

<ul>
  <li><a href="http://stackoverflow.com/questions/3912706/n1-problem-in-mongoid">N+1 problem in mongoid - Stack Overflow</a></li>
  <li><a href="http://mongoid.org/en/mongoid/docs/querying.html#queries">Eager Loading - Mongoid Doc</a></li>
</ul>

<p>By now ( <em>2014-05-08</em> ) the latest version <em>4.0.0.beta1</em> behaves much better than last stable version <em>3.1.6</em>, check the <a href="https://gist.github.com/ifyouseewendy/0069c0498274d2dd5a6d">gist</a>.</p>

<p><img src="https://dl.dropboxusercontent.com/s/ol5lajw9z9hwaca/rails-includes_vs_joins_selected.png?dl=1&amp;token_hash=AAE9IXia0UGrhtp5vqQRQHLWGOydmyjeTXuuek6Kg-CtOA&amp;expiry=1399564547" alt="rails-includes_vs_joins" /></p>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review]  我所理解的生活]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/05/18/han-han-wo-suo-li-jie-de-sheng-huo/"/>
    <updated>2014-05-18T18:00:46+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/05/18/han-han-wo-suo-li-jie-de-sheng-huo</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>我所理解的生活</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>韩寒</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://book.douban.com/subject/20425053/">book.douban.com/subject/20425053</a></td>
    </tr>
  </tbody>
</table>

<p>这世道觉得文绉绉的诬陷没问题，这世道让那些不说粗话但最缺德的人能做道德评判家，这世道让那些话不脏但心眼脏、手段脏的人当道，这世道能任意颠倒黑白、混淆是非，这世道觉得公众人物或者随便谁说一个“操”字就不应该，那就操翻这世道。</p>

<p>很多人恨特权，因为特权没有在自己手中。</p>

<p>还有某些人开会制定了应对措施，这些措施中甚至包括联合一些专职黑我的人再次对我进行诽谤和攻击。当然，最后这些没有实施，因为他们发现所谓黑，都是无需组织的，我如果说饭能吃屎不能吃，他们都能捧着马桶干杯。</p>

<p>缘分不是走在街上非要撞见，缘分就是睡前醒后彼此想念。</p>

<p>没人能让所有人满意，所以让自己和你中意的人满意就可以了。你所判定的一切，也许就是你自己内心的投影。</p>

<p>我也将尽我所能，为在乎我的人创造各种东西，绝不向厌恶我的人解释这是个什么东西。</p>

<p>我是一个虚荣的人，有时候甚至还虚伪。由于我得到的越来越多，所以也可以假装越来越不虚荣，因为有了一些真荣。但我的内心还是虚荣的。不出席所有颁奖典礼、不去各种上流场合其实是另外一种虚荣，并不是淡泊。</p>

<p>开了几天的微博，我陷入了一种意淫的豪迈。</p>

<p>我越来越觉得很多东西的结果，其实并不是不同人的改变，而只是同类人的聚集。在我的微博马甲里，你觉得这个政府糟透了，时日不多。在别人的微博马甲里，你觉得生活挺安逸的，一切都好。所以，你所关注的一切，就是你所看到的世界。</p>

<p>每个人的道路都不同，我走在我的野路上，她走在她的大路上，都值得祝福。只要不走歪路邪路，每条道路都有成功的方式。黄思路也是，</p>

<p>你知道你能做到，别人觉得你也许可以做到，那么，少废话，做到再说，其他的怨气都是虚妄。</p>

<p>这枚碎片不是新型的，也不是心形的，它的不规则是规则的。</p>

<p>至少在文字中你很擅长论理，对你来说，论理这个事，最重要的一点是什么？我觉得论理最重要的一点就是不用典。</p>

<p>互联网多年，出现了很多聪明人，但完全没能稀释这个世界上笨蛋的浓度。</p>

<p>写作三种：说服你，拉拢他，剖析我。最早的我一直在第一种，后来发现容易背叛自己。于是我到了第二种，又发现容易迎合大众。我一直在去往第三种，路上有反复，有踌躇，有代价，有痛苦，但那才是一个真正的写作者要去的地方。否则你只是一个饭局作家，一个去了香港买了本地摊杂志就假装知道中国政治内幕。</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[[Review] The Rails 4 Way - Environments and Configurations]]></title>
    <link href="http://blog.ifyouseewendy.com/blog/2014/05/18/the-rails-4-way-environments-and-configurations/"/>
    <updated>2014-05-18T16:10:42+08:00</updated>
    <id>http://blog.ifyouseewendy.com/blog/2014/05/18/the-rails-4-way-environments-and-configurations</id>
    <content type="html"><![CDATA[<table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>The Rails 4 Way</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>Obie Fernandez, Kevin Faustino, Vitaly Kushner</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://amzn.com/0321944275">amzn.com/0321944275</a></td>
    </tr>
  </tbody>
</table>

<h2 id="bundler-refhttpbundlerio">Bundler <a href="http://bundler.io">ref</a></h2>

<p>Bundler does gem dependency resolution based on Gemfile.</p>

<h4 id="operator"><code>~&gt;</code> operator</h4>

<p>The specifier <strong>~&gt;</strong> has a special meaning, best shown by example. <code>~&gt; 2.0.3</code> is identical to <code>&gt;= 2.0.3</code> and <code>&lt; 2.1</code>. <code>~&gt; 2.1</code> is identical to <code>&gt;= 2.1</code> and <code>&lt; 3.0</code>. <code>~&gt; 2.2.beta</code> will match prerelease versions like <code>2.2.beta.12</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>hello linenos:false</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">gem</span> <span class="s1">&#39;thin&#39;</span><span class="p">,</span>  <span class="s1">&#39;~&gt;1.1&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="require"><code>require</code></h4>

<p>Occasionally, the name of the gem that should be used in a require statement is
different than the name of that gem in the repository. In those cases, the <strong>:require</strong>
option solves this simply and declaratively right in the Gemfile.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">gem</span> <span class="s1">&#39;sqlite3-ruby&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="s1">&#39;sqlite3&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="group">group</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">gem</span> <span class="s1">&#39;wirble&#39;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="ss">:development</span>
</span><span class="line"><span class="n">gem</span> <span class="s1">&#39;ruby-debug&#39;</span><span class="p">,</span> <span class="ss">:group</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">group</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class="line">  <span class="n">gem</span> <span class="s1">&#39;rspec&#39;</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="bundle-installupdate">bundle install/update</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">-&gt;</span> <span class="n">calculate</span> <span class="n">a</span> <span class="n">dependency</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="n">generate</span> <span class="no">Gemfile</span><span class="o">.</span><span class="n">lock</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="bundle-package">bundle package</h4>

<blockquote>
  <p>it will package up all your gems in <strong>vendor/cache</strong> directory. Running <strong>bundle install</strong> will use the gems in package and skip connecting to rubygems.org. use this to avoid external dependencies at deploy time, or if you depend on private gems that you are not available in any public repository.</p>
</blockquote>

<h4 id="bundle-exec">bundle exec</h4>

<p>Non-Rails scripts must be executed with this to get a properly initialized RubyGems environment.</p>

<h4 id="bundle-install---path-venderbundle---binstubs">bundle install –path vender/bundle –binstubs</h4>

<p>The default location for gems installed by bundler is directory named <strong>.bundle</strong> in your user directory.</p>

<p>This command will generate <strong>.bundle/config</strong> file:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span>.bundle/config</span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="o">---</span>
</span><span class="line"><span class="no">BUNDLE_BIN</span><span class="p">:</span> <span class="n">bundler_stubs</span>
</span><span class="line"><span class="no">BUNDLE_PATH</span><span class="p">:</span> <span class="n">vendor</span><span class="o">/</span><span class="n">bundle</span>
</span><span class="line"><span class="no">BUNDLE_DISABLE_SHARED_GEMS</span><span class="p">:</span> <span class="s2">&quot;1&quot;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>gems in <strong>verdor/cache</strong>, and installed in <strong>vendor/bundle</strong>.</p>

<h4 id="bundle-install-vendor---disable-shared-gems">bundle install vendor –disable-shared-gems</h4>

<blockquote>
  <p>This command tells Bundler to install gems even if they are already installed in the system. Normally Bunlder avoids that symlinks to already downloaded gems that exists in your system. This option is useful when you are trying to package up an application that all dependencies unpacked.</p>
</blockquote>

<h2 id="startup-and-application-settings">Startup and Application Settings</h2>

<p><code>boot.rb</code></p>

<ul>
  <li>sets up Bundler and load paths</li>
</ul>

<p><code>application.rb</code></p>

<ul>
  <li>require ‘boot’</li>
  <li>load rails gems, gems for the specified Rail.env, and configures the application ( <strong>define Application class</strong> ).</li>
</ul>

<p><code>environment.rb</code></p>

<ul>
  <li>require ‘application’</li>
  <li>runs all initializers ( <code>Application.initialize!</code> )</li>
</ul>

<p><code>environments/development.rb | test.rb | production.rb</code></p>

<ul>
  <li>makes environmental configuraions.</li>
  <li>application.rb makes unenvironmental configurations, like time-zone, autoload_paths, encoding.</li>
</ul>

<h2 id="configurations">Configurations</h2>

<h4 id="wrap-parameters">Wrap Parameters</h4>

<p>Introduced in Rails 3.1, the <code>wrap_parameters.rb</code> initializer configures your application to work with JavaScript MVC frameworks.</p>

<p>When submitting JSON parameters to a controller, Rails will wrap the parameters into a nested hash, with the controller’s name being set as the key. To illustrate, consider the following JSON:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;TheRails4Way&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If a client submitted the above JSON to a controller named ArticlesController, Rails would nest the params hash under the key “article”. This ensures the setting of model attributes from request parameters is consistent with the convention used when submitting from Rails form helpers.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;TheRails4Way&quot;</span><span class="p">,</span> <span class="s2">&quot;article&quot;</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;TheRails4Way&quot;</span><span class="p">}}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h4 id="schema-dumper">Schema Dumper</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">schema_format</span> <span class="o">=</span> <span class="ss">:sql</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Every time you run tests, Rails dumps the schema of your development database and copies it to the test database using an auto generated <code>schema.rb</code> script. It looks very similar to an Active Record migration script; in fact, it uses the same API.</p>

<h4 id="automatic-class-reloading">Automatic Class Reloading</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">cache_classes</span> <span class="o">=</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Without getting into too much nitty-gritty detail, when the config.cache_classes setting is true,Rails willuse Ruby’s <code>require</code> statement to do its class loading, and when it is false, it will use <code>load</code> instead.</p>

<p>When you require a Ruby file, the interpreter executes and caches it. If the file is required again (as in subsequent requests), the interpreter ignores the require statement and moves on. When you load a Ruby file, the interpreter executes the file again, no matter how many times it has been loaded before.</p>

<h4 id="auto-loading-code">Auto-Loading Code</h4>

<p>By following the naming convention, Rails will search <code>$LOAD_PATH</code> to find the undefined constant. So when using Rails console, <strong>you never have to explicitly <code>require</code> anything!</strong></p>

<p>Rails takes advantage of the fact that Ruby provides a callback mechanism for missing constants. When Rails encounters an undefined constant in the code, it uses a class loader routine based on file-naming conventions to find and require the needed Ruby script.</p>

<h4 id="eager-load">Eager Load</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">eager_load</span> <span class="o">=</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>In your production environment, you will want this set to true, as it copies most of your application in memory. This provides a performance increase to web servers that copy on write, such as Unicorn.</p>

<h4 id="explain-for-slow-queries">Explain for Slow Queries</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">active_record</span><span class="o">.</span><span class="n">auto_explain_threshold_in_seconds</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Introduced in Rails 3.2, Active Record now monitors the threshold of SQL queries being made. If any query takes longer than the specified threshold, the query plan is logged with a warning.</p>

<h4 id="assets">Assets</h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Setting config.assets.debug to false, would result in Sprockets concatenating and running preprocessors on all assets.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">compile</span> <span class="o">=</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>If an asset is requested that does not exist in the public/assets folder, Rails will throw an exception. To enable live asset compilation fallback on production, set config.assets.compile to true.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">assets</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="kp">false</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Like most features in Rails, the usage of the Asset Pipeline is completely optional. To include assets in your project as it was done in Rails 3.0, set config.assets.enabled to false.</p>

<h4 id="tagged-logging-refhttparunim2011x-request-id-tracking-taggedlogging-rails">Tagged Logging <a href="http://arun.im/2011/x-request-id-tracking-taggedlogging-rails">ref</a></h4>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span class="n">config</span><span class="o">.</span><span class="n">log_tags</span> <span class="o">=</span> <span class="o">[</span> <span class="ss">:subdomain</span><span class="p">,</span> <span class="ss">:uuid</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Rails 3.2 introduced the ability to tag your log messages. <code>:subdomain</code> example by <em>www</em>, <code>:uuid</code> is a string to identify request, try <code>request.uuid</code>.</p>
]]></content>
  </entry>
  
</feed>
