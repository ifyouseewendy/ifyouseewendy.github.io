



<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>[Review] Design Patterns in Ruby - Wendi's Blog</title>
  <meta http-equiv="Content-Type" content="text/html" />
  <meta name="author" content="wendi">

  
  <meta name="description" content="Books, Ruby Oct 17th, 2014 [Review] Design Patterns in Ruby Book Design Patterns in Ruby Author Russ Olsen Link designpatternsinruby.com Meta Design &hellip;">
  <meta name="keywords" content="Ruby, Rails, Tech, Web"/>
  

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://blog.ifyouseewendy.com/blog/2014/10/17/design-patterns-in-ruby">
  <link href="/favicon.td.png" rel="icon">
  <link href="/stylesheets/styles.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Wendi's Blog" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/jquery-1.9.1.min.js"></script>
  <script src="/javascripts/octopress.js"></script>
  <script src="/javascripts/jquery.sidr.min.js"></script>
  <script src="/javascripts/ah-blue.js"></script>
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-48830538-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head> 

<body   >
  <div class="aux-container">
    <a id="nav-toggle" href="#sidr"></a>
    <a id="search-toggle"></a>
</div>

<header class="header-container clearfix">
  <!-- <a href="/"><img src="/images/ah-frame.svg" onerror="this.onerror=null; this.src='ah-frame.png'"></a> -->
  <a href='/'>
    <img src="/images/portrait-2019.jpg" width="200" height="200" title="wendi" >
  </a>
</header>


  <div class="main-container">
    <div class="main wrapper clearfix" >
    	
    	<aside>
        
          <div class="search-container">
            <form action="http://google.com/search" method="get">
              <fieldset role="search">
                <input type="hidden" name="q" value="site:blog.ifyouseewendy.com" />
                <input class="search-field" type="text" name="q" results="0" placeholder=""/>
                <input class="submit" type="submit" value=""/>
              </fieldset>
            </form>
          </div>
        
        <div id="main-nav">
    <nav>
        <ul>
        	<li>
        		
              <!-- <h3>Tags</h3> -->


<h3>Recent Posts</h3>
<ul>
	
    <li>
    	<a href="/blog/2022/12/31/what-ive-done-in-2022/">What I've Done in 2022</a>
    </li>
    
    <li>
    	<a href="/blog/2021/01/11/what-ive-done-in-2021/">What I've Done in 2021</a>
    </li>
    
    <li>
    	<a href="/blog/2021/01/01/what-weve-done-in-2020/">What We've Done in 2020</a>
    </li>
    
    <li>
    	<a href="/blog/2020/06/07/review-soe-ycscs1-compilers/">[Review] SOE-YCSCS1 Compilers</a>
    </li>
    
    <li>
    	<a href="/blog/2020/01/13/what-ive-done-in-2020/">What I've Done in 2020</a>
    </li>
    
</ul>


            
        	</li>
        	<li>
        		<ul>
                <li>Github - <a href="http://www.github.com/ifyouseewendy" target="_blank">github.com/ifyouseewendy</a></li>
                <li>Twitter - <a href="http://www.twitter.com/ifyouseewendy" target="_blank">@ifyouseewendy</a></li>
                <li>Email - <a href="mailto:ifyouseewendy@gmail.com" target="_blank">ifyouseewendy at gmail</a></li>
        		</ul>
        	</li>
        </ul>
    </nav>
</div>

      </aside>
      
      <div>
<article>
	<header>
  
    <div class="article-tags">
        

<span class="categories">
  
    <a class='category' href='/blog/categories/books/'>Books</a>, <a class='category' href='/blog/categories/ruby/'>Ruby</a>
  
</span>


        








  




<span class='date'>
  <a href='#'>Oct 17<span>th</span>, 2014</a>
</span>

    </div>
    <h1>
      [Review] Design Patterns in Ruby
    </h1>
  
</header>


  <section><table class="custom">
  <tbody>
    <tr>
      <td><strong>Book</strong></td>
      <td>Design Patterns in Ruby</td>
    </tr>
    <tr>
      <td><strong>Author</strong></td>
      <td>Russ Olsen</td>
    </tr>
    <tr>
      <td><strong>Link</strong></td>
      <td><a href="http://designpatternsinruby.com/">designpatternsinruby.com</a></td>
    </tr>
  </tbody>
</table>

<ul id="markdown-toc">
  <li><a href="#meta-design-pattern" id="markdown-toc-meta-design-pattern">Meta Design Pattern</a></li>
  <li><a href="#about-design-pattern" id="markdown-toc-about-design-pattern">About Design Pattern</a></li>
  <li><a href="#design-pattern-classification" id="markdown-toc-design-pattern-classification">Design Pattern Classification</a></li>
  <li><a href="#the-template-method" id="markdown-toc-the-template-method">The Template Method</a>    <ul>
      <li><a href="#description" id="markdown-toc-description">Description</a></li>
      <li><a href="#using-and-abusing" id="markdown-toc-using-and-abusing">Using and Abusing</a></li>
      <li><a href="#in-the-wild" id="markdown-toc-in-the-wild">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-strategy" id="markdown-toc-the-strategy">The Strategy</a>    <ul>
      <li><a href="#description-1" id="markdown-toc-description-1">Description</a></li>
      <li><a href="#comparing-to-the-template-method" id="markdown-toc-comparing-to-the-template-method">Comparing to the Template Method</a></li>
      <li><a href="#sharing-data-between-the-context-and-strategy" id="markdown-toc-sharing-data-between-the-context-and-strategy">Sharing Data between the Context and Strategy</a></li>
      <li><a href="#using-and-abusing-1" id="markdown-toc-using-and-abusing-1">Using and Abusing</a></li>
      <li><a href="#in-the-wild-1" id="markdown-toc-in-the-wild-1">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-observer" id="markdown-toc-the-observer">The Observer</a>    <ul>
      <li><a href="#description-2" id="markdown-toc-description-2">Description</a></li>
      <li><a href="#code-usage" id="markdown-toc-code-usage">Code Usage</a></li>
      <li><a href="#interfaces-pull-or-push" id="markdown-toc-interfaces-pull-or-push">Interfaces. Pull or Push?</a></li>
      <li><a href="#using-and-abusing-2" id="markdown-toc-using-and-abusing-2">Using and Abusing</a></li>
      <li><a href="#in-the-wild-2" id="markdown-toc-in-the-wild-2">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#composite" id="markdown-toc-composite">Composite</a>    <ul>
      <li><a href="#description-3" id="markdown-toc-description-3">Description</a></li>
      <li><a href="#code-usage-1" id="markdown-toc-code-usage-1">Code Usage</a></li>
      <li><a href="#concerns" id="markdown-toc-concerns">Concerns</a></li>
      <li><a href="#using-and-abusing-3" id="markdown-toc-using-and-abusing-3">Using and Abusing</a></li>
      <li><a href="#in-the-wild-3" id="markdown-toc-in-the-wild-3">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-iterator" id="markdown-toc-the-iterator">The Iterator</a>    <ul>
      <li><a href="#description-4" id="markdown-toc-description-4">Description</a></li>
      <li><a href="#internal-iterators-vs-external-iterators" id="markdown-toc-internal-iterators-vs-external-iterators">Internal Iterators vs. External Iterators</a></li>
      <li><a href="#the-inimitable-enumerable" id="markdown-toc-the-inimitable-enumerable">The Inimitable Enumerable</a></li>
      <li><a href="#using-and-abusing-4" id="markdown-toc-using-and-abusing-4">Using and Abusing</a></li>
      <li><a href="#in-the-wild-4" id="markdown-toc-in-the-wild-4">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-command" id="markdown-toc-the-command">The Command</a>    <ul>
      <li><a href="#description-5" id="markdown-toc-description-5">Description</a></li>
      <li><a href="#keep-track-of-what-you-have-done" id="markdown-toc-keep-track-of-what-you-have-done">Keep Track of What You Have Done</a></li>
      <li><a href="#undo-or-redo" id="markdown-toc-undo-or-redo">Undo or Redo</a></li>
      <li><a href="#queuing-up-commands" id="markdown-toc-queuing-up-commands">Queuing Up Commands</a></li>
      <li><a href="#using-and-abusing-5" id="markdown-toc-using-and-abusing-5">Using and Abusing</a></li>
      <li><a href="#in-the-wild-5" id="markdown-toc-in-the-wild-5">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-adapter" id="markdown-toc-the-adapter">The Adapter</a>    <ul>
      <li><a href="#description-6" id="markdown-toc-description-6">Description</a></li>
      <li><a href="#adapt-or-modify" id="markdown-toc-adapt-or-modify">Adapt or Modify?</a></li>
      <li><a href="#using-and-abusing-6" id="markdown-toc-using-and-abusing-6">Using and Abusing</a></li>
      <li><a href="#in-the-wild-6" id="markdown-toc-in-the-wild-6">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-proxy" id="markdown-toc-the-proxy">The Proxy</a>    <ul>
      <li><a href="#description-7" id="markdown-toc-description-7">Description</a></li>
      <li><a href="#the-protection-proxy" id="markdown-toc-the-protection-proxy">The Protection Proxy</a></li>
      <li><a href="#the-remove-proxy" id="markdown-toc-the-remove-proxy">The Remove Proxy</a></li>
      <li><a href="#the-virtual-proxy" id="markdown-toc-the-virtual-proxy">The Virtual Proxy</a></li>
      <li><a href="#using-and-abusing-7" id="markdown-toc-using-and-abusing-7">Using and Abusing</a></li>
      <li><a href="#in-the-wild-7" id="markdown-toc-in-the-wild-7">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#the-decorator" id="markdown-toc-the-decorator">The Decorator</a>    <ul>
      <li><a href="#description-8" id="markdown-toc-description-8">Description</a></li>
      <li><a href="#why-not-the-template-method" id="markdown-toc-why-not-the-template-method">Why Not The Template Method?</a></li>
      <li><a href="#code-usage-2" id="markdown-toc-code-usage-2">Code Usage</a></li>
      <li><a href="#using-and-abusing-8" id="markdown-toc-using-and-abusing-8">Using and Abusing</a></li>
      <li><a href="#in-the-wild-8" id="markdown-toc-in-the-wild-8">In the Wild</a></li>
      <li><a href="#adapter-proxy-or-decorator" id="markdown-toc-adapter-proxy-or-decorator">Adapter, Proxy or Decorator</a></li>
    </ul>
  </li>
  <li><a href="#singleton" id="markdown-toc-singleton">Singleton</a>    <ul>
      <li><a href="#code-usage-3" id="markdown-toc-code-usage-3">Code Usage</a></li>
      <li><a href="#alternatives" id="markdown-toc-alternatives">Alternatives</a></li>
      <li><a href="#using-and-abusing-9" id="markdown-toc-using-and-abusing-9">Using and Abusing</a></li>
      <li><a href="#in-the-wild-9" id="markdown-toc-in-the-wild-9">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#factory" id="markdown-toc-factory">Factory</a>    <ul>
      <li><a href="#description-9" id="markdown-toc-description-9">Description</a></li>
      <li><a href="#abstract-factory" id="markdown-toc-abstract-factory">Abstract Factory</a></li>
      <li><a href="#factory--abstract-factory" id="markdown-toc-factory--abstract-factory">Factory &amp;&amp; Abstract Factory</a></li>
      <li><a href="#using-and-abusing-10" id="markdown-toc-using-and-abusing-10">Using and Abusing</a></li>
      <li><a href="#in-the-wild-10" id="markdown-toc-in-the-wild-10">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#builder" id="markdown-toc-builder">Builder</a>    <ul>
      <li><a href="#description-10" id="markdown-toc-description-10">Description</a></li>
      <li><a href="#code-usage-4" id="markdown-toc-code-usage-4">Code Usage</a></li>
      <li><a href="#builders-can-ensure-sane-objects" id="markdown-toc-builders-can-ensure-sane-objects">Builders Can Ensure Sane Objects</a></li>
      <li><a href="#resuable-buidlers" id="markdown-toc-resuable-buidlers">Resuable Buidlers</a></li>
      <li><a href="#better-builders-with-magic-methods" id="markdown-toc-better-builders-with-magic-methods">Better Builders with Magic Methods</a></li>
      <li><a href="#using-and-abusing-11" id="markdown-toc-using-and-abusing-11">Using and Abusing</a></li>
      <li><a href="#in-the-wild-11" id="markdown-toc-in-the-wild-11">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#interpreter" id="markdown-toc-interpreter">Interpreter</a>    <ul>
      <li><a href="#description-11" id="markdown-toc-description-11">Description</a></li>
      <li><a href="#with-a-parser" id="markdown-toc-with-a-parser">With a Parser</a></li>
      <li><a href="#without-a-parser" id="markdown-toc-without-a-parser">Without a Parser</a></li>
      <li><a href="#using-and-abusing-12" id="markdown-toc-using-and-abusing-12">Using and Abusing</a></li>
      <li><a href="#in-the-wild-12" id="markdown-toc-in-the-wild-12">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#domain-specific-languages" id="markdown-toc-domain-specific-languages">Domain-Specific Languages</a>    <ul>
      <li><a href="#description-12" id="markdown-toc-description-12">Description</a></li>
      <li><a href="#using-and-abusing-13" id="markdown-toc-using-and-abusing-13">Using and Abusing</a></li>
      <li><a href="#in-the-wild-13" id="markdown-toc-in-the-wild-13">In the Wild</a></li>
    </ul>
  </li>
  <li><a href="#custom-objects" id="markdown-toc-custom-objects">Custom Objects</a>    <ul>
      <li><a href="#custom-tailoring-technique" id="markdown-toc-custom-tailoring-technique">Custom-Tailoring Technique</a></li>
      <li><a href="#reflections" id="markdown-toc-reflections">Reflections</a></li>
      <li><a href="#using-and-abusing-14" id="markdown-toc-using-and-abusing-14">Using and Abusing</a></li>
    </ul>
  </li>
  <li><a href="#convention-over-configuration" id="markdown-toc-convention-over-configuration">Convention Over Configuration</a>    <ul>
      <li><a href="#description-13" id="markdown-toc-description-13">Description</a></li>
      <li><a href="#using-and-abusing-15" id="markdown-toc-using-and-abusing-15">Using and Abusing</a></li>
    </ul>
  </li>
  <li><a href="#reference" id="markdown-toc-reference">Reference</a></li>
</ul>

<h2 id="meta-design-pattern">Meta Design Pattern</h2>

<ul>
  <li>Seperate out the things that change from thos that stay the same.</li>
  <li>Program to an interface, not an implementation.</li>
  <li>Prefer composition over inheritance.</li>
  <li>Delegate, delegate, delegate.</li>
</ul>

<p>Others:</p>

<ul>
  <li>YAGNI, You ain’t gonna need it.</li>
  <li>A pattern is not just about code: Intent is critical.</li>
</ul>

<p><strong>Seperate out the things that change from thos that stay the same.</strong></p>

<p>A key goal of software engineering is to build systems that allow us to contain the damage. In an ideal system, all changes are local.</p>

<p>You get there by separating the things that are likely to change from the things that are likely to stay the same. If you can identify which aspects of your system design are likely to change, you can isolate those bits from the more stable parts.</p>

<p>But how do you keep the changing parts from infecting the stable parts? <em>Program to an interface, not an implementation.</em></p>

<p><strong>Program to an interface, not an implementation.</strong></p>

<p>A good start is to write code that is less tightly coupled to itself in the first place.</p>

<p>The idea here is to program to the most general type you can.</p>

<p><strong>Prefer composition over inheritance.</strong></p>

<p>The trouble is that inheritance comes with some unhappy strings attached. When you create a subclass of an existing class, you are not really creating two separate entities: Instead, you are making two classes that are bound together by a common implementation core. Inheritance, by its very nature, tends to marry the subclass to the superclass.</p>

<p>If our goal is to build systems that are not tightly coupled together, to build systems where a single change does not ripple through the code like a sonic boom, breaking the glassware as it goes, then probably we should not rely on inheritance as much as we do.</p>

<p>We can assemble the behaviors we need through composition. In short, we try to avoid saying that an object is <em>a kind of</em> something and instead say that it <em>has</em> something.</p>

<p><strong>Delegate, delegate, delegate.</strong></p>

<p>The combination of composition and delegation is a powerful and flexible alternative to inheritance. We get most of the benefits of inheritance, much more flexibility, and none of the unpleasant side effects. Of course, nothing comes for free. Delegation requires an extra method call, as the delegating object passes the buck along. This extra method call will have some performance cost—but in most cases, it will be very minor.</p>

<p>Another cost of delegation is the boilerplate code you need to write.</p>

<p><strong>YAGNI, You ain’t gonna need it.</strong></p>

<p>You Ain’t Gonna Need It (YAGNI for short). The YAGNI principle says simply that you should not implement features, or design in flexibility, that you don’t need right now.</p>

<p>A well-designed system is one that will flex gracefully in the face of bug fixes, changing requirements, the ongoing march of technology, and inevitable redesigns. The YAGNI principle says that you should focus on the things that you need right now, building in only the flexibility that you know you need.</p>

<p>The use of design patterns has somehow become associated with a particularly virulent strain of over-engineering, with code that tries to be infinitely flexible at the cost of being understandable, and maybe even at the cost of just plain working. The proper use of design patterns is the art of making your system just flexible enough to deal with the problems you have today, but no more.</p>

<p>Your system will not work better because you used all 23 of the GoF design patterns in every possible combination. Your code will work better only if it focuses on the job it needs to do right now.</p>

<h2 id="about-design-pattern">About Design Pattern</h2>

<p>Background</p>

<blockquote>
  <p>In 1995, Erich Gamma, Richard Helm, Ralph Johnson, and John Vlissides set out to redirect all the effort going into building redundant software wheels into something more useful. That year, building on the work of Christopher Alexander, Kent Beck, and others, they published Design Patterns: Elements of Reusable Object-Oriented Software. The book was an instant hit, with the authors rapidly becoming famous (at least in software engineering circles) as the Gang of Four (GoF).</p>
</blockquote>

<p>Focus on some key questions:</p>

<ul>
  <li>How do objects like the ones you tend to find in most systems relate to one another?</li>
  <li>How should they be coupled together?</li>
  <li>What should they know about each other?</li>
  <li>How can we swap out parts that are likely to change frequently?</li>
</ul>

<p>It’s commonly agreed that the most useful thing about patterns is the way in which they form a vocabulary for articulating design decisions during the normal course of development conversations among programmers.</p>

<p>Design patterns are little spring-loaded solutions to common programming problems. And a reckless use of every design pattern on the menu to solve nonexistent problems gives design patterns a bad name in some circles.</p>

<p><strong>With Ruby</strong></p>

<p>With Ruby, we no longer need to pull out relatively heavyweight design patterns to solve tiny problems. Instead, Ruby allows you to do simple things simply.</p>

<ul>
  <li>
    <p>Like a Command object in the GoF sense is essentially a wrapper around some code that knows how to do one specific thing, to run a particular bit of code at some time. Of course, that is also a fairly accurate description of a Ruby code block object or a <code>Proc</code>.</p>
  </li>
  <li>
    <p>Internal Domain Specific Languages. I believe that his treatment of the subject, as an evolution of the Interpreter pattern, is the first significant reference work in publication on the topic.</p>
  </li>
</ul>

<p>The Ruby programming language makes implementing patterns so easy that sometimes they fade into the background.</p>

<ul>
  <li>Ruby is dynamically typed.</li>
  <li>Ruby has code closures.</li>
  <li>Ruby classes are real objects.</li>
  <li>Ruby has an elegant system of code reuse.</li>
</ul>

<p>The traditional implementations of many design patterns work, but they make you work, too. Ruby allows you to concentrate on the real problems that you are trying to solve instead of the plumbing.</p>

<p>The increasing industry recognition of the value of dynamic and flexible languages such as Ruby has plunged us into yet another wisdom gap.</p>

<blockquote>
  <p>Design Patterns was published in the need for wisdom.</p>

  <p>Bruce Tate is fond of pointing out that when a new programming technique or language pops up, there is frequently a wisdom gap. The industry needs time to come to grips with the new technique, to figure out the best way to apply it. How many years had to elapse between the first realization that object-oriented programming was the way to go and the time when we really began to use object-oriented technology effectively? Those years were the object-oriented wisdom gap.</p>
</blockquote>

<h2 id="design-pattern-classification">Design Pattern Classification</h2>

<p><strong>Creational</strong> (5)</p>

<ul>
  <li>Factory Method</li>
  <li>Abstract Factory</li>
  <li>Builder</li>
  <li>Prototype</li>
  <li>Singleton</li>
</ul>

<p><strong>Structural</strong> (7)</p>

<ul>
  <li>Facade</li>
  <li>Adapter</li>
  <li>Proxy</li>
  <li>Decorator</li>
  <li>Bridge</li>
  <li>Composite</li>
  <li>Flyweight</li>
</ul>

<p><strong>Behavioural</strong> (11)</p>

<ul>
  <li>Template Method</li>
  <li>Observer</li>
  <li>State</li>
  <li>Strategy</li>
  <li>Chain of Responsibility</li>
  <li>Command</li>
  <li>Visitor</li>
  <li>Mediator</li>
  <li>Memento</li>
  <li>Iterator</li>
  <li>Interpreter</li>
</ul>

<h2 id="the-template-method">The Template Method</h2>

<p>Basic idea is <em>Seperate out the things that change from thos that stay the same.</em></p>

<h3 id="description">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/template-method.png" alt="template-method" /></p>

<ol>
  <li>Extract the common part into an abstract base class</li>
  <li>Create some hook methods as the interface</li>
  <li>Let the subclass to implement it</li>
</ol>

<p>The Template Method pattern is simply a fancy way of saying that if you want to vary an algorithm, one way to do so is to code the invariant part in a base class and to encapsulate the variable parts in methods that are defined by a number of subclasses.</p>

<p>The abstract base class controls the higher-level processing through the template method; the sub-classes simply fill in the details.</p>

<p>Non-abstract methods that can be overridden in the concrete classes of the Template Method pattern are called <strong>hook methods</strong>.</p>

<p>Duck typing is a trade-off: You give up the compile-time safety of static typing, and in return you get back a lot of code clarity and programming flexibility.</p>

<h3 id="using-and-abusing">Using and Abusing</h3>

<p>The Template Method pattern is at its best when it is at its leanest—that is, when every abstract method and hook is there for a reason. Try to avoid creating a template class that requires each subclass to override a huge number of obscure methods just to cover every conceivable possibility. You also do not want to create a template class that is encrusted with a multitude of hook methods that no one will ever override.</p>

<h3 id="in-the-wild">In the Wild</h3>

<p>There is another very common example of the Template Method pattern that is perhaps so pervasive that it is hard to see. Think about the <code>initialize</code> method that we use to set up our objects. All we know about <code>initialize</code> is that it is called sometime toward the end of the process of creating a new object instance and that it is a method that we can override in our class to do any specific initialization. Sounds like a hook method to me.</p>

<p><code>Class#new</code> calls <code>allocate</code> first, then <code>initialise</code>. Every class inherits the <code>new</code> method, and defines its own concrete <code>initialise</code> method. So, we can treat <code>Class#new</code> as a template method, and <code>initialise</code> as a hook method.</p>

<h2 id="the-strategy">The Strategy</h2>

<p>Basic idea is <em>Delegate, delegate, delegate</em> and <em>Prefer composition over inheritance</em>.</p>

<h3 id="description-1">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/strategy.png" alt="strategy" /></p>

<ol>
  <li>Pull the algorithm out into a seperate “strategy” object.</li>
  <li>All of the startegy objects support the same interface.</li>
  <li>Let the context choose.</li>
</ol>

<p>Given that all of the strategy objects look alike from the outside, the user of the strategy—called the <strong>context</strong> class by the GoF—can treat the strategies like interchangeable parts.</p>

<h3 id="comparing-to-the-template-method">Comparing to the Template Method</h3>

<p>The Template Method pattern is built around inheritance.</p>

<p>No matter how carefully you design your code, your subclasses are tangled up with their superclass: It is in the nature of the relationship. On top of this, inheritance-based techniques such as the Template Method pattern limit our runtime flexibility. Once we have selected a particular variation of the algorithm—in our example, once we have created an instance of HTMLReport—changing our mind is hard.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="c1"># The Template Method</span>
</span><span class="line"><span class="n">report</span> <span class="o">=</span> <span class="no">HTMLReport</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">report</span><span class="o">.</span><span class="n">output_report</span>
</span><span class="line"><span class="n">report</span> <span class="o">=</span> <span class="no">PlainTextReport</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">report</span><span class="o">.</span><span class="n">output_report</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Because the Strategy pattern is based on composition and delegation, rather than on inheritance, it is easy to switch strategies at runtime.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="c1"># The Strategy</span>
</span><span class="line"><span class="n">report</span> <span class="o">=</span> <span class="no">Report</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">HTMLFormatter</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class="line"><span class="n">report</span><span class="o">.</span><span class="n">output_report</span>
</span><span class="line"><span class="n">report</span><span class="o">.</span><span class="n">formatter</span> <span class="o">=</span> <span class="no">PlainTextFormatter</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">report</span><span class="o">.</span><span class="n">output_report</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="sharing-data-between-the-context-and-strategy">Sharing Data between the Context and Strategy</h3>

<ol>
  <li><em>Pass in everything that the strategy needs as arguments when the context calls the methods on the strategy object.</em> The downside of doing things this way is that if there is a lot of complex data to pass between the context and the strategy, then, well, you are going to be passing a lot of complex data around without any guarantee that it will get used.</li>
  <li>Having the context object pass a reference to itself to the strategy object.</li>
</ol>

<h3 id="using-and-abusing-1">Using and Abusing</h3>

<p>Particular attention to the details of the interface between the context and the strategy as well as to the coupling between them. Remember, the Strategy pattern will do you little good if you couple the context and your first strategy so tightly together that you cannot wedge a second or a third strategy into the design.</p>

<h3 id="in-the-wild-1">In the Wild</h3>

<p>Ruby code blocks, which are essentially code wrapped up in an instant object (the Proc object), are wonderfully useful for creating quick, albeit simple, strategy objects.</p>

<p>Use Proc as the lightweight strategy object.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Report</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:text</span>
</span><span class="line">  <span class="kp">attr_accessor</span> <span class="ss">:formatter</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">formatter</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@title</span> <span class="o">=</span> <span class="s1">&#39;Monthly Report&#39;</span>
</span><span class="line">    <span class="vi">@text</span> <span class="o">=</span> <span class="o">[</span> <span class="s1">&#39;Things are going&#39;</span><span class="p">,</span> <span class="s1">&#39;really, really well.&#39;</span> <span class="o">]</span>
</span><span class="line">    <span class="vi">@formatter</span> <span class="o">=</span> <span class="n">formatter</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">output_report</span>
</span><span class="line">    <span class="vi">@formatter</span><span class="o">.</span><span class="n">call</span><span class="p">(</span> <span class="nb">self</span> <span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="the-observer">The Observer</h2>

<h3 id="description-2">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/observer.png" alt="observer" /></p>

<p>The aiming is to build a system that is highly integrated—that is, a system where every part is aware of the state of the whole.</p>

<p>The GoF called this idea of building a clean interface between the source of the news that some object has changed and the consumers of that news the Observer pattern. The class with the news is the <strong>subject</strong>, and the objects which are interested in getting the news are the <strong>observor</strong>.</p>

<blockquote>
  <p>It has always seemed to me that the Observer pattern is somewhat misnamed. While the observer object gets top billing—in fact, the only billing—it is actually the subject that does most of the work. It is the subject that is responsible for keeping track of the observers. It is also the subject that needs to inform the observers that a change has come down the pike.</p>
</blockquote>

<h3 id="code-usage">Code Usage</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">module</span> <span class="nn">Subject</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@observers</span><span class="o">=[]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_observer</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@observers</span> <span class="o">&lt;&lt;</span> <span class="n">observer</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">delete_observer</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@observers</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">observer</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">notify_observers</span>
</span><span class="line">    <span class="vi">@observers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">observer</span><span class="o">|</span>
</span><span class="line">      <span class="n">observer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Employee</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Subject</span>
</span><span class="line">
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:address</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:salary</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">salary</span><span class="p">)</span>
</span><span class="line">   <span class="k">super</span><span class="p">()</span>
</span><span class="line">   <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class="line">   <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
</span><span class="line">   <span class="vi">@salary</span> <span class="o">=</span> <span class="n">salary</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">salary=</span><span class="p">(</span><span class="n">new_salary</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@salary</span> <span class="o">=</span> <span class="n">new_salary</span>
</span><span class="line">    <span class="n">notify_observers</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The Ruby standard library comes with a fine, prebuilt <a href="http://ruby-doc.org/stdlib-1.9.3/libdoc/observer/rdoc/Observable.html">Observable</a> module that provides all of the support you need to make your object, well, observable.</p>

<p>With the observable module, the observable object must:</p>

<ol>
  <li>assert that it has <code>#changed</code></li>
  <li>call <code>#notify_observers</code></li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;observer&#39;</span>
</span><span class="line"><span class="k">class</span> <span class="nc">Employee</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Observable</span>
</span><span class="line">
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:address</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:salary</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span> <span class="nb">name</span><span class="p">,</span> <span class="n">title</span><span class="p">,</span> <span class="n">salary</span><span class="p">)</span>
</span><span class="line">   <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class="line">   <span class="vi">@title</span> <span class="o">=</span> <span class="n">title</span>
</span><span class="line">   <span class="vi">@salary</span> <span class="o">=</span> <span class="n">salary</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">salary=</span><span class="p">(</span><span class="n">new_salary</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@salary</span> <span class="o">=</span> <span class="n">new_salary</span>
</span><span class="line">    <span class="n">changed</span>
</span><span class="line">    <span class="n">notify_observers</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="interfaces-pull-or-push">Interfaces. Pull or Push?</h3>

<p>The key decisions that you need to make when implementing the Observer pattern all center on the interface between the subject and the observer.</p>

<p>Just have a single method in the observer whose only argument is the subject. The GoF term for this strategy is the <strong>pull</strong> method, because the observers have to pull whatever details about the change that they need out of the subject.</p>

<p>The other possibility—logically enough termed the <strong>push</strong> method—has the subject send the observers a lot of details about the change:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">observer</span><span class="o">.</span><span class="n">update_salary</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">old_salary</span><span class="p">,</span> <span class="n">new_salary</span><span class="p">)</span>
</span><span class="line"><span class="n">observer</span><span class="o">.</span><span class="n">update_title</span><span class="p">(</span><span class="nb">self</span><span class="p">,</span> <span class="n">old_title</span><span class="p">,</span> <span class="n">new_title</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The advantage in providing more details is that the observers do not have to work quite as hard to keep track of what is going on. The disadvantage of the push model is that if all of the observers are not interested in all of the details, then the work of passing the data around goes for naught.</p>

<h3 id="using-and-abusing-2">Using and Abusing</h3>

<p><em>The frequency and timing of the updates.</em> The subject class can help with all of this by avoiding broadcasting redundant updates. Just because someone updates an object, it does not mean that anything really changed.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">def</span> <span class="nf">salary=</span><span class="p">(</span><span class="n">new_salary</span><span class="p">)</span>
</span><span class="line">  <span class="n">old_salary</span> <span class="o">=</span> <span class="vi">@salary</span>
</span><span class="line">  <span class="vi">@salary</span> <span class="o">=</span> <span class="n">new_salary</span>
</span><span class="line">  <span class="k">if</span> <span class="n">old_salary</span> <span class="o">!=</span> <span class="n">new_salary</span>
</span><span class="line">    <span class="n">changed</span>
</span><span class="line">    <span class="n">notify_observers</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>The consistency of the subject as it informs its observers of changes.</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">fred</span> <span class="o">=</span> <span class="no">Employee</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Fred&quot;</span><span class="p">,</span> <span class="s2">&quot;Crane Operator&quot;</span><span class="p">,</span> <span class="mi">30000</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">fred</span><span class="o">.</span><span class="n">salary</span> <span class="o">=</span> <span class="mi">1000000</span>
</span><span class="line"><span class="c1"># Warning! Inconsistent state here!</span>
</span><span class="line"><span class="n">fred</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Vice President of Sales&#39;</span>
</span><span class="line">
</span><span class="line">
</span><span class="line"><span class="c1"># Don&#39;t inform the observers just yet</span>
</span><span class="line"><span class="n">fred</span><span class="o">.</span><span class="n">salary</span> <span class="o">=</span> <span class="mi">1000000</span>
</span><span class="line"><span class="n">fred</span><span class="o">.</span><span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;Vice President of Sales&#39;</span>
</span><span class="line">
</span><span class="line"><span class="c1"># Now inform the observers!</span>
</span><span class="line"><span class="n">fred</span><span class="o">.</span><span class="n">changes_complete</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>Badly behaved observers.</em> Like responds by raising an exception?</p>

<h3 id="in-the-wild-2">In the Wild</h3>

<p>Use Proc as Observers. Just use <code>call</code> as the interface when notifying observers.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">module</span> <span class="nn">Subject</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">notify_observers</span>
</span><span class="line">    <span class="vi">@observers</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">observer</span><span class="o">|</span>
</span><span class="line">      <span class="n">observer</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>ActiveRecord::Observer has been deprecated from Rails 4.0, but we can still get the feature by the extracted gem. <a href="https://github.com/rails/rails-observers">rails-observers</a></p>

<h2 id="composite">Composite</h2>

<h3 id="description-3">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/composite.png" alt="composite" /></p>

<ol>
  <li><strong>component</strong>, a common interface or base class for all of your objects.</li>
  <li><strong>leaf</strong>, the class doing simple, indivisible building blocks of process.</li>
  <li><strong>composite</strong>, a component, also a higher-level object that is build from subcomponents.</li>
</ol>

<p>The GoF called the design pattern for our “<em>the sum acts like one of the parts</em>” situation the Composite pattern. You will know that you need to use the Composite pattern when you are trying to build a hierarchy or tree of objects, and you do not want the code that uses the tree to constantly have to worry about whether it is dealing with a single object or a whole bushy branch of the tree. Once you grasp its <em>recursive nature</em>, the Composite pattern is really quite simple.</p>

<h3 id="code-usage-1">Code Usage</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">CompositeTask</span> <span class="o">&lt;</span> <span class="no">Task</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@sub_tasks</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_sub_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@sub_tasks</span> <span class="o">&lt;&lt;</span> <span class="n">task</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">remove_sub_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@sub_tasks</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">get_time_required</span>
</span><span class="line">    <span class="n">time</span><span class="o">=</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span>
</span><span class="line">    <span class="vi">@sub_tasks</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">task</span><span class="o">|</span> <span class="n">time</span> <span class="o">+=</span> <span class="n">task</span><span class="o">.</span><span class="n">get_time_required</span><span class="p">}</span>
</span><span class="line">    <span class="n">time</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">MakeBatterTask</span> <span class="o">&lt;</span> <span class="no">CompositeTask</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="k">super</span><span class="p">(</span><span class="s1">&#39;Make batter&#39;</span><span class="p">)</span>
</span><span class="line">    <span class="n">add_sub_task</span><span class="p">(</span> <span class="no">AddDryIngredientsTask</span><span class="o">.</span><span class="n">new</span> <span class="p">)</span>
</span><span class="line">    <span class="n">add_sub_task</span><span class="p">(</span> <span class="no">AddLiquidsTask</span><span class="o">.</span><span class="n">new</span> <span class="p">)</span>
</span><span class="line">    <span class="n">add_sub_task</span><span class="p">(</span> <span class="no">MixTask</span><span class="o">.</span><span class="n">new</span> <span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="concerns">Concerns</h3>

<p><strong><em>How to handle the difference between a composite and a leaf?</em></strong></p>

<p>The goal of the Composite pattern is to make the leaf objects <em>more or less</em> indistinguishable from the composite objects. But there is one unavoidable difference between a composite and a leaf: The composite has to manage its children, which probably means that it needs to have a method to get at the children and possibly methods to add and remove child objects. The leaf classes, of course, really do not have any children to manage; that is the nature of leafyness.</p>

<p>As I say, how you handle this decision is mostly a matter of taste: Make the leaf and composite classes different, or burden the leaf classes with embarrassing methods that they do not know how to handle. My own instinct is to leave the methods off of the leaf classes. Leaf objects cannot handle child objects, and we may as well admit it.</p>

<p><strong><em>How to traverse the tree structrue which the composite pattern make?</em></strong></p>

<p>Each composite object holds references to its subcomponents but the child components do not know a thing about their parents, it is easy to traverse the tree from the root to the leaves but hard to go the other way.</p>

<p>Add a parent reference in the component class.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Task</span>
</span><span class="line">  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:parent</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class="line">    <span class="vi">@parent</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">CompositeTask</span> <span class="o">&lt;</span> <span class="no">Task</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@sub_tasks</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_sub_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@sub_tasks</span> <span class="o">&lt;&lt;</span> <span class="n">task</span>
</span><span class="line">    <span class="n">task</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">self</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">remove_sub_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@sub_tasks</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
</span><span class="line">    <span class="n">task</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kp">nil</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="using-and-abusing-3">Using and Abusing</h3>

<p>The error that crops up so frequently with the Composite pattern is assuming that the tree is only one level deep—that is, assuming that all of the child components of a composite object are, in fact, leaf objects and not other composites.</p>

<p>Remember, the power of the Composite pattern is that it allows us to build arbitrarily deep trees.</p>

<h3 id="in-the-wild-3">In the Wild</h3>

<h2 id="the-iterator">The Iterator</h2>

<h3 id="description-4">Description</h3>

<p>Provide a way to access the elements of an aggregate object sequentially without exposing its underlying representation.</p>

<p>Iterators in Ruby are a great example of what is right with the language. Instead of providing special-purpose external iterator objects for each aggregate class, Ruby relies on the very flexible idea of Proc objects and code blocks to build internal iterators.</p>

<p><strong>external iterator</strong>, the iterator is a separate object from the aggregate.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span></span><span class="err">#</span> <span class="n">in</span> <span class="n">java</span>
</span><span class="line"><span class="n">ArrayList</span> <span class="n">list</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="p">();</span>
</span><span class="line"><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;red&quot;</span><span class="p">);</span>
</span><span class="line"><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;green&quot;</span><span class="p">);</span>
</span><span class="line"><span class="n">list</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="s">&quot;blue&quot;</span><span class="p">);</span>
</span><span class="line"><span class="k">for</span><span class="p">(</span> <span class="n">Iterator</span> <span class="n">i</span> <span class="o">=</span> <span class="n">list</span><span class="p">.</span><span class="na">iterator</span><span class="p">();</span> <span class="n">i</span><span class="p">.</span><span class="na">hasNext</span><span class="p">();)</span> <span class="p">{</span>
</span><span class="line">        <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span> <span class="s">&quot;item: &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="p">.</span><span class="na">next</span><span class="p">());</span>
</span><span class="line"><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>internal iterator</strong>, the code block-based iterators, all of the iterating action occurs inside the aggregate object.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="c1"># in ruby</span>
</span><span class="line"><span class="k">def</span> <span class="nf">for_each_element</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class="line">  <span class="n">i</span><span class="o">=</span> <span class="mi">0</span>
</span><span class="line">  <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">array</span><span class="o">.</span><span class="n">length</span>
</span><span class="line">    <span class="k">yield</span><span class="p">(</span><span class="n">array</span><span class="o">[</span><span class="n">i</span><span class="o">]</span><span class="p">)</span>
</span><span class="line">    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">a</span> <span class="o">=</span> <span class="o">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="o">]</span>
</span><span class="line"><span class="n">for_each_element</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">element</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="s2">&quot;The element is </span><span class="si">#{</span><span class="n">element</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="internal-iterators-vs-external-iterators">Internal Iterators vs. External Iterators</h3>

<p>With Internal Iterator, the main advantage is simplicity and code clarity.</p>

<p>With External Iterator</p>

<ol>
  <li>
    <p>You have more flexibility on iteration control. With an external iterator, you won’t call <code>next</code> until you are good and ready for the next element. With an internal iterator, by contrast, the aggregate relentlessly pushes the code block to accept item after item.</p>

    <p><em>If you are trying to merge the contents of two sorted arrays into a single array that was itself sorte?</em></p>

    <p>the merge is actually fairly easy with an external iterator, simply create an iterator for the two input arrays and then merge the arrays by repeatedly pushing the smallest value from either of the iterators onto the output array.</p>
  </li>
  <li>
    <p>A second advantage of external iterators is that, because they are external, you can share them—you can pass them around to other methods and objects. Of course, this is a bit of a double-edged sword: You get the flexibility but you also have to know what you are doing. In particular, beware of multiple threads getting hold of a non-thread-safe external iterator.</p>
  </li>
</ol>

<h3 id="the-inimitable-enumerable">The Inimitable Enumerable</h3>

<p>To mix in <code>Enumerable</code>, you need only make sure that your internal iterator method is named <code>each</code> and that the individual elements that you are going to iterate over have a reasonable implementation of the <code>&lt;=&gt;</code> comparison operator.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Account</span>
</span><span class="line">  <span class="kp">attr_accessor</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:balance</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">balance</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@name</span> <span class="o">=</span> <span class="nb">name</span>
</span><span class="line">    <span class="vi">@balance</span> <span class="o">=</span> <span class="n">balance</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">&lt;=&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class="line">    <span class="n">balance</span> <span class="o">&lt;=&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">balance</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Portfolio</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Enumerable</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@accounts</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@accounts</span><span class="o">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_account</span><span class="p">(</span><span class="n">account</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@accounts</span> <span class="o">&lt;&lt;</span> <span class="n">account</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">my_portfolio</span><span class="o">.</span><span class="n">any?</span> <span class="p">{</span><span class="o">|</span><span class="n">account</span><span class="o">|</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">}</span>
</span><span class="line"><span class="n">my_portfolio</span><span class="o">.</span><span class="n">all?</span> <span class="p">{</span><span class="o">|</span><span class="n">account</span><span class="o">|</span> <span class="n">account</span><span class="o">.</span><span class="n">balance</span> <span class="o">&gt;</span> <span class="o">=</span> <span class="mi">10</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="using-and-abusing-4">Using and Abusing</h3>

<p>The main danger is this: What happens if the aggregate object changes while you are iterating through it?</p>

<p>You may use a shallow copy when initializing.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">ChangeResistantArrayIterator</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@array</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">array</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@index</span> <span class="o">=</span> <span class="mi">0</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>A Ruby trick example.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">array</span><span class="o">=[</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="s1">&#39;green&#39;</span><span class="p">,</span> <span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;purple&#39;</span><span class="o">]</span>
</span><span class="line">
</span><span class="line"><span class="n">array</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span> <span class="n">color</span> <span class="o">|</span>
</span><span class="line">  <span class="nb">puts</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
</span><span class="line">  <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s1">&#39;green&#39;</span>
</span><span class="line">    <span class="n">array</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="c1"># red</span>
</span><span class="line"><span class="c1"># green</span>
</span><span class="line"><span class="c1"># purple</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>Finally, a multithreaded program is a particularly dangerous home for iterators.</em> You need to take all of the usual care to ensure that one thread does not rip the aggregate rug out from under your iterator.</p>

<h3 id="in-the-wild-4">In the Wild</h3>

<p><strong>IO</strong></p>

<p>The neat thing about the IO object is that it is amphibious—it does both internal and external iterators.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;names.txt&#39;</span><span class="p">)</span>
</span><span class="line"><span class="k">while</span> <span class="ow">not</span> <span class="n">f</span><span class="o">.</span><span class="n">eof?</span>
</span><span class="line">  <span class="nb">puts</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line"><span class="n">f</span><span class="o">.</span><span class="n">close</span>
</span><span class="line">
</span><span class="line"><span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;names.txt&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">f</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">line</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="n">line</span><span class="p">)}</span>
</span><span class="line"><span class="n">f</span><span class="o">.</span><span class="n">close</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Pathname</strong> <a href="http://ruby-doc.org/stdlib-2.1.0/libdoc/pathname/rdoc/Pathname.html">API</a></p>

<p>Pathname tries to offer one-stop shopping for all your directory and path manipulation needs.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">pn</span><span class="o">.</span><span class="n">each_filename</span> <span class="p">{</span><span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="s2">&quot;File: </span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>
</span><span class="line"><span class="c1"># File: usr</span>
</span><span class="line"><span class="c1"># File: local</span>
</span><span class="line"><span class="c1"># File: lib</span>
</span><span class="line"><span class="c1"># File: ruby</span>
</span><span class="line"><span class="c1"># File: 1.8</span>
</span><span class="line">
</span><span class="line"><span class="n">pn</span><span class="o">.</span><span class="n">each_entry</span> <span class="p">{</span><span class="o">|</span><span class="n">entry</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="s2">&quot;Entry: </span><span class="si">#{</span><span class="n">entry</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>
</span><span class="line"><span class="c1"># Entry: .</span>
</span><span class="line"><span class="c1"># Entry: ..</span>
</span><span class="line"><span class="c1"># Entry: i686-linux</span>
</span><span class="line"><span class="c1"># Entry: shellwords.rb</span>
</span><span class="line"><span class="c1"># Entry: mailread.rb</span>
</span><span class="line"><span class="c1"># ...</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>ObjectSpace</strong> <a href="http://www.ruby-doc.org/core-2.1.3/ObjectSpace.html">API</a></p>

<p>ObjectSpace provides a window into the complete universe of objects that exist within your Ruby interpreter. The fundamental iterator supplied by ObjectSpace is the <code>each_object</code> method. It iterates across all of the Ruby objects—everything that is loaded into your Ruby interpreter:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="no">ObjectSpace</span><span class="o">.</span><span class="n">each_object</span> <span class="p">{</span><span class="o">|</span><span class="n">object</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="s2">&quot;Object: </span><span class="si">#{</span><span class="n">object</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>
</span><span class="line">
</span><span class="line"><span class="c1"># If you supply the argument, each_object will iterate over only</span>
</span><span class="line"><span class="c1"># the instances of that class or module.</span>
</span><span class="line"><span class="no">ObjectSpace</span><span class="o">.</span><span class="n">each_object</span><span class="p">(</span><span class="no">Numeric</span><span class="p">)</span> <span class="p">{</span><span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="nb">puts</span><span class="p">(</span><span class="s2">&quot;The number is </span><span class="si">#{</span><span class="n">n</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)}</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Try this execellent <code>subclasses_of</code> method:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">def</span> <span class="nf">subclasses_of</span><span class="p">(</span><span class="n">superclass</span><span class="p">)</span>
</span><span class="line">  <span class="n">subclasses</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">
</span><span class="line">  <span class="no">ObjectSpace</span><span class="o">.</span><span class="n">each_object</span><span class="p">(</span><span class="no">Class</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">k</span><span class="o">|</span>
</span><span class="line">    <span class="k">next</span> <span class="k">if</span> <span class="o">!</span><span class="n">k</span><span class="o">.</span><span class="n">ancestors</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">superclass</span><span class="p">)</span> <span class="o">||</span> <span class="n">superclass</span> <span class="o">==</span> <span class="n">k</span> <span class="o">||</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="s1">&#39;::&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="n">subclasses</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
</span><span class="line">    <span class="n">subclasses</span> <span class="o">&lt;&lt;</span> <span class="n">k</span><span class="o">.</span><span class="n">to_s</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="n">subclasses</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">subclasses_of</span><span class="p">(</span><span class="no">Numeric</span><span class="p">)</span>
</span><span class="line"><span class="c1"># =&gt; [&quot;Complex&quot;, &quot;Rational&quot;, &quot;Bignum&quot;, &quot;Float&quot;, &quot;Fixnum&quot;, &quot;Integer&quot;]</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="the-command">The Command</h2>

<h3 id="description-5">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/command.png" alt="command" /></p>

<p>The idea of factoring out the action code into its own object is the essence of the Command pattern.</p>

<p>The key thing about the Command pattern is that it separates the thought from the deed. When you use this pattern, you are no longer simply saying, “Do this”; instead, you are saying, “Remember how to do this,” and, sometime later, “Do that thing that I told you to remember.”</p>

<p>Command pattern can be useful in</p>

<ol>
  <li>Keeping track of what you need to do, or what you have already done</li>
  <li>Undo or redo</li>
  <li>Queuing up comands</li>
</ol>

<h3 id="keep-track-of-what-you-have-done">Keep Track of What You Have Done</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Command</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:description</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">description</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@description</span> <span class="o">=</span> <span class="n">description</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">execute</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">CreateFile</span> <span class="o">&lt;</span> <span class="no">Command</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span><span class="p">(</span><span class="s2">&quot;Create file: </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@path</span> <span class="o">=</span> <span class="n">path</span>
</span><span class="line">    <span class="vi">@contents</span> <span class="o">=</span> <span class="n">contents</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">execute</span>
</span><span class="line">    <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vi">@path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="vi">@contents</span><span class="p">)</span>
</span><span class="line">    <span class="n">f</span><span class="o">.</span><span class="n">close</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Use Composite</strong></p>

<p>When we are trying to keep track of what we are about to do—or have done—we will need a class to collect all of our commands. Hmm, a class that acts like a command, but really is just a front for a number of subcommands. Sounds like a composite:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">CompositeCommand</span> <span class="o">&lt;</span> <span class="no">Command</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@commands</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_command</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@commands</span> <span class="o">&lt;&lt;</span> <span class="n">cmd</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">execute</span>
</span><span class="line">    <span class="vi">@commands</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">cmd</span><span class="o">|</span> <span class="n">cmd</span><span class="o">.</span><span class="n">execute</span><span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">description</span>
</span><span class="line">    <span class="n">description</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class="line">    <span class="vi">@commands</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">cmd</span><span class="o">|</span> <span class="n">description</span> <span class="o">+=</span> <span class="n">cmd</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class="line">    <span class="n">description</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">cmds</span> <span class="o">=</span> <span class="no">CompositeCommand</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">cmds</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="no">CreateFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s2">&quot;hello world</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">))</span>
</span><span class="line"><span class="n">cmds</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="no">CopyFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;file2.txt&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">cmds</span><span class="o">.</span><span class="n">add_command</span><span class="p">(</span><span class="no">DeleteFile</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;file1.txt&#39;</span><span class="p">))</span>
</span><span class="line">
</span><span class="line"><span class="n">cmds</span><span class="o">.</span><span class="n">execute</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="undo-or-redo">Undo or Redo</h3>

<p>Every undoable command that we create has two methods. Along with the usual <code>execute</code> method, which does the thing, we add an <code>unexecute</code> method, which undoes the same thing.</p>

<p>As delete a file maybe destructive, so we need to save the contents of the original file.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">DeleteFile</span> <span class="o">&lt;</span> <span class="no">Command</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span> <span class="s2">&quot;Delete file: </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="vi">@path</span> <span class="o">=</span> <span class="n">path</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">execute</span>
</span><span class="line">    <span class="k">if</span> <span class="no">File</span><span class="o">.</span><span class="n">exists?</span><span class="p">(</span><span class="vi">@path</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@contents</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="vi">@path</span><span class="p">)</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">    <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="vi">@path</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">unexecute</span>
</span><span class="line">    <span class="k">if</span> <span class="vi">@contents</span>
</span><span class="line">      <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vi">@path</span><span class="p">,</span><span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="vi">@contents</span><span class="p">)</span>
</span><span class="line">      <span class="n">f</span><span class="o">.</span><span class="n">close</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Creating a file with CreateFile could be destructive, too: The file that we are trying to create might already exist and be overwritten as we create the new file. In a real system, we would need to deal with this possibility as well as with a host of issues related to file permissions and ownership.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">CreateFile</span> <span class="o">&lt;</span> <span class="no">Command</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">contents</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span> <span class="s2">&quot;Create file: </span><span class="si">#{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="vi">@path</span> <span class="o">=</span> <span class="n">path</span>
</span><span class="line">    <span class="vi">@contents</span> <span class="o">=</span> <span class="n">contents</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">execute</span>
</span><span class="line">    <span class="n">f</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="vi">@path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="vi">@contents</span><span class="p">)</span>
</span><span class="line">    <span class="n">f</span><span class="o">.</span><span class="n">close</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">unexecute</span>
</span><span class="line">    <span class="no">File</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="vi">@path</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Finnaly, add an <code>unexecute</code> method to the <code>CompositeCommad</code> class.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">CompositeCommand</span> <span class="o">&lt;</span> <span class="no">Command</span>
</span><span class="line">  <span class="c1"># ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">unexecute</span>
</span><span class="line">    <span class="vi">@commands</span><span class="o">.</span><span class="n">reverse</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">cmd</span><span class="o">|</span> <span class="n">cmd</span><span class="o">.</span><span class="n">unexecute</span> <span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># ...</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="queuing-up-commands">Queuing Up Commands</h3>

<blockquote>
  <p>For example, it frequently takes a minor computer-time eternity to connect to a database. If you need to perform a number of database operations over time, you sometimes face the unpleasant choice of (1) leaving the connection open for the whole time, thereby wasting a scarce resource, or (2) wasting the time it takes to open and close the connection for each operation.</p>
</blockquote>

<p>The Command pattern offers one way out of this kind of bind. Instead of performing each operation as a stand-alone task, you accumulate all of these commands in a list. Periodically, you can open a connection to the database, execute all of your commands, and flush out this list.</p>

<h3 id="using-and-abusing-5">Using and Abusing</h3>

<p>The key thing about the Command pattern is that it separates the thought from the deed. When you use this pattern, you are no longer simply saying, “Do this”; instead, you are saying, “Remember how to do this,” and, sometime later, “Do that thing that I told you to remember.” Make sure that you really need that complexity before you pull the Command pattern out of your bag of tricks.</p>

<p><strong>Creation Time versus Execution Time</strong></p>

<p>Assuming you really do need the Command pattern, to make it work you have to be sure that the initial thought is complete. You have to carefully think through the circumstances in which the command object will find itself when it is executed versus when it was created. Yes, this key file was open, and that vital object was initialized when I created the command. Will it all still be there for me when the command is executed?</p>

<h3 id="in-the-wild-5">In the Wild</h3>

<p><strong>ActiveRecord::Migration</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">CreateBookTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Migration</span>
</span><span class="line">  <span class="c1"># execute</span>
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">up</span>
</span><span class="line">    <span class="n">create_table</span> <span class="ss">:books</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
</span><span class="line">      <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:title</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class="line">      <span class="n">t</span><span class="o">.</span><span class="n">column</span> <span class="ss">:author</span><span class="p">,</span> <span class="ss">:string</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># unexecute</span>
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">down</span>
</span><span class="line">    <span class="n">drop_table</span> <span class="ss">:books</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Madeleine</strong></p>

<p><a href="https://github.com/ghostganz/madeleine">repo</a></p>

<blockquote>
  <p>Imagine how slow your system would be if you had to write out a whole airport’s worth of seat assignments every time someone changed his or her mind and wanted that aisle seat after all.</p>
</blockquote>

<p>Madeleine is a transactional, high-performance, object persistence framework that does not need any object relational mapping for the simple reason that it does not use a relational database—or any other kind of database, for that matter. Instead, Madeleine relies on the Ruby Marshal package, a facility for converting live Ruby objects into bytes and for turning those bytes back into objects. Unfortunately, being able to marshal your objects to a file is not by itself a complete solution to application persistence.</p>

<p><a href="https://gist.github.com/ifyouseewendy/c0a3ec5da222779885f0">Example gist using Madeleine</a></p>

<h2 id="the-adapter">The Adapter</h2>

<h3 id="description-6">Description</h3>

<p>An adapter is an object that crosses the chasm between the interface that you have and the interface that you need.</p>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/adapter.png" alt="the adapter" /></p>

<p>The client expects the target to have a certain interface. But unknown to the client, the target object is really an adapter, and buried inside of the adapter is a reference to a second object, the adaptee, which actually performs the work.</p>

<h3 id="adapt-or-modify">Adapt or Modify?</h3>

<p>The choice of using an adapter or modifying the object really comes down to how well you understand the class in question and the issue of encapsulation.</p>

<p>Lean toward modifying the class in the following circumstances:</p>

<ul>
  <li>The modifications are simple and clear.</li>
  <li>You understand the class you are modifying and the way in which it is used.</li>
</ul>

<p>Lean toward an adapter solution in the following situations:</p>

<ul>
  <li>The interface mismatch is extensive and complex.</li>
  <li>You have no idea how this class works.</li>
</ul>

<p>Engineering is all about trade-offs. Adapters preserve encapsulation at the cost of some complexity. Modifying a class may buy you some simplification, but at the cost of tinkering with the plumbing.</p>

<h3 id="using-and-abusing-6">Using and Abusing</h3>

<p>One of the advantages that Ruby’s duck typing gives to adapter writers is that it allows us to create adapters that support only that part of the target interface that the client will actually use. Partially implemented adapters are something of a double-edged sword: On the one hand, it is very convenient to implement only what you absolutely need; on the other hand, your program can come to grief if the client decides to call a method that you didn’t think you needed.</p>

<h3 id="in-the-wild-6">In the Wild</h3>

<p><code>ActiveRecord</code> deals with all of these differences by defining a standardized interface, encapsulated in a class called <code>AbstractAdapter</code>. The <code>AbstractAdapter</code> class defines the interface to a database that is used throughout <code>ActiveRecord</code>.</p>

<p><code>AbstractAdapter</code> defines a standard method to execute a SQL select statement and return the results, called <code>select_all</code>. Each individual adapter implements the <code>select_all</code> method in terms of the API of the underlying database system.</p>

<h2 id="the-proxy">The Proxy</h2>

<h3 id="description-7">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/proxy.png" alt="the proxy" /></p>

<p>The Proxy pattern is essentially built around a little white lie. The counterfeit object, called the <strong>proxy</strong> by the GoF, has a reference to the real object, the <strong>subject</strong>, hidden inside. Whenever the client code calls a method on the proxy, the proxy simply forwards the request to the real object.</p>

<p>Inside the proxy is hidden a reference to the other, real object—an object that the GoF referred to as the subject.</p>

<p>Once we have a proxy, we have a place to stand squarely between the client and the real object. The proxy provides the ideal pinch point to exert control.</p>

<p>The proxy serves as a pinch point between the client and the subject:</p>

<ul>
  <li>“Is this operation authorized?” asks the protection proxy.</li>
  <li>“Does the subject actually live on this other machine?” asks the remote proxy.</li>
  <li>“Have I actually created the subject yet?” asks the virtual proxy.</li>
</ul>

<p>In short, the proxy controls access to the subject.</p>

<h3 id="the-protection-proxy">The Protection Proxy</h3>

<p>A proxy that controls access to the subject.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;etc&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">AccountProtectionProxy</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">real_account</span><span class="p">,</span> <span class="n">owner_name</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@subject</span> <span class="o">=</span> <span class="n">real_account</span>
</span><span class="line">    <span class="vi">@owner_name</span> <span class="o">=</span> <span class="n">owner_name</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">    <span class="n">check_access</span>
</span><span class="line">    <span class="k">return</span> <span class="vi">@subject</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">    <span class="n">check_access</span>
</span><span class="line">    <span class="k">return</span> <span class="vi">@subject</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">check_access</span>
</span><span class="line">    <span class="k">if</span> <span class="no">Etc</span><span class="o">.</span><span class="n">getlogin</span> <span class="o">!=</span> <span class="vi">@owner_name</span>
</span><span class="line">      <span class="k">raise</span> <span class="s2">&quot;Illegal access: </span><span class="si">#{</span><span class="no">Etc</span><span class="o">.</span><span class="n">getlogin</span><span class="si">}</span><span class="s2"> cannot access account.&quot;</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The advantage of using a proxy for protection is that it gives us a nice separation of concerns: The proxy worries about who is or is not allowed to do what. The only thing that the real bank account object need be concerned with is, well, the bank account.</p>

<p>By splitting the protection cleanly off from the workings of the real object, we can minimize the chance that any important information will inadvertently leak out through our protective shield.</p>

<h3 id="the-remove-proxy">The Remove Proxy</h3>

<p>You could hide the complexity behind a remote proxy, an object that lives on the client machine and looks, to the client code, just like the real BankAccount object. When a request comes in, the remote proxy goes through all the horror of packaging up the request, sending it over the network, waiting for a response, unpacking the response, and returning the answer to the unsuspecting client.</p>

<p>From the client’s point of view, it called a method on what it thought was the real BankAccount object and sometime later—perhaps an unusually long time later—the answer came back. This is how virtually all remote procedure call (RPC) systems work.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;soap/wsdlDriver&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">wsdl_url</span> <span class="o">=</span> <span class="s1">&#39;http://www.webservicex.net/WeatherForecast.asmx?WSDL&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">proxy</span> <span class="o">=</span> <span class="no">SOAP</span><span class="o">::</span><span class="no">WSDLDriverFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="n">wsdl_url</span> <span class="p">)</span><span class="o">.</span><span class="n">create_rpc_driver</span>
</span><span class="line"><span class="n">weather_info</span> <span class="o">=</span> <span class="n">proxy</span><span class="o">.</span><span class="n">GetWeatherByZipCode</span><span class="p">(</span><span class="s1">&#39;ZipCode&#39;</span><span class="o">=&gt;</span><span class="s1">&#39;19128&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Once the proxy object is set up, the client code no longer has to worry about the fact that the service actually lives at www.webservicex.net. Instead, it simply calls GetWeatherByZipCode and leaves all of the network details to the proxy.</p>

<h3 id="the-virtual-proxy">The Virtual Proxy</h3>

<p>In a sense, the virtual proxy is the biggest liar of the bunch. It pretends to be the real object, but it does not even have a reference to the real object until the client code calls a method. Only when the client actually calls a method does the virtual proxy scurry off and create or otherwise get access to the real object.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">VirtualAccountProxy</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">starting_balance</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@starting_balance</span><span class="o">=</span><span class="n">starting_balance</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">    <span class="n">s</span> <span class="o">=</span> <span class="n">subject</span>
</span><span class="line">    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">deposit</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">    <span class="n">s</span> <span class="o">=</span> <span class="n">subject</span>
</span><span class="line">    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">withdraw</span><span class="p">(</span><span class="n">amount</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">balance</span>
</span><span class="line">    <span class="n">s</span> <span class="o">=</span> <span class="n">subject</span>
</span><span class="line">    <span class="k">return</span> <span class="n">s</span><span class="o">.</span><span class="n">balance</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">subject</span>
</span><span class="line">    <span class="vi">@subject</span> <span class="o">||</span> <span class="p">(</span><span class="vi">@subject</span> <span class="o">=</span> <span class="no">BankAccount</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="vi">@starting_balance</span><span class="p">))</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>That approach tangles the proxy and the subject up a little more than we might like. We can improve on this strategy by applying a little of that Ruby code block magic:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">VirtualAccountProxy</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">creation_block</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@creation_block</span> <span class="o">=</span> <span class="n">creation_block</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Other methods omitted ...</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">subject</span>
</span><span class="line">    <span class="vi">@subject</span> <span class="o">||</span> <span class="p">(</span><span class="vi">@subject</span> <span class="o">=</span> <span class="vi">@creation_block</span><span class="o">.</span><span class="n">call</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Leverage Ruby</strong></p>

<p>Use ghost method <code>method_missing</code> and dynamic dispatch <code>send</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">VirtualProxy</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">&amp;</span><span class="n">creation_block</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@creation_block</span> <span class="o">=</span> <span class="n">creation_block</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">    <span class="n">s</span> <span class="o">=</span> <span class="n">subject</span>
</span><span class="line">    <span class="n">s</span><span class="o">.</span><span class="n">send</span><span class="p">(</span> <span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">subject</span>
</span><span class="line">    <span class="vi">@subject</span> <span class="o">=</span> <span class="vi">@creation_block</span><span class="o">.</span><span class="n">call</span> <span class="k">unless</span> <span class="vi">@subject</span>
</span><span class="line">    <span class="vi">@subject</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">array</span> <span class="o">=</span> <span class="no">VirtualProxy</span><span class="o">.</span><span class="n">new</span> <span class="p">{</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span> <span class="p">}</span>
</span><span class="line"><span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;hello&#39;</span>
</span><span class="line"><span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;out&#39;</span>
</span><span class="line"><span class="n">array</span> <span class="o">&lt;&lt;</span> <span class="s1">&#39;there&#39;</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="using-and-abusing-7">Using and Abusing</h3>

<p>Overusing <code>method_missing</code>, like overusing inheritance, is a great way to obscure your code.</p>

<h3 id="in-the-wild-7">In the Wild</h3>

<p><strong>drb using a remote proxy</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="c1"># server</span>
</span><span class="line"><span class="k">class</span> <span class="nc">MathService</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class="line">    <span class="k">return</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class="line">
</span><span class="line"><span class="n">math_service</span><span class="o">=</span><span class="no">MathService</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="no">DRb</span><span class="o">.</span><span class="n">start_service</span><span class="p">(</span><span class="s2">&quot;druby://localhost:3030&quot;</span><span class="p">,</span> <span class="n">math_service</span><span class="p">)</span>
</span><span class="line"><span class="no">DRb</span><span class="o">.</span><span class="n">thread</span><span class="o">.</span><span class="n">join</span>
</span><span class="line">
</span><span class="line"><span class="c1"># client</span>
</span><span class="line"><span class="nb">require</span> <span class="s1">&#39;drb/drb&#39;</span>
</span><span class="line"><span class="no">DRb</span><span class="o">.</span><span class="n">start_service</span>
</span><span class="line">
</span><span class="line"><span class="c1"># the client-side math_service is actually a remote proxy to the real</span>
</span><span class="line"><span class="c1"># math service, which is running inside the server-side Ruby interpreter.</span>
</span><span class="line"><span class="n">math_service</span> <span class="o">=</span> <span class="no">DRbObject</span><span class="o">.</span><span class="n">new_with_uri</span><span class="p">(</span><span class="s2">&quot;druby://localhost:3030&quot;</span><span class="p">)</span>
</span><span class="line"><span class="n">sum</span><span class="o">=</span><span class="n">math_service</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="the-decorator">The Decorator</h2>

<blockquote>
  <p>But what if you simply need to vary the responsibilities of an object? What do you do when sometimes your object needs to do a little more, but sometimes a little less?</p>
</blockquote>

<h3 id="description-8">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/decorator.png" alt="decorator" /></p>

<p>The ConcreteComponent is the “real” object, the object that implements the basic component functionality.</p>

<p>The Decorator pattern is a straightforward technique that you can use to assemble exactly the functionality that you need at runtime. The Decorator class has a reference to a Component—the next Component in the decorator chain—and it implements all of the methods of the Component type.</p>

<p>Each decorator supports the same core interface, but adds its own twist on that interface. The key implementation idea of the Decorator pattern is that the decorators are essentially shells: Each takes in a method call, adds its own special twist, and passes the call on to the next component in line.</p>

<p>The Decorator pattern lets you start with some basic functionality and layer on extra features, one decorator at a time.</p>

<h3 id="why-not-the-template-method">Why Not The Template Method?</h3>

<p>The trouble is that the inheritance-based approach requires you to come up with all possible combinations of features up-front, at design time.</p>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/out-of-control-inheritance.png" alt="out-of-control inheritance" /></p>

<h3 id="code-usage-2">Code Usage</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">WriterDecorator</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">real_writer</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@real_writer</span> <span class="o">=</span> <span class="n">real_writer</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">write_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@real_writer</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">pos</span>
</span><span class="line">    <span class="vi">@real_writer</span><span class="o">.</span><span class="n">pos</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">rewind</span>
</span><span class="line">    <span class="vi">@real_writer</span><span class="o">.</span><span class="n">rewind</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">close</span>
</span><span class="line">    <span class="vi">@real_writer</span><span class="o">.</span><span class="n">close</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">NumberingWriter</span> <span class="o">&lt;</span> <span class="no">WriterDecorator</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">real_writer</span><span class="p">)</span>
</span><span class="line">    <span class="k">super</span><span class="p">(</span><span class="n">real_writer</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@line_number</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">write_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@real_writer</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="vi">@line_number</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@line_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span><span class="line">   <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">writer</span> <span class="o">=</span> <span class="no">NumberingWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">SimpleWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;final.txt&#39;</span><span class="p">))</span>
</span><span class="line"><span class="n">writer</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="s1">&#39;Hello out there&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Fowardable module</strong> <a href="http://www.ruby-doc.org/stdlib-2.0/libdoc/forwardable/rdoc/Forwardable.html">API</a></p>

<p>Ruby provides the <strong>Forwardable</strong> module provides delegation of specified methods to a designated object, using the methods <code>def_delegator</code> and <code>def_delegators</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;forwardable&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">WriterDecorator</span>
</span><span class="line">  <span class="kp">extend</span> <span class="no">Forwardable</span>
</span><span class="line">
</span><span class="line">  <span class="n">def_delegators</span> <span class="ss">:@real_writer</span><span class="p">,</span> <span class="ss">:write_line</span><span class="p">,</span> <span class="ss">:rewind</span><span class="p">,</span> <span class="ss">:pos</span><span class="p">,</span> <span class="ss">:close</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">real_writer</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@real_writer</span> <span class="o">=</span> <span class="n">real_writer</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The forwardable module is more of a precision weapon than the <code>method_missing</code> technique. But the <code>method_missing</code> technique really shines when you want to delegate large numbers of calls.</p>

<p><strong>Dynamic Alternatives - Wrapping Methods</strong></p>

<ul>
  <li>Around Alias</li>
  <li>Refinement Wrapper</li>
  <li>Prepended Wrapper</li>
</ul>

<p>Check <a href="http://blog.ifyouseewendy.com/blog/2014/06/03/metaprogrammingi-ruby/#method-wrapper">this</a>.</p>

<p><strong>Dynamic Alternatives - Decorating with Modules</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">w</span> <span class="o">=</span> <span class="no">SimpleWriter</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
</span><span class="line"><span class="n">w</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">NumberingWriter</span><span class="p">)</span>
</span><span class="line"><span class="n">w</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">TimeStampingWriter</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">w</span><span class="o">.</span><span class="n">write_line</span><span class="p">(</span><span class="s1">&#39;hello&#39;</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>With both of these techniques, it is hard to undo the decoration. Unwrapping an aliased method is likely to be tedious, and you simply cannot un-include a module.</p>

<h3 id="using-and-abusing-8">Using and Abusing</h3>

<ul>
  <li>The classic Decorator pattern is loved more by the folks who build the thing than by those who use it.</li>
  <li>One thing to keep in mind when implementing the Decorator pattern is that you need to keep the component interface simple.</li>
  <li>Another potential drawback of the Decorator pattern is the performance overhead associated with a long chain of decorators.</li>
  <li>Finally, one drawback of the method-aliasing technique for decorating objects is that it tends to make your code harder to debug.</li>
</ul>

<h3 id="in-the-wild-8">In the Wild</h3>

<p><strong><code>alias_method_chain</code> in ActiveSupport</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">def</span> <span class="nf">write_line</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class="line">  <span class="nb">puts</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">def</span> <span class="nf">write_line_with_timestamp</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
</span><span class="line">  <span class="n">write_line_without_timestamp</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">new</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">line</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">alias_method_chain</span> <span class="ss">:write_line</span><span class="p">,</span> <span class="ss">:timestamp</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The <code>alias_method_chain</code> method will rename the original <code>write_line</code> method to <code>write_line_without_timestamp</code> and rename <code>write_line_with_timestamp</code> to plain old <code>write_line</code>, essentially creating a chain of methods. The nice thing about <code>alias_method_chain</code> is that, as its name suggests, you can chain together a number of enhancing methods.</p>

<h3 id="adapter-proxy-or-decorator">Adapter, Proxy or Decorator</h3>

<p>They are all “<em>one object stands for another</em>”, and the basic idea is <em>Delegate, delegate, delegate</em>.</p>

<ul>
  <li><strong>The Adapter</strong> hides the fact that some object has the wrong interface by wrapping it with an object that has the right interface.</li>
  <li><strong>The Proxy</strong> also wraps another object, but not with the intent of changing the interface. Instead, the proxy has the same interface as the object that it is wrapping. The proxy isn’t there to tre; it is there to control. Proxies are good for tasks such as enforcing security, hiding the fact that an object really lives across the network, and delaying the creation of the real object until the last possible moment.</li>
  <li><strong>The Decorator</strong> enables you to layer features on to a basic object.</li>
</ul>

<h2 id="singleton">Singleton</h2>

<p>A singleton class has exactly one instance, and access to that one instance is available globally.</p>

<h3 id="code-usage-3">Code Usage</h3>

<ol>
  <li>Creating the class variable and initializing it with the singleton instance</li>
  <li>Creating the class-level <code>instance</code> method</li>
  <li>Make <code>new</code> private.</li>
</ol>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">SimpleLogger</span>
</span><span class="line">  <span class="c1"># Lots of code deleted...</span>
</span><span class="line">
</span><span class="line">  <span class="vc">@@instance</span> <span class="o">=</span> <span class="no">SimpleLogger</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instance</span>
</span><span class="line">    <span class="k">return</span> <span class="vc">@@instance</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># make sure there is only one</span>
</span><span class="line">  <span class="nb">private_class_method</span> <span class="ss">:new</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">logger1</span> <span class="o">=</span> <span class="no">SimpleLogger</span><span class="o">.</span><span class="n">instance</span>   <span class="c1"># Returns the logger</span>
</span><span class="line"><span class="n">logger2</span> <span class="o">=</span> <span class="no">SimpleLogger</span><span class="o">.</span><span class="n">instance</span>   <span class="c1"># Returns exactly the same logger</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Creating the singleton instance before you actually need it is called <em>eager instantiation</em>.</p>

<p><strong>Singleton module</strong> <a href="http://www.ruby-doc.org/stdlib-1.9.3/libdoc/singleton/rdoc/Singleton.html">API</a></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;singleton&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">SimpleLogger</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class="line">
</span><span class="line">  <span class="c1"># Lots of code deleted...</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The Singleton module, waits until someone calls instance before it actually creates its singleton. This technique is known as <em>lazy instantiation</em>.</p>

<h3 id="alternatives">Alternatives</h3>

<p><strong>Global Variables and Constants</strong></p>

<ol>
  <li>If you use a global variable or a constant for this purpose, there is no way to delay the creation of the singleton object until you need it.</li>
  <li>Neither of these techniques does anything to prevent someone from creating a second or third instance of your supposedly singleton class.</li>
</ol>

<p><strong>Class and Module methods</strong></p>

<p>Lazy initialization remains and all of those <code>self.methods</code> and <code>@@variables</code> makes a strange feel.</p>

<h3 id="using-and-abusing-9">Using and Abusing</h3>

<p><strong>Don’t expect the Singleton module really prevent anything</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;singleton&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Manager</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">manage_resources</span>
</span><span class="line">    <span class="nb">puts</span><span class="p">(</span><span class="s2">&quot;I am managing my resources&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Use <code>public_class_method</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">m</span> <span class="o">=</span> <span class="no">Manager</span><span class="o">.</span><span class="n">new</span> <span class="c1"># =&gt; private method &#39;new&#39; called for Manager:Class</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Manager</span>
</span><span class="line">  <span class="nb">public_class_method</span> <span class="ss">:new</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">m</span> <span class="o">=</span> <span class="no">Manager</span><span class="o">.</span><span class="n">new</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>Use <code>clone</code></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">m</span> <span class="o">=</span> <span class="no">Manager</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">clone</span>
</span><span class="line"><span class="c1"># =&gt; TypeError: can&#39;t clone instance of singleton Manager</span>
</span><span class="line">
</span><span class="line"><span class="no">Foo</span> <span class="o">=</span> <span class="no">Manager</span><span class="o">.</span><span class="n">clone</span>
</span><span class="line"><span class="no">Foo</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">manage_resources</span>
</span><span class="line"><span class="c1"># =&gt; I am managing my resources</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The Ruby philosophy is that if you decide to circumvent the very clear intent of the author of the ClassBasedLogger class by cloning it, the language is there to help you out. You are in the driver’s seat, not the language. By keeping almost everything open to modification, Ruby allows you to do the things that you say you want to do—but it is up to you to say the right things.</p>

<p><strong>Coupling concern</strong></p>

<p>Create a singleton, and you have just made it possible for widely separated bits of your program to use that singleton as a secret channel to communicate with each other and, in the process, tightly couple themselves to each other. The horrible consequences of this coupling are why software engineering got out of the global variable business in the first place.</p>

<p>There is only one solution to this problem: <em>Don’t do that</em>.</p>

<p><strong>Considering the count, Do I really only need one instance?</strong></p>

<p><strong>a Need-to-Know Basis</strong></p>

<p>Another mistake that many people make is to spread the knowledge of a class’s singleton-ness far and wide.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;singleton&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">DatabaseConnectionManager</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">get_connection</span>
</span><span class="line">    <span class="c1"># Return the database connection...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><em>Which classes are actually aware that DatabaseConnectionManager is a singleton?</em></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">PreferenceManager</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@reader</span> <span class="o">=</span> <span class="no">PrefReader</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="vi">@writer</span> <span class="o">=</span> <span class="no">PrefWriter</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="vi">@preferences</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:display_splash</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:background_color</span><span class="o">=&gt;</span><span class="ss">:blue</span> <span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">save_preferences</span>
</span><span class="line">    <span class="n">preferences</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">    <span class="c1"># Preference are in</span>
</span><span class="line">    <span class="vi">@writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="vi">@preferences</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">get_preferences</span>
</span><span class="line">    <span class="vi">@preferences</span> <span class="o">=</span> <span class="vi">@reader</span><span class="o">.</span><span class="n">read</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PrefWriter</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="n">preferences</span><span class="p">)</span>
</span><span class="line">    <span class="n">connection</span> <span class="o">=</span> <span class="no">DatabaseConnectionManager</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get_connection</span>
</span><span class="line">    <span class="c1"># Write the preferences out</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">PrefReader</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">read</span>
</span><span class="line">    <span class="n">connection</span> <span class="o">=</span> <span class="no">DatabaseConnectionManager</span><span class="o">.</span><span class="n">instance</span><span class="o">.</span><span class="n">get_connection</span>
</span><span class="line">    <span class="c1"># Read the preferences and return them...</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>A better approach might be to concentrate the knowledge that <code>DatabaseConnectionManager</code> is a singleton in the <code>PreferenceManager</code> class and simply pass it into the preference reader and writer:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">PreferenceManager</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@reader</span> <span class="o">=</span> <span class="no">PrefReader</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="vi">@writer</span> <span class="o">=</span> <span class="no">PrefWriter</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="vi">@preferences</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:display_splash</span><span class="o">=&gt;</span><span class="kp">false</span><span class="p">,</span> <span class="ss">:background_color</span><span class="o">=&gt;</span><span class="ss">:blue</span> <span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">save_preferences</span>
</span><span class="line">    <span class="n">preferences</span> <span class="o">=</span> <span class="p">{}</span>
</span><span class="line">    <span class="c1"># Preference are in</span>
</span><span class="line">    <span class="vi">@writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="no">DatabaseConnectionManager</span><span class="o">.</span><span class="n">instance</span><span class="p">,</span> <span class="vi">@preferences</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">get_preferences</span>
</span><span class="line">    <span class="vi">@preferences</span> <span class="o">=</span> <span class="vi">@reader</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="no">DatabaseConnectionManager</span><span class="o">.</span><span class="n">instance</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Test Interferes</strong></p>

<p>As the Singleton saves the state, there is one exceedingly nasty thing about the Singleton pattern is the way that it interferes with unit testing.</p>

<p>One way to deal with this problem is to create two classes: an ordinary (i.e., non-singleton) class that contains all of the code, and a subclass of the first class that is a singleton.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="nb">require</span> <span class="s1">&#39;singleton&#39;</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">SimpleLogger</span>
</span><span class="line">  <span class="c1"># All of the logging functionality in this class...</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">SingletonLogger</span> <span class="o">&lt;</span> <span class="no">SimpleLogger</span>
</span><span class="line">  <span class="kp">include</span> <span class="no">Singleton</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The actual application code uses the <code>SingletonLogger</code>, while the tests can use the plain old, non-singleton <code>Logger</code> class.</p>

<h3 id="in-the-wild-9">In the Wild</h3>

<p><strong>Inflections in ActiveSupport</strong></p>

<p>The <code>Inflections</code> class is a singleton, which saves space and ensures that the same inflection rules are available everywhere.</p>

<p><strong>Rake::Application in rake</strong> <a href="http://ruby-doc.org/stdlib-2.0/libdoc/rake/rdoc/Rake/Application.html">API</a></p>

<p>As it runs, rake—like most build tools—reads in information about what it needs to do: which directories to create, which files to copy, and so on. All of this information needs to be available to all of the moving parts of rake, so rake stores it all in a single object (the <code>Rake::Application</code> object, to be precise) that is available as a singleton to the entire rake program.</p>

<h2 id="factory">Factory</h2>

<blockquote>
  <p>picking the right class for the circumstances</p>
</blockquote>

<h3 id="description-9">Description</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/factory.png" alt="factory" /></p>

<p>The GoF called this technique of pushing the “which class” decision down on a subclass the Factory Method pattern.</p>

<ul>
  <li>The <strong>creators</strong> are the base and concrete classes that contain the factory methods.</li>
  <li>The <strong>products</strong> are the objects being created.</li>
</ul>

<p>At its heart, this pattern is really just the Template Method pattern applied to the problem of creating new objects. In both the Factory Method pattern and the Template Method pattern, a generic part of the algorithm is coded in the generic base class, and subclasses fill in the blanks left in the base class.</p>

<p><strong>Parameterized Factory Method</strong></p>

<p>Parameterized factory method is a method that can produce either a plant or an animal, depending on the symbol that is passed in:</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Pond</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">number_animals</span><span class="p">,</span> <span class="n">number_plants</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@animals</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">number_animals</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">      <span class="n">animal</span> <span class="o">=</span> <span class="n">new_organism</span><span class="p">(</span><span class="ss">:animal</span><span class="p">,</span> <span class="s2">&quot;Animal</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@animals</span> <span class="o">&lt;&lt;</span> <span class="n">animal</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="vi">@plants</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">number_plants</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">      <span class="n">plant</span> <span class="o">=</span> <span class="n">new_organism</span><span class="p">(</span><span class="ss">:plant</span><span class="p">,</span> <span class="s2">&quot;Plant</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@plants</span> <span class="o">&lt;&lt;</span> <span class="n">plant</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="c1"># ...</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">DuckWaterLilyPond</span> <span class="o">&lt;</span> <span class="no">Pond</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">new_organism</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="ss">:animal</span>
</span><span class="line">      <span class="no">Duck</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">type</span> <span class="o">==</span> <span class="ss">:plant</span>
</span><span class="line">      <span class="no">WaterLily</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">raise</span> <span class="s2">&quot;Unknown organism type: </span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">pond</span> <span class="o">=</span> <span class="no">DuckWaterLilyPond</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Claasses Are Just Objects, Too</strong></p>

<p>While the GoF concentrated on inheritance-based implementations of their factories, we can get the same results with much less code by taking advantage of the fact that in Ruby, classes are just objects.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Pond</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">number_animals</span><span class="p">,</span> <span class="n">animal_class</span><span class="p">,</span>
</span><span class="line">                 <span class="n">number_plants</span><span class="p">,</span> <span class="n">plant_class</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@animal_class</span> <span class="o">=</span> <span class="n">animal_class</span>
</span><span class="line">    <span class="vi">@plant_class</span> <span class="o">=</span> <span class="n">plant_class</span>
</span><span class="line">
</span><span class="line">    <span class="vi">@animals</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">number_animals</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">      <span class="n">animal</span> <span class="o">=</span> <span class="n">new_organism</span><span class="p">(</span><span class="ss">:animal</span><span class="p">,</span> <span class="s2">&quot;Animal</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@animals</span> <span class="o">&lt;&lt;</span> <span class="n">animal</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="vi">@plants</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">number_plants</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">      <span class="n">plant</span> <span class="o">=</span> <span class="n">new_organism</span><span class="p">(</span><span class="ss">:plant</span><span class="p">,</span> <span class="s2">&quot;Plant</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@plants</span> <span class="o">&lt;&lt;</span> <span class="n">plant</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">simulate_one_day</span>
</span><span class="line">    <span class="vi">@plants</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">plant</span><span class="o">|</span> <span class="n">plant</span><span class="o">.</span><span class="n">grow</span><span class="p">}</span>
</span><span class="line">    <span class="vi">@animals</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">animal</span><span class="o">|</span> <span class="n">animal</span><span class="o">.</span><span class="n">speak</span><span class="p">}</span>
</span><span class="line">    <span class="vi">@animals</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">animal</span><span class="o">|</span> <span class="n">animal</span><span class="o">.</span><span class="n">eat</span><span class="p">}</span>
</span><span class="line">    <span class="vi">@animals</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span><span class="o">|</span><span class="n">animal</span><span class="o">|</span> <span class="n">animal</span><span class="o">.</span><span class="n">sleep</span><span class="p">}</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">new_organism</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="ss">:animal</span>
</span><span class="line">      <span class="vi">@animal_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">type</span> <span class="o">==</span> <span class="ss">:plant</span>
</span><span class="line">      <span class="vi">@plant_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">raise</span> <span class="s2">&quot;Unknown organism type: </span><span class="si">#{</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">pond</span> <span class="o">=</span> <span class="no">Pond</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="no">Duck</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="no">WaterLily</span><span class="p">)</span>
</span><span class="line"><span class="n">pond</span><span class="o">.</span><span class="n">simulate_one_day</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="abstract-factory">Abstract Factory</h3>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/abstract-factory.png" alt="abstract factory" /></p>

<p>An object dedicated to creating a compatible set of objects is called an abstract factory.</p>

<p>The problem is that you need to create sets of compatible objects. The solution is that you write a separate class to handle that creation.</p>

<p>The important thing about the abstract factory is that it encapsulates the knowledge of which product types go together. You can express that encapsulation with classes and subclasses, or you can get to it by storing the class objects as we did in the code above. Either way, you end up with an object that knows which kind of things belong together.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
<span class="line-number">40</span>
<span class="line-number">41</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">PondOrganismFactory</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">new_animal</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="no">Frog</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">new_plant</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="no">Algae</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">JungleOrganismFactory</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">new_animal</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="no">Tiger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">new_plant</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="no">Tree</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="k">class</span> <span class="nc">Habitat</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">number_animals</span><span class="p">,</span> <span class="n">number_plants</span><span class="p">,</span> <span class="n">organism_factory</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@organism_factory</span> <span class="o">=</span> <span class="n">organism_factory</span>
</span><span class="line">
</span><span class="line">    <span class="vi">@animals</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">number_animals</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">      <span class="n">animal</span> <span class="o">=</span> <span class="vi">@organism_factory</span><span class="o">.</span><span class="n">new_animal</span><span class="p">(</span><span class="s2">&quot;Animal</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@animals</span> <span class="o">&lt;&lt;</span> <span class="n">animal</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">
</span><span class="line">    <span class="vi">@plants</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class="line">    <span class="n">number_plants</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class="line">      <span class="n">plant</span> <span class="o">=</span> <span class="vi">@organism_factory</span><span class="o">.</span><span class="n">new_plant</span><span class="p">(</span><span class="s2">&quot;Plant</span><span class="si">#{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class="line">      <span class="vi">@plants</span> <span class="o">&lt;&lt;</span> <span class="n">plant</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">jungle</span> <span class="o">=</span> <span class="no">Habitat</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="no">JungleOrganismFactory</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class="line"><span class="n">jungle</span><span class="o">.</span><span class="n">simulate_one_day</span>
</span><span class="line">
</span><span class="line"><span class="n">pond</span> <span class="o">=</span> <span class="no">Habitat</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="no">PondOrganismFactory</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class="line"><span class="n">pond</span><span class="o">.</span><span class="n">simulate_one_day</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Claasses Are Just Objects, Too</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">OrganismFactory</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">plant_class</span><span class="p">,</span> <span class="n">animal_class</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@plant_class</span> <span class="o">=</span> <span class="n">plant_class</span>
</span><span class="line">    <span class="vi">@animal_class</span> <span class="o">=</span> <span class="n">animal_class</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">new_animal</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@animal_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">new_plant</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@plant_class</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="nb">name</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">jungle_organism_factory</span> <span class="o">=</span> <span class="no">OrganismFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">Tree</span><span class="p">,</span> <span class="no">Tiger</span><span class="p">)</span>
</span><span class="line"><span class="n">pond_organism_factory</span> <span class="o">=</span> <span class="no">OrganismFactory</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">WaterLily</span><span class="p">,</span> <span class="no">Frog</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">jungle</span> <span class="o">=</span> <span class="no">Habitat</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">jungle_organism_factory</span><span class="p">)</span>
</span><span class="line"><span class="n">jungle</span><span class="o">.</span><span class="n">simulate_one_day</span>
</span><span class="line"><span class="n">pond</span> <span class="o">=</span> <span class="no">Habitat</span><span class="o">.</span><span class="n">new</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pond_organism_factory</span><span class="p">)</span>
</span><span class="line"><span class="n">pond</span><span class="o">.</span><span class="n">simulate_one_day</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Naming</strong></p>

<p>Another way that we can simplify the implementation of abstract factories is to rely on a consistent naming convention for the product classes.</p>

<h3 id="factory--abstract-factory">Factory &amp;&amp; Abstract Factory</h3>

<ul>
  <li>The Factory Method pattern is really the Template Method pattern applied to object creation.</li>
  <li>the Abstract Factory pattern is simply the Strategy pattern applied to the same problem.</li>
</ul>

<h3 id="using-and-abusing-10">Using and Abusing</h3>

<p>Not every object needs to be produced by a factory. (<em>You Ain’t Goona Need It</em>).</p>

<p>Engineers do have a tendency to build the Queen Mary (or perhaps the Titanic?) when a canoe will suffice. If you have a choice of exactly one class at the moment, put off adding in a factory.</p>

<h3 id="in-the-wild-10">In the Wild</h3>

<p><strong>Base in ActiveRecord</strong></p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="n">adapter</span> <span class="o">=</span> <span class="s2">&quot;mysql&quot;</span>
</span><span class="line"><span class="n">method_name</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">adapter</span><span class="si">}</span><span class="s2">_connection&quot;</span>
</span><span class="line"><span class="no">Base</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">method_name</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h2 id="builder">Builder</h2>

<h3 id="description-10">Description</h3>

<p>Builder pattern, a pattern designed to help you configure those complex objects. The builder class takes charge of assembling all of the components of a complex object.</p>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/buidler.png" alt="builder" /></p>

<p>The client of the builder object the <strong>director</strong> because it directs the builder in the construction of the new object (called the <strong>product</strong>). Builders not only ease the burden of creating complex objects, but also hide the implementation details.</p>

<p>The idea behind the Builder pattern is that if your object is hard to build, if you have to write a lot of code to configure each object, then you should factor all of that creation code into a separate class, the builder.</p>

<p>The builders are less concerned about picking the right class and more focused on helping you configure your object.</p>

<ul>
  <li>Take control of configuring your object</li>
  <li>Prevent you from constructing an invalid object</li>
</ul>

<h3 id="code-usage-4">Code Usage</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">ComputerBuilder</span>
</span><span class="line">  <span class="kp">attr_reader</span> <span class="ss">:computer</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class="line">    <span class="vi">@computer</span> <span class="o">=</span> <span class="no">Computer</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">turbo</span><span class="p">(</span><span class="n">has_turbo_cpu</span><span class="o">=</span><span class="kp">true</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@computer</span><span class="o">.</span><span class="n">motherboard</span><span class="o">.</span><span class="n">cpu</span> <span class="o">=</span> <span class="no">TurboCPU</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">display=</span><span class="p">(</span><span class="nb">display</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@computer</span><span class="o">.</span><span class="n">display</span><span class="o">=</span><span class="nb">display</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">memory_size=</span><span class="p">(</span><span class="n">size_in_mb</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@computer</span><span class="o">.</span><span class="n">motherboard</span><span class="o">.</span><span class="n">memory_size</span> <span class="o">=</span> <span class="n">size_in_mb</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_cd</span><span class="p">(</span><span class="n">writer</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@computer</span><span class="o">.</span><span class="n">drives</span> <span class="o">&lt;&lt;</span> <span class="no">Drive</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:cd</span><span class="p">,</span> <span class="mi">760</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_dvd</span><span class="p">(</span><span class="n">writer</span><span class="o">=</span><span class="kp">false</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@computer</span><span class="o">.</span><span class="n">drives</span> <span class="o">&lt;&lt;</span> <span class="no">Drive</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:dvd</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="n">writer</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">add_hard_disk</span><span class="p">(</span><span class="n">size_in_mb</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@computer</span><span class="o">.</span><span class="n">drives</span> <span class="o">&lt;&lt;</span> <span class="no">Drive</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:hard_disk</span><span class="p">,</span> <span class="n">size_in_mb</span><span class="p">,</span> <span class="kp">true</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">builder</span> <span class="o">=</span> <span class="no">ComputerBuilder</span><span class="o">.</span><span class="n">new</span>
</span><span class="line"><span class="n">builder</span><span class="o">.</span><span class="n">turbo</span>
</span><span class="line"><span class="n">builder</span><span class="o">.</span><span class="n">add_cd</span><span class="p">(</span><span class="kp">true</span><span class="p">)</span>
</span><span class="line"><span class="n">builder</span><span class="o">.</span><span class="n">add_dvd</span>
</span><span class="line"><span class="n">builder</span><span class="o">.</span><span class="n">add_hard_disk</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
</span><span class="line">
</span><span class="line"><span class="n">computer</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">computer</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="builders-can-ensure-sane-objects">Builders Can Ensure Sane Objects</h3>

<p>That final “give me my object” method makes an ideal place to check that the configuration requested by the client really makes sense and that it adheres to the appropriate business rules.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">def</span> <span class="nf">computer</span>
</span><span class="line">  <span class="k">raise</span> <span class="s2">&quot;Not enough memory&quot;</span> <span class="k">if</span> <span class="vi">@computer</span><span class="o">.</span><span class="n">motherboard</span><span class="o">.</span><span class="n">memory_size</span> <span class="o">&lt;</span> <span class="mi">250</span>
</span><span class="line">  <span class="k">raise</span> <span class="s2">&quot;Too many drives&quot;</span> <span class="k">if</span> <span class="vi">@computer</span><span class="o">.</span><span class="n">drives</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">4</span>
</span><span class="line">  <span class="n">hard_disk</span> <span class="o">=</span> <span class="vi">@computer</span><span class="o">.</span><span class="n">drives</span><span class="o">.</span><span class="n">find</span> <span class="p">{</span><span class="o">|</span><span class="n">drive</span><span class="o">|</span> <span class="n">drive</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="ss">:hard_disk</span><span class="p">}</span>
</span><span class="line">  <span class="k">raise</span> <span class="s2">&quot;No hard disk.&quot;</span> <span class="k">unless</span> <span class="n">hard_disk</span>
</span><span class="line">  <span class="vi">@computer</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="resuable-buidlers">Resuable Buidlers</h3>

<p>An important issue to consider when writing and using builders is whether you can use a single builder instance to create multiple objects.</p>

<p>One way to deal with this issue is to equip your builder with a <code>reset</code> method, which reinitializes the object under construction.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">LaptopBuilder</span>
</span><span class="line">  <span class="c1"># Lots of code omitted...</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">reset</span>
</span><span class="line">    <span class="vi">@computer</span> <span class="o">=</span> <span class="no">LaptopComputer</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>The reset method will let you reuse the builder instance, but it also means that you have to start the configuration process all over again for each computer. If you want to perform the configuration once and then have the builder produce any number of objects based on that configuration, you need to store all of the configuration information in instance attributes and create the actual product only when the client asks for it.</p>

<h3 id="better-builders-with-magic-methods">Better Builders with Magic Methods</h3>

<p>Use ghost method <code>method_missing</code>.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span>
</span><span class="line">  <span class="n">words</span> <span class="o">=</span> <span class="nb">name</span><span class="o">.</span><span class="n">to_s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
</span><span class="line">  <span class="k">return</span> <span class="k">super</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="k">unless</span> <span class="n">words</span><span class="o">.</span><span class="n">shift</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span>
</span><span class="line">  <span class="n">words</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">word</span><span class="o">|</span>
</span><span class="line">    <span class="k">next</span> <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span>
</span><span class="line">    <span class="n">add_cd</span> <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s1">&#39;cd&#39;</span>
</span><span class="line">    <span class="n">add_dvd</span> <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s1">&#39;dvd&#39;</span>
</span><span class="line">    <span class="n">add_hard_disk</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span> <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s1">&#39;harddisk&#39;</span>
</span><span class="line">    <span class="n">turbo</span> <span class="k">if</span> <span class="n">word</span> <span class="o">==</span> <span class="s1">&#39;turbo&#39;</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">builder</span><span class="o">.</span><span class="n">add_dvd_and_harddisk</span>
</span><span class="line"><span class="n">builder</span><span class="o">.</span><span class="n">add_turbo_and_dvd_and_harddisk</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<h3 id="using-and-abusing-11">Using and Abusing</h3>

<p>It is usually fairly easy to spot code that is missing a builder: You can find the same object creation logic scattered all over the place. Another hint that you need a builder is when your code starts producing invalid objects.</p>

<p>Builder pattern sometimes creeps up on you as your application becomes increasingly complex.</p>

<h3 id="in-the-wild-11">In the Wild</h3>

<h2 id="interpreter">Interpreter</h2>

<h3 id="description-11">Description</h3>

<p>Interpreter pattern, which suggests that sometimes the best way to solve a problem is to invent a new language for just that purpose.</p>

<p><img src="https://github.com/ifyouseewendy/ifyouseewendy.github.io/raw/source/image-repo/interpreter.png" alt="Interpreter" /></p>

<p>The heart of the Interpreter pattern is the abstract syntax tree.</p>

<p>The GoF called such values or conditions supplied at the time the AST is interpreted the <code>context</code>.</p>

<ol>
  <li>The parser reads in the program text and produces a data structure, called an abstract syntax tree (AST).</li>
  <li>The AST is evaluated against some set of external conditions, or context, to produce the desired computation.</li>
</ol>

<blockquote>
  <p>ASTs are, in fact, specialized examples of the Composite pattern, with the nonterminal expressions playing the parts of the composites.</p>
</blockquote>

<p>You can supply your clients with an API for building up the tree in code, or you can write a parser that takes strings and turns them into the AST.</p>

<h3 id="with-a-parser">With a Parser</h3>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">class</span> <span class="nc">Parser</span>
</span><span class="line">  <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span><span class="line">    <span class="vi">@tokens</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="sr">/\(|\)|[\w\.\*]+/</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">next_token</span>
</span><span class="line">    <span class="vi">@tokens</span><span class="o">.</span><span class="n">shift</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="k">def</span> <span class="nf">expression</span>
</span><span class="line">    <span class="n">token</span> <span class="o">=</span> <span class="n">next_token</span>
</span><span class="line">    <span class="k">if</span> <span class="n">token</span> <span class="o">==</span> <span class="kp">nil</span>
</span><span class="line">      <span class="k">return</span> <span class="kp">nil</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;(&#39;</span>
</span><span class="line">      <span class="n">result</span> <span class="o">=</span> <span class="n">expression</span>
</span><span class="line">      <span class="k">raise</span> <span class="s1">&#39;Expected )&#39;</span> <span class="k">unless</span> <span class="n">next_token</span> <span class="o">==</span> <span class="s1">&#39;)&#39;</span>
</span><span class="line">      <span class="n">result</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">All</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;writable&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">Writable</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;bigger&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">Bigger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">next_token</span><span class="o">.</span><span class="n">to_i</span><span class="p">)</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;filename&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">FileName</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">next_token</span><span class="p">)</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;not&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">Not</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;and&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">And</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
</span><span class="line">    <span class="k">elsif</span> <span class="n">token</span> <span class="o">==</span> <span class="s1">&#39;or&#39;</span>
</span><span class="line">      <span class="k">return</span> <span class="no">Or</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">expression</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>
</span><span class="line">    <span class="k">else</span>
</span><span class="line">      <span class="k">raise</span> <span class="s2">&quot;Unexpected token: </span><span class="si">#{</span><span class="n">token</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class="line">    <span class="k">end</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line"><span class="k">end</span>
</span><span class="line">
</span><span class="line"><span class="n">parser</span> <span class="o">=</span> <span class="no">Parser</span><span class="o">.</span><span class="n">new</span> <span class="s2">&quot;and (and(bigger 1024)(filename *.mp3)) writable&quot;</span>
</span><span class="line"><span class="n">ast</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">expression</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p><strong>Let XML or YAML Do The Parsing</strong></p>

<p>Keep in mind that the main motivation behind building an interpreter is to give your users a natural way to express the kind of processing that needs to be done.</p>

<p><strong>Racc</strong></p>

<p>Racc is modeled (and named) after the venerable UNIX YACC utility. Racc takes as input a description of the grammar for your language and spits out a parser, written in Ruby for that language.</p>

<h3 id="without-a-parser">Without a Parser</h3>

<p>Internal Domain-Specifc Languages.</p>

<p>You may implement your Interpreter pattern in such a way that users could write their pro-grams in actual Ruby code. Maybe you could design your AST API in such a way that the code flows so naturally that your users might be unaware that they are, in fact, writing Ruby code.</p>

<h3 id="using-and-abusing-12">Using and Abusing</h3>

<ul>
  <li>The complexity issue. (The sheer number of components is why the Interpreter pattern is in practice limited to relatively simple languages.)</li>
  <li>Program efficiency, it is probably best to limit your use of the Interpreter pattern to areas that do not demand high performance.</li>
</ul>

<h3 id="in-the-wild-12">In the Wild</h3>

<p><strong>SQL</strong></p>

<p><strong>HTML</strong></p>

<p><strong>Ruby</strong>, of course, an interpreted language.</p>

<p><strong>regular expression</strong></p>

<h2 id="domain-specific-languages">Domain-Specific Languages</h2>

<h3 id="description-12">Description</h3>

<p>The DSL pattern suggests that you should focus on the language itself, not on the interpreter.</p>

<p>External DSLs are external in the sense that there is a parser and an interpreter for the DSL, and there are the programs written in the DSL.</p>

<p>An internal DSL, according to Fowler, is one in which we start with some implementation language, perhaps Ruby, and we simply bend that one language into being our DSL.</p>

<h3 id="using-and-abusing-13">Using and Abusing</h3>

<ol>
  <li>You are limited to what you can parse with a Ruby-based internal DSL.</li>
  <li>Error messages.</li>
</ol>

<h3 id="in-the-wild-13">In the Wild</h3>

<p>The most prominent example of a pure internal DSL in the Ruby world is probably rake, Ruby’s answer to ant or make.</p>

<p><strong>rake</strong>, Ruby’s answer to ant or make.</p>

<h2 id="custom-objects">Custom Objects</h2>

<p>Meta-programming certainly takes a different tack in producing the right object, at its heart this pattern focuses on leveraging the flexibility of Ruby.</p>

<ul>
  <li>We can start with a simple object and add individual methods or even whole modules full of methods to it.</li>
  <li>Using <code>class_eval</code>, we can generate completely new methods at runtime.</li>
  <li>We can take advantage of Ruby’s reflection facilities, which allow a program to examine its own structure</li>
</ul>

<p>A note:</p>

<blockquote>
  <p>The <code>attr_accessor</code> method and its friends live in the module <code>Module</code>, which is included by the <code>Object</code> class. If you go looking for the Ruby code for <code>attr_accessor</code>, <code>attr_reader</code>, and <code>attr_writer</code>, however, you are destined to be disappointed. For the sake of efficiency—but purely for efficiency—these methods are written in C.</p>
</blockquote>

<h3 id="custom-tailoring-technique">Custom-Tailoring Technique</h3>

<p>This custom-tailoring technique is particularly useful when you have lots of orthogonal features that you need to assemble into a single object.</p>

<p>Of course, there really is no rule that says you need to start your customizations with a plain-vanilla instance of Object. In real life, you will likely want to start with an instance of a class that provides some base level of functionality and then tweak the methods from there.</p>

<div class="bogus-wrapper"><notextile><figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</pre></td><td class="code"><pre><code class="ruby"><span class="line"><span></span><span class="k">def</span> <span class="nf">new_animal</span><span class="p">(</span><span class="n">diet</span><span class="p">,</span> <span class="n">awake</span><span class="p">)</span>
</span><span class="line">  <span class="n">animal</span> <span class="o">=</span> <span class="no">Object</span><span class="o">.</span><span class="n">new</span>
</span><span class="line">  <span class="k">if</span> <span class="n">diet</span> <span class="o">==</span> <span class="ss">:meat</span>
</span><span class="line">    <span class="n">animal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Carnivore</span><span class="p">)</span>
</span><span class="line">  <span class="k">else</span>
</span><span class="line">    <span class="n">animal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">Herbivore</span><span class="p">)</span>
</span><span class="line">  <span class="k">end</span>
</span><span class="line">
</span><span class="line">  <span class="o">...</span>
</span><span class="line"><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure></notextile></div>

<p>No matter whether you tailor your objects one method at a time or in module-sized chunks, the ultimate effect is to create a customized object, uniquely made to order for the requirements of the moment.</p>

<h3 id="reflections">Reflections</h3>

<blockquote>
  <p>If you are meta-programming new functionality into your classes on the fly, how can you tell what any given instance can do?</p>
</blockquote>

<p>Reflection features like <code>public_methods</code> and <code>respond_to?</code> are handy anytime but become real assets as you dive deeper and deeper into meta-programming, when what your objects can do depends more on their history than on their class.</p>

<h3 id="using-and-abusing-14">Using and Abusing</h3>

<p>Tests are absolutely mandatory for systems that use a lot of meta-programming.</p>

<h2 id="convention-over-configuration">Convention Over Configuration</h2>

<blockquote>
  <p>The common message is that you should not just take your language as you find it, but rather mold it into something closer to the tool that you need to solve the problem at hand.</p>
</blockquote>

<h3 id="description-13">Description</h3>

<p>The Convention Over Configuration pattern suggests that you define a convention that a sensible engineer might use anyway.</p>

<ul>
  <li>
    <p>Try to deduce how your users will behave.</p>
  </li>
  <li>
    <p>You can give your user a kick start by supplying him or her with a model, a template, or an example to follow. You could also supply a utility to generate the outline or <strong>scaffold</strong> of a class. It is easy to discount the value of this scaffold-generating script.</p>
  </li>
</ul>

<h3 id="using-and-abusing-15">Using and Abusing</h3>

<p>One danger in building convention-based systems is that your convention might be incomplete, thereby limiting the range of things that your system can do.</p>

<blockquote>
  <p>Our message gateway, for example, does not really do a thorough job of transforming host names into Ruby class names. The code in this chapter will work fine with a simple host name like <em>russolsen.com</em>, transforming it into <em>RussOlsenDotCom</em>. But feed our current system something like <em>icl-gis.co</em>m and it will go looking for the very illegal <em>Icl-gisDotComAuthorizer</em> class.</p>
</blockquote>

<p>Another potential source of trouble is the possibility that a system that uses a lot of conventions may seem like it is operating by magic to the new user. Configuration files may be a pain in the neck to write and maintain, but they do provide a sort of road map—perhaps a very complicated and hard-to-interpret road map, but a map nevertheless—to the inner workings of the system. A well-done convention-based system, by contrast, needs to supply its operational road map in the form of (gasp!) <strong>documentation</strong>.</p>

<p>Also keep in mind that as the convention magic becomes deeper and more complex, you will need ever more thorough unit tests to ensure that your conventions behave, well, conventionally.</p>

<h2 id="reference">Reference</h2>

<ul>
  <li><a href="https://github.com/nslocum/design-patterns-in-ruby">Examples from the book Design Patterns</a> by <a href="https://github.com/nslocum">Nick Slocum</a></li>
</ul>
</section>



	
	  <section class="comments">
	    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
	  </section>
	
</article>
</div>

    </div>
  </div>
  <footer class="main-footer">
	<section class="interior-footer">
    <span class="credit">Powered by <a href="http://octopress.org">Octopress</a>, and theme <a href='https://github.com/alexharris/calm-shallow-sea'>calm-shallow-sea</a>.</span>
	</section>
</footer>


  


<script type="text/javascript">
      var disqus_shortname = 'ifyouseewendy';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://blog.ifyouseewendy.com/blog/2014/10/17/design-patterns-in-ruby/';
        var disqus_url = 'http://blog.ifyouseewendy.com/blog/2014/10/17/design-patterns-in-ruby/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>




</body>
</html>
